<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Coinluxora User Dashboard</title> 

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 

<style>
body{margin:0;font-family:system-ui;background:#020617;color:#e5e7eb;padding:16px;padding-bottom:92px}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid #1e293b;margin-bottom:14px}
button{border:none;padding:10px 14px;border-radius:10px;font-weight:900;cursor:pointer;background:#38bdf8;color:#020617}
.menuBtn{background:#0b1224;color:#e5e7eb;border:1px solid #1e293b} 

.box{border:1px solid #1e293b;border-radius:12px;padding:14px;background:#020617;margin-bottom:14px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.card{border:1px solid #1e293b;border-radius:12px;padding:10px}
h2{margin:0;font-size:18px}
.small{color:#94a3b8;font-size:12px;margin-top:6px}
.ok{color:#22c55e}
.err{color:#f87171}
input,select{width:100%;padding:12px;margin-bottom:10px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb} 

a{color:#38bdf8;text-decoration:none;font-weight:1000}
a:hover{text-decoration:underline} 

.pill{padding:6px 10px;border-radius:999px;font-weight:1000;font-size:12px;display:inline-block}
.pending{background:#facc15;color:#020617}
.active{background:#38bdf8;color:#020617}
.completed{background:#22c55e;color:#020617}
.rejected{background:#f87171;color:#020617} 

/* SIDEBAR */
.overlay{
Â  position:fixed; inset:0;
Â  background:rgba(0,0,0,.65);
Â  display:none; z-index:999;
Â  backdrop-filter: blur(4px);
}
.sidebar{
Â  position:fixed; top:0; left:-290px;
Â  width:270px; height:100vh;
Â  background:#020617;
Â  border-right:1px solid #1e293b;
Â  padding:16px;
Â  transition:.28s ease;
Â  z-index:1000;
Â  box-shadow:0 20px 80px rgba(0,0,0,.6);
}
.sidebar.open{ left:0; }
.overlay.show{ display:block; } 

.brandRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.brand{font-weight:1000;font-size:18px;letter-spacing:.6px;}
.closeBtn{background:#0b1224;border:1px solid #1e293b;color:#e5e7eb;border-radius:10px;padding:8px 12px;}
.userTag{padding:10px;border-radius:12px;border:1px solid #1e293b;background:#0b1224;margin-bottom:12px;}
.sideItem{
Â  display:flex;gap:10px;align-items:center;
Â  padding:12px;border:1px solid #1e293b;border-radius:12px;margin-bottom:10px;
Â  color:#e5e7eb;background:#0b1224;
}
.sideItem:hover{background:#0f1a33}
.activeLink{border:1px solid #38bdf8;background:rgba(56,189,248,0.12);}
.sideLogout{background:#f87171;color:#020617;border:none;width:100%;padding:12px;border-radius:12px;font-weight:1000} 

/* BOTTOM NAV */
.bottomNav{
Â  position:fixed;left:0;right:0;bottom:0;
Â  height:74px;background:#020617;
Â  border-top:1px solid #1e293b;
Â  display:flex;justify-content:space-around;align-items:center;
Â  z-index:1200;padding:6px 10px;
}
.navItem{
Â  flex:1;display:flex;flex-direction:column;
Â  align-items:center;justify-content:center;
Â  color:#94a3b8;font-size:12px;font-weight:1000;
Â  padding:10px 0;border-radius:14px;cursor:pointer;
Â  position:relative;
}
.navItem span{font-size:18px;margin-bottom:4px}
.navActive{color:#38bdf8;background:rgba(56,189,248,0.10)} 

/* BADGE */
.badge{
Â  position:absolute;
Â  top:6px;
Â  right:22%;
Â  min-width:18px;
Â  height:18px;
Â  padding:0 6px;
Â  border-radius:999px;
Â  background:#f87171;
Â  color:#020617;
Â  font-weight:1000;
Â  font-size:11px;
Â  display:none;
Â  align-items:center;
Â  justify-content:center;
}
</style>
</head> 

<body> 

<!-- OVERLAY + SIDEBAR -->
<div id="overlay" class="overlay" onclick="closeMenu()"></div> 

<div id="sidebar" class="sidebar">
Â  <div class="brandRow">
Â Â Â  <div class="brand">COINLUXORA</div>
Â Â Â  <button class="closeBtn" onclick="closeMenu()">âœ•</button>
Â  </div> 

Â  <div class="userTag">
Â Â Â  <div class="small">Logged in as</div>
Â Â Â  <div id="sideEmail" style="font-weight:1000;margin-top:6px;">---</div>
Â  </div> 

Â  <a class="sideItem activeLink" href="user-dashboard.html">ğŸ  Dashboard</a>
Â  <a class="sideItem" href="portfolio.html">ğŸ“Š Portfolio</a>
Â  <a class="sideItem" href="plans.html">ğŸ’¼ Investment Plans</a>
Â  <a class="sideItem" href="support.html">ğŸ§‘â€ğŸ’» Support / Contact</a> 

Â  <!-- âœ… FIXED: Deposit link now points to deposits.html -->
Â  <a class="sideItem" href="deposits.html">ğŸ’³ Deposit</a> 

Â  <a class="sideItem" href="withdraw.html">â¡ Withdraw Funds</a> 

Â  <div style="height:12px"></div>
Â  <button class="sideLogout" onclick="logout()">Logout</button>
</div> 

<header>
Â  <button class="menuBtn" onclick="openMenu()">â˜°</button>
Â  <strong>User Dashboard</strong>
Â  <button onclick="logout()">Logout</button>
</header> 

<div class="box">
Â  <h2>Welcome</h2>
Â  <div id="email" class="small">Loadingâ€¦</div>
</div> 

<div class="box">
Â  <h2>Balance</h2>
Â  <div id="balance" style="font-size:26px;font-weight:1000;margin-top:8px;">--</div>
Â  <div class="small">Your trading account balance</div>
</div> 

<div class="box">
Â  <h2>Active Investment Plan</h2>
Â  <div id="planMsg" class="small">Loadingâ€¦</div>
Â  <div id="planBox"></div>
</div> 

<div class="box">
Â  <h2>Live Crypto Prices</h2>
Â  <div class="grid" id="prices"><div class="card">Loadingâ€¦</div></div>
</div> 

<!-- BOTTOM NAV -->
<div class="bottomNav">
Â  <div class="navItem navActive" onclick="goHome()"><span>ğŸ </span>Home</div> 

Â  <!-- âœ… FIXED: deposit now points to deposits.html -->
Â  <div class="navItem" onclick="goDepositAndClear()">
Â Â Â  <div id="badgeDeposit" class="badge">0</div>
Â Â Â  <span>ğŸ’³</span>Deposit
Â  </div> 

Â  <div class="navItem" onclick="goWithdrawAndClear()">
Â Â Â  <div id="badgeWithdraw" class="badge">0</div>
Â Â Â  <span>â¡</span>Withdraw
Â  </div> 

Â  <div class="navItem" onclick="goPlans()"><span>ğŸ’¼</span>Plans</div> 

Â  <div class="navItem" onclick="goSupportAndClear()">
Â Â Â  <div id="badgeSupport" class="badge">0</div>
Â Â Â  <span>ğŸ§‘â€ğŸ’»</span>Support
Â  </div>
</div> 

<script>
const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4"; 

const EDGE_CLEAR_BADGE_URL = `${SUPABASE_URL}/functions/v1/clear_badge`; 

const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY); 

let currentUserEmail="";
let currentUserId="";
let badgeChannel=null; 

init(); 

/* NAV */
function goHome(){ window.scrollTo({top:0,behavior:"smooth"}); }
function goPlans(){ window.location.href="plans.html"; } 

/* âœ… FIXED */
function goDepositAndClear(){ clearBadge("deposits"); window.location.href="deposits.html"; } 

function goWithdrawAndClear(){ clearBadge("withdrawals"); window.location.href="withdraw.html"; }
function goSupportAndClear(){ clearBadge("notifications"); window.location.href="support.html"; } 

function openMenu(){
Â  document.getElementById("sidebar").classList.add("open");
Â  document.getElementById("overlay").classList.add("show");
}
function closeMenu(){
Â  document.getElementById("sidebar").classList.remove("open");
Â  document.getElementById("overlay").classList.remove("show");
} 

function setBadge(id, count){
Â  const el=document.getElementById(id);
Â  if(!el) return;
Â  const n=Number(count||0);
Â  if(n<=0){
Â Â Â  el.style.display="none";
Â  }else{
Â Â Â  el.style.display="flex";
Â Â Â  el.innerText = n > 99 ? "99+" : String(n);
Â  }
} 

function setBadgeFromKey(badge_key, badge_value){
Â  if(badge_key === "deposits"){
Â Â Â  setBadge("badgeDeposit", badge_value);
Â  } else if(badge_key === "withdrawals"){
Â Â Â  setBadge("badgeWithdraw", badge_value);
Â  } else if(badge_key === "notifications"){
Â Â Â  setBadge("badgeSupport", badge_value);
Â  }
} 

async function loadRealtimeBadgesOnce(){
Â  if(!currentUserId) return; 

Â  setBadge("badgeDeposit", 0);
Â  setBadge("badgeWithdraw", 0);
Â  setBadge("badgeSupport", 0); 

Â  const { data, error } = await supabaseClient
Â Â Â  .from("user_badges")
Â Â Â  .select("badge_key, badge_value")
Â Â Â  .eq("user_id", currentUserId); 

Â  if(error){
Â Â Â  console.log("Badge load error:", error.message);
Â Â Â  return;
Â  } 

Â  (data || []).forEach(row => setBadgeFromKey(row.badge_key, row.badge_value));
} 

function subscribeToRealtimeBadges(){
Â  if(!currentUserId) return; 

Â  if(badgeChannel){
Â Â Â  supabaseClient.removeChannel(badgeChannel);
Â Â Â  badgeChannel=null;
Â  } 

Â  badgeChannel = supabaseClient
Â Â Â  .channel("realtime-user-badges-dashboard")
Â Â Â  .on("postgres_changes", {
Â Â Â Â Â  event: "*",
Â Â Â Â Â  schema: "public",
Â Â Â Â Â  table: "user_badges",
Â Â Â Â Â  filter: `user_id=eq.${currentUserId}`
Â Â Â  }, payload => {
Â Â Â Â Â  const row = payload.new;
Â Â Â Â Â  if(!row) return;
Â Â Â Â Â  setBadgeFromKey(row.badge_key, row.badge_value);
Â Â Â  })
Â Â Â  .subscribe(status => console.log("Badge realtime status:", status));
} 

async function clearBadge(badge_key){
Â  try{
Â Â Â  const { data: sessionData } = await supabaseClient.auth.getSession();
Â Â Â  const accessToken = sessionData?.session?.access_token;
Â Â Â  if(!accessToken) return; 

Â Â Â  await fetch(EDGE_CLEAR_BADGE_URL, {
Â Â Â Â Â  method: "POST",
Â Â Â Â Â  headers: {
Â Â Â Â Â Â Â  "Content-Type": "application/json",
Â Â Â Â Â Â Â  "Authorization": `Bearer ${accessToken}`,
Â Â Â Â Â Â Â  "apikey": SUPABASE_ANON_KEY
Â Â Â Â Â  },
Â Â Â Â Â  body: JSON.stringify({ badge_key })
Â Â Â  });
Â  }catch(e){
Â Â Â  console.log("clearBadge error:", e);
Â  }
} 

async function init(){
Â  const { data:userData } = await supabaseClient.auth.getUser();
Â  if(!userData.user){
Â Â Â  document.body.innerHTML="<h2 style='color:white'>You must login first.</h2>";
Â Â Â  return;
Â  } 

Â  currentUserEmail=userData.user.email;
Â  currentUserId=userData.user.id; 

Â  document.getElementById("email").innerHTML=`Logged in as: <span class="ok">${currentUserEmail}</span>`;
Â  document.getElementById("sideEmail").innerText=currentUserEmail; 

Â  await loadBalance();
Â  await loadActivePlan();
Â  fetchPrices(); 

Â  await loadRealtimeBadgesOnce();
Â  subscribeToRealtimeBadges();
} 

async function loadBalance(){
Â  const { data } = await supabaseClient.from("users").select("*").eq("email", currentUserEmail).single();
Â  document.getElementById("balance").innerHTML = Number(data?.balance || 0).toFixed(2);
} 

function money(n){ return "$" + Number(n||0).toFixed(2); }
function pill(status){
Â  const s=(status||"pending").toLowerCase();
Â  return `<span class="pill ${s}">${s}</span>`;
}
function daysBetween(date1, date2){
Â  const d1=new Date(date1);
Â  const d2=new Date(date2);
Â  const diff=(d2 - d1) / (1000*60*60*24);
Â  return Math.max(0, Math.ceil(diff));
} 

async function loadActivePlan(){
Â  const planMsg=document.getElementById("planMsg");
Â  const planBox=document.getElementById("planBox"); 

Â  const { data, error } = await supabaseClient
Â Â Â  .from("investment_plans")
Â Â Â  .select("*")
Â Â Â  .eq("user_email", currentUserEmail)
Â Â Â  .order("created_at",{ascending:false})
Â Â Â  .limit(1); 

Â  if(error){
Â Â Â  planMsg.innerHTML="<span class='err'>"+error.message+"</span>";
Â Â Â  planBox.innerHTML="";
Â Â Â  return;
Â  } 

Â  if(!data || data.length===0){
Â Â Â  planMsg.innerHTML="<span class='err'>No investment plan started yet.</span>";
Â Â Â  planBox.innerHTML=`<div class="small">Go to <a href="plans.html">Investment Plans</a> to start.</div>`;
Â Â Â  return;
Â  } 

Â  const plan=data[0];
Â  const amount=Number(plan.amount||0);
Â  const roi=Number(plan.roi_percent||0);
Â  const expected=amount+(amount*(roi/100)); 

Â  let daysLeft="--";
Â  if(plan.duration_days && plan.created_at){
Â Â Â  const start=new Date(plan.created_at);
Â Â Â  const end=new Date(start);
Â Â Â  end.setDate(end.getDate()+Number(plan.duration_days||0));
Â Â Â  daysLeft = daysBetween(new Date(), end);
Â  } 

Â  planMsg.innerHTML="<span class='ok'>Plan details loaded âœ…</span>";
Â  planBox.innerHTML=`
Â Â Â  <div class="card">
Â Â Â Â Â  <strong>${plan.plan_name} Plan</strong> ${pill(plan.status)}
Â Â Â Â Â  <div class="small" style="margin-top:10px">Amount: <strong>${money(amount)}</strong></div>
Â Â Â Â Â  <div class="small">ROI: <strong>${roi}%</strong></div>
Â Â Â Â Â  <div class="small">Duration: <strong>${plan.duration_days} days</strong></div>
Â Â Â Â Â  <div class="small">Expected Return: <strong>${money(expected)}</strong></div>
Â Â Â Â Â  <div class="small">Days remaining: <strong>${daysLeft}</strong></div>
Â Â Â Â Â  ${plan.admin_note ? `<div class="small">Admin note: <strong>${plan.admin_note}</strong></div>` : ""}
Â Â Â  </div>
Â  `;
} 

async function fetchPrices(){
Â  try{
Â Â Â  const res=await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,tether&vs_currencies=usd");
Â Â Â  const data=await res.json();
Â Â Â  document.getElementById("prices").innerHTML=`
Â Â Â Â Â  <div class="card"><strong>BTC</strong><br>$${data.bitcoin.usd}</div>
Â Â Â Â Â  <div class="card"><strong>ETH</strong><br>$${data.ethereum.usd}</div>
Â Â Â Â Â  <div class="card"><strong>USDT</strong><br>$${data.tether.usd}</div>
Â Â Â  `;
Â  }catch{
Â Â Â  document.getElementById("prices").innerHTML="<div class='card err'>Failed to load prices</div>";
Â  }
} 

async function logout(){
Â  await supabaseClient.auth.signOut();
Â  window.location.href="login.html";
}
</script> 

</body>
      </html>
