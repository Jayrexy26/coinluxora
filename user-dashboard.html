<script>
// ================================================
//   SUPER HARDENED SUPABASE AUTH GUARD – BYPASS FREEZE
// ================================================

const SUPABASE_URL   = "https://YOUR_PROJECT_ID.supabase.co";           // ← CHANGE THIS
const SUPABASE_ANON  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";      // ← CHANGE THIS (anon key!)

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
  auth: {
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: false,
    storageKey: `sb-${new URL(SUPABASE_URL).hostname.split('.')[0]}-auth-token` // default storage key pattern
  }
});

const LOADING_TIMEOUT_MS = 8000; // shorter now since we bypass

(async function authGuard() {
  const gate = document.getElementById("authGate");
  const gateTxt = document.querySelector(".gateTxt");
  const gateSub = document.querySelector(".gateSub");

  const timeoutId = setTimeout(() => {
    if (gateTxt) gateTxt.textContent = "Session check timed out";
    if (gateSub) gateSub.textContent = "Try refreshing or check your connection";
    setTimeout(() => location.replace("/login.html"), 2200);
  }, LOADING_TIMEOUT_MS);

  try {
    // ── STEP 1: FAST PATH – read session directly from localStorage (avoids client freeze)
    let session = null;
    const storageKey = `sb-${new URL(SUPABASE_URL).hostname.split('.')[0]}-auth-token`;
    const stored = localStorage.getItem(storageKey);
    if (stored) {
      try {
        const parsed = JSON.parse(stored);
        if (parsed?.access_token && parsed?.refresh_token) {
          session = {
            access_token: parsed.access_token,
            refresh_token: parsed.refresh_token,
            user: parsed.user,
            expires_at: parsed.expires_at || Math.floor(Date.now() / 1000) + 3600
          };
        }
      } catch (e) {}
    }

    // If no valid local session → redirect immediately
    if (!session?.access_token) {
      clearTimeout(timeoutId);
      location.replace("/login.html");
      return;
    }

    // ── STEP 2: Use client ONLY to validate/refresh (with short timeout)
    const controller = new AbortController();
    const abortTimer = setTimeout(() => controller.abort(), 5000);

    try {
      const { data: { user }, error } = await Promise.race([
        supabase.auth.getUser(),
        new Promise((_, reject) => setTimeout(() => reject(new Error("getUser timeout")), 6000))
      ]);
      clearTimeout(abortTimer);

      if (error || !user || !user.email_confirmed_at) {
        clearTimeout(timeoutId);
        location.replace(user?.email_confirmed_at ? "/login.html" : "/verify-email.html");
        return;
      }

      // Success!
      clearTimeout(timeoutId);
      gate.style.display = "none";
      setTimeout(() => initDashboard(user), 150);

    } catch (err) {
      // If getUser hangs or fails → treat as no valid session
      console.warn("getUser failed (likely freeze) → fallback to login", err);
      clearTimeout(timeoutId);
      location.replace("/login.html");
    }

  } catch (err) {
    console.error("Auth guard error:", err);
    clearTimeout(timeoutId);
    if (gateTxt) gateTxt.textContent = "Auth error – please refresh";
    setTimeout(() => location.replace("/login.html"), 2500);
  }
})();
</script>
