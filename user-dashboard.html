<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Deposit - Coinluxora</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#020617;color:#e5e7eb;padding:16px;padding-bottom:32px}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid #1e293b;margin-bottom:14px}
button{border:none;padding:10px 14px;border-radius:10px;font-weight:900;cursor:pointer;background:#38bdf8;color:#020617}
.box{border:1px solid #1e293b;border-radius:12px;padding:14px;background:#020617;margin-bottom:14px}
.card{border:1px solid #1e293b;border-radius:12px;padding:10px;background:#0b1224}
.small{color:#94a3b8;font-size:12px;margin-top:6px}
.ok{color:#22c55e}
.err{color:#f87171}
input,select{width:100%;padding:12px;margin-bottom:10px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb}
a{color:#38bdf8;text-decoration:none;font-weight:1000}
a:hover{text-decoration:underline}

/* history */
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.tab{padding:7px 12px;border-radius:999px;background:rgba(255,255,255,.08);cursor:pointer;font-weight:1000;font-size:12px}
.tab.active{background:rgba(56,189,248,0.15);border:1px solid rgba(56,189,248,0.4)}
.searchBar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.searchBar input{flex:1;min-width:210px}
.miniBtn{background:#0b1224;color:#e5e7eb;border:1px solid #1e293b}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.1);font-size:13px}
th{opacity:.8;text-align:left}
.pill{padding:6px 10px;border-radius:999px;font-weight:1000;font-size:12px;display:inline-block}
.pending{background:#facc15;color:#020617}
.approved{background:#22c55e;color:#020617}
.rejected{background:#f87171;color:#020617}

/* modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:999}
.modalBox{width:95%;max-width:560px;background:#0b1224;border-radius:16px;padding:16px;border:1px solid #1e293b}
.modalRow{margin-bottom:10px;font-size:14px}
.modalRow span{opacity:.7}
.closeBtn{margin-top:10px;width:100%;background:#1f2937;color:#fff}
</style>
</head>

<body>

<header>
  <button class="miniBtn" onclick="window.location.href='user-dashboard.html'">← Back</button>
  <strong>Deposit</strong>
  <button class="miniBtn" onclick="logout()">Logout</button>
</header>

<div class="box">
  <h2 style="margin:0">Submit Deposit Proof</h2>
  <div class="small">After depositing, submit confirmation</div>

  <select id="confAsset">
    <option value="btc">BTC</option>
    <option value="eth">ETH</option>
    <option value="usdt">USDT</option>
  </select>

  <select id="confNetwork">
    <option value="BTC">BTC</option>
    <option value="ERC20">ERC20</option>
    <option value="TRC20">TRC20</option>
  </select>

  <input id="confAmount" type="number" step="0.01" placeholder="Amount deposited"/>
  <input id="confTx" placeholder="Transaction hash"/>
  <input id="confProof" type="file" accept="image/*,.pdf"/>

  <button style="width:100%;background:#22c55e" onclick="submitDeposit()">Submit Deposit</button>
  <div id="depMsg" class="small"></div>
</div>

<div class="box">
  <h2 style="margin:0">Deposit History</h2>

  <div class="tabs" id="tabs">
    <div class="tab active" data-status="all">All</div>
    <div class="tab" data-status="pending">Pending</div>
    <div class="tab" data-status="approved">Approved</div>
    <div class="tab" data-status="rejected">Rejected</div>
  </div>

  <div class="searchBar">
    <input id="searchInput" placeholder="Search tx hash / amount / asset...">
    <button id="clearSearch" class="miniBtn">Clear</button>
    <button id="refreshBtn" class="miniBtn">Refresh</button>
  </div>

  <div id="history"></div>
  <button id="loadMore" class="miniBtn" style="display:none;margin-top:12px">Load more</button>
</div>

<!-- modal -->
<div class="modal" id="detailsModal">
  <div class="modalBox">
    <h3 style="margin-top:0">Deposit Details</h3>
    <div id="detailsBody"></div>
    <button id="downloadPdfBtn" class="miniBtn" style="width:100%;margin-top:6px">Download Receipt (PDF)</button>
    <button class="closeBtn" onclick="closeModal()">Close</button>
  </div>
</div>

<script>
const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const BUCKET_NAME="proofs";
const EDGE_SUBMIT_DEPOSIT_URL = `${SUPABASE_URL}/functions/v1/submit_deposit`;

let currentUserEmail="";
let filter="all", limit=10, offset=0, cache=[];
let searchTerm="";
let currentDetails=null;

const msg=document.getElementById("depMsg");
const historyEl=document.getElementById("history");
const loadMoreBtn=document.getElementById("loadMore");

const modal=document.getElementById("detailsModal");
const detailsBody=document.getElementById("detailsBody");
const downloadPdfBtn=document.getElementById("downloadPdfBtn");

function showMsg(t, ok=false){
  msg.innerHTML = ok ? `<span class="ok">${t}</span>` : `<span class="err">${t}</span>`;
}

function pillStatus(status){
  const s=(status||"pending").toLowerCase();
  return `<span class="pill ${s}">${s.toUpperCase()}</span>`;
}

function openModal(dep){
  currentDetails = dep;
  detailsBody.innerHTML = `
    <div class="modalRow"><span>ID:</span> ${dep.id}</div>
    <div class="modalRow"><span>Asset:</span> ${dep.asset}</div>
    <div class="modalRow"><span>Network:</span> ${dep.network}</div>
    <div class="modalRow"><span>Amount:</span> ${dep.amount}</div>
    <div class="modalRow"><span>Tx Hash:</span> ${dep.tx_hash}</div>
    <div class="modalRow"><span>Status:</span> ${pillStatus(dep.status)}</div>
    <div class="modalRow"><span>Date:</span> ${new Date(dep.created_at).toLocaleString()}</div>
    ${dep.admin_note ? `<div class="modalRow"><span>Admin Note:</span> ${dep.admin_note}</div>` : ""}
  `;
  modal.style.display="flex";
}

function closeModal(){ modal.style.display="none"; }
window.openModal=openModal;
window.closeModal=closeModal;

downloadPdfBtn.addEventListener("click", () => {
  if(!currentDetails) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("Coinluxora Deposit Receipt", 14, 18);

  doc.setFontSize(11);
  const lines = [
    `Receipt ID: ${currentDetails.id}`,
    `User: ${currentUserEmail}`,
    `Asset: ${currentDetails.asset}`,
    `Network: ${currentDetails.network}`,
    `Amount: ${currentDetails.amount}`,
    `Tx Hash: ${currentDetails.tx_hash}`,
    `Status: ${currentDetails.status}`,
    `Date: ${new Date(currentDetails.created_at).toLocaleString()}`,
    currentDetails.admin_note ? `Admin Note: ${currentDetails.admin_note}` : ""
  ].filter(Boolean);

  let y=30;
  lines.forEach(line => { doc.text(line, 14, y); y+=8; });

  doc.text("Thank you for using Coinluxora.", 14, y+10);
  doc.save(`coinluxora-deposit-${currentDetails.id}.pdf`);
});

function render(){
  let rows = cache;

  if(searchTerm.trim()){
    const t = searchTerm.toLowerCase();
    rows = rows.filter(d =>
      String(d.tx_hash||"").toLowerCase().includes(t) ||
      String(d.amount||"").toLowerCase().includes(t) ||
      String(d.asset||"").toLowerCase().includes(t) ||
      String(d.status||"").toLowerCase().includes(t)
    );
  }

  if(rows.length === 0){
    historyEl.innerHTML = "<div class='small'>No deposits found.</div>";
    return;
  }

  historyEl.innerHTML = `
    <table>
      <tr>
        <th>Asset</th><th>Amount</th><th>Status</th><th>Date</th><th>Action</th>
      </tr>
      ${rows.map(d=>`
        <tr>
          <td>${d.asset}</td>
          <td>${d.amount}</td>
          <td>${pillStatus(d.status)}</td>
          <td>${new Date(d.created_at).toLocaleString()}</td>
          <td><button class="miniBtn" onclick='openModal(${JSON.stringify(d)})'>View</button></td>
        </tr>
      `).join("")}
    </table>
  `;
}

async function loadHistory(reset=false){
  if(reset){ offset=0; cache=[]; }

  let q = supabaseClient
    .from("deposits")
    .select("id,user_email,asset,network,amount,tx_hash,status,proof_url,created_at,admin_note")
    .eq("user_email", currentUserEmail)
    .order("created_at",{ascending:false})
    .range(offset, offset + limit - 1);

  if(filter !== "all") q = q.eq("status", filter);

  const { data, error } = await q;

  if(error){
    historyEl.innerHTML = "<div class='err'>Failed to load deposit history</div>";
    return;
  }

  cache = cache.concat(data || []);
  render();

  loadMoreBtn.style.display = (data && data.length === limit) ? "inline-block" : "none";
  offset += limit;
}

// realtime update
function initRealtime(){
  supabaseClient.channel("realtime-deposits")
    .on("postgres_changes", {
      event:"UPDATE",
      schema:"public",
      table:"deposits",
      filter:`user_email=eq.${currentUserEmail}`
    }, payload => {
      loadHistory(true);
    })
    .subscribe();
}

document.getElementById("tabs").onclick = (e)=>{
  const tab = e.target.closest(".tab");
  if(!tab) return;
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  tab.classList.add("active");
  filter = tab.dataset.status;
  loadHistory(true);
};

document.getElementById("searchInput").addEventListener("input",(e)=>{
  searchTerm = e.target.value || "";
  render();
});
document.getElementById("clearSearch").onclick=()=>{
  document.getElementById("searchInput").value="";
  searchTerm="";
  render();
};
document.getElementById("refreshBtn").onclick=()=>loadHistory(true);
loadMoreBtn.onclick=()=>loadHistory(false);

async function submitDeposit(){
  showMsg("Submitting...");
  const asset=document.getElementById("confAsset").value;
  const network=document.getElementById("confNetwork").value;
  const amount=Number(document.getElementById("confAmount").value||0);
  const tx_hash=document.getElementById("confTx").value.trim();
  const file=document.getElementById("confProof").files[0];

  if(amount<=0 || tx_hash.length<5 || !file){
    showMsg("Fill all fields + upload proof", false);
    return;
  }

  const filePath = `${currentUserEmail}/${Date.now()}-${file.name}`;
  const upload = await supabaseClient.storage.from(BUCKET_NAME).upload(filePath,file);

  if(upload.error){
    showMsg("Upload failed: " + upload.error.message, false);
    return;
  }

  const proof_url = `${BUCKET_NAME}/${filePath}`;

  const { data: sessionData } = await supabaseClient.auth.getSession();
  const accessToken = sessionData?.session?.access_token;
  if(!accessToken){
    showMsg("Session expired. Login again.", false);
    return;
  }

  const res = await fetch(EDGE_SUBMIT_DEPOSIT_URL, {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":`Bearer ${accessToken}`,
      "apikey":SUPABASE_ANON_KEY
    },
    body: JSON.stringify({ asset, network, amount, tx_hash, proof_url })
  });

  const json = await res.json().catch(()=>null);
  if(!res.ok){
    showMsg("Error: " + (json?.error || JSON.stringify(json) || "Unknown"), false);
    return;
  }

  showMsg("Deposit submitted ✅", true);

  document.getElementById("confAmount").value="";
  document.getElementById("confTx").value="";
  document.getElementById("confProof").value="";

  loadHistory(true);
}

async function logout(){
  await supabaseClient.auth.signOut();
  window.location.href="login.html";
}

(async()=>{
  const { data:userData } = await supabaseClient.auth.getUser();
  if(!userData.user){
    document.body.innerHTML="<h2 style='color:white'>Login required</h2>";
    return;
  }
  currentUserEmail = userData.user.email;

  await loadHistory(true);
  initRealtime();
})();
</script>

</body>
</html>
