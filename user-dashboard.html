<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Coinluxora User Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#050a18;
  --stroke:rgba(255,255,255,.12);
  --text:#eaf0ff;
  --muted:rgba(234,240,255,.65);

  --ok:#22c55e;
  --err:#f87171;

  --blue:#5b6cff;
  --purple:#7c4dff;
  --green:#34d399;
  --cyan:#38bdf8;
  --pink:#ff4da6;

  --shadow: 0 26px 90px rgba(0,0,0,.55);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  padding:16px;
  padding-bottom:140px;
  overflow-x:hidden;
  background: var(--bg);
}

/* ===== UPPER ECHELON BACKGROUND ===== */
.bgFlow{
  position:fixed; inset:0; z-index:-4;
  background:
    radial-gradient(900px 520px at 10% 10%, rgba(83,113,255,.30), transparent 55%),
    radial-gradient(900px 520px at 90% 20%, rgba(52,211,153,.20), transparent 55%),
    radial-gradient(900px 520px at 40% 92%, rgba(255,77,166,.16), transparent 60%),
    linear-gradient(180deg, rgba(5,10,24,1), rgba(2,6,23,1));
}
.blob{
  position:fixed;
  width:520px;height:520px;border-radius:999px;
  filter: blur(72px);
  opacity:.60;
  z-index:-3;
  mix-blend-mode: screen;
  will-change: transform;
}
.blob.b1{ background: rgba(91,108,255,.92); left:-150px; top:-160px; animation: drift1 10s ease-in-out infinite; }
.blob.b2{ background: rgba(124,77,255,.82); right:-220px; top:5%; animation: drift2 12s ease-in-out infinite; }
.blob.b3{ background: rgba(52,211,153,.55); left:10%; bottom:-250px; animation: drift3 14s ease-in-out infinite; }
.blob.b4{ background: rgba(255,77,166,.58); right:10%; bottom:-260px; animation: drift4 11s ease-in-out infinite; }
@keyframes drift1{0%{transform:translate(0,0) scale(1)}50%{transform:translate(250px,140px) scale(1.10)}100%{transform:translate(0,0) scale(1)}}
@keyframes drift2{0%{transform:translate(0,0) scale(1)}50%{transform:translate(-280px,170px) scale(1.14)}100%{transform:translate(0,0) scale(1)}}
@keyframes drift3{0%{transform:translate(0,0) scale(1)}50%{transform:translate(210px,-210px) scale(1.10)}100%{transform:translate(0,0) scale(1)}}
@keyframes drift4{0%{transform:translate(0,0) scale(1)}50%{transform:translate(-180px,-130px) scale(1.09)}100%{transform:translate(0,0) scale(1)}}

.shimmer{
  position:fixed; inset:-30px; z-index:-2;
  opacity:.28;
  background:
    radial-gradient(600px 280px at 30% 10%, rgba(255,255,255,.10), transparent 60%),
    radial-gradient(700px 320px at 80% 60%, rgba(255,255,255,.07), transparent 60%),
    linear-gradient(120deg, transparent, rgba(255,255,255,.05), transparent);
  animation: shimmerMove 6s ease-in-out infinite alternate;
  pointer-events:none;
}
@keyframes shimmerMove{from{transform:translateY(0px) translateX(0px)}to{transform:translateY(42px) translateX(22px)}}

.container{max-width:920px;margin:0 auto}

/* ===== Loading Gate ===== */
#authGate{
  position:fixed; inset:0; z-index:99999;
  display:flex; align-items:center; justify-content:center;
  background:
    radial-gradient(900px 420px at 10% 0%, rgba(83,113,255,.22), transparent 55%),
    radial-gradient(900px 420px at 90% 0%, rgba(52,211,153,.18), transparent 55%),
    var(--bg);
}
.gateCard{
  width:min(520px,92vw);
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.25);
  border-radius:22px;
  padding:18px;
  box-shadow:0 26px 90px rgba(0,0,0,.55);
  backdrop-filter: blur(14px);
  text-align:center;
}
.gateLogo{
  width:62px;height:62px;border-radius:18px;
  margin:0 auto 10px;
  display:grid;place-items:center;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(109,87,255,1), rgba(124,77,255,1));
  box-shadow:0 18px 50px rgba(109,87,255,.28);
  font-size:28px;font-weight:1000;
}
.gateTxt{font-weight:1000}
.gateSub{margin-top:6px;color:rgba(234,240,255,.70);font-weight:900;font-size:13px}
.spinner{
  width:46px;height:46px;margin:14px auto 0;
  border-radius:999px;
  border:3px solid rgba(255,255,255,.18);
  border-top-color:#9bdcff;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ============================================================
   ‚úÖ STICKY MENU POLISH (FIX OVERLAP + PREMIUM SCROLL)
   - ONLY affects topRow wrapper
   ============================================================ */
.stickyMenu{
  position:sticky;
  top:12px;
  z-index:3000;
  margin-bottom:10px;     /* ‚úÖ creates space between menu and hello card */
}
.stickyMenu::before{
  content:"";
  position:absolute;
  inset:-10px -10px -8px -10px;
  border-radius:26px;
  background:rgba(5,10,24,.58);
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 18px 70px rgba(0,0,0,.55);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  z-index:-1;
  pointer-events:none;
  opacity:0;
  transform: translateY(-6px);
  transition: .18s ease;
}

/* becomes visible once user scrolls a bit */
.stickyMenu.isStuck::before{
  opacity:1;
  transform: translateY(0);
}

/* tighten the menu a little when stuck */
.stickyMenu.isStuck .topRow{
  margin-bottom:8px;
}

/* ===== TOP BAR ===== */
.topRow{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; margin-bottom:14px;
}
.brand{
  display:flex;align-items:center;gap:12px;
  padding:12px 14px;border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(90deg, rgba(109,87,255,1), rgba(135,116,255,0.86));
  color:white;font-weight:1000;letter-spacing:.6px;
  box-shadow:0 18px 50px rgba(109,87,255,.25);
  min-width:140px;
}
.brandIcon{
  width:34px;height:34px;border-radius:12px;
  background:rgba(255,255,255,.18);
  border:1px solid rgba(255,255,255,.22);
  display:grid;place-items:center;
  font-weight:1000;
}
.headerActions{display:flex;gap:10px;align-items:center}

/* ‚úÖ Avatar */
.avatarBtn{
  width:46px;height:46px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(124,77,255,1), rgba(109,87,255,1));
  cursor:pointer;
  box-shadow:0 16px 40px rgba(124,77,255,.32);
  display:grid;place-items:center;
  position:relative;overflow:hidden;
}
.avatarBtn:hover{filter:brightness(1.05)}
.avatarFallback{font-size:18px;line-height:1;z-index:2;}
.avatarImgBtn{position:absolute; inset:0;width:100%; height:100%;object-fit:cover;display:none;z-index:3;}

.iconBtn{
  width:46px;height:46px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.18);
  color:white;font-weight:1000;
  cursor:pointer;
  box-shadow:0 16px 40px rgba(0,0,0,.35);
  backdrop-filter: blur(10px);
}
.iconBtn:hover{background:rgba(255,255,255,.08)}

/* ===== HELLO CARD ===== */
.helloCard{
  border-radius:20px;
  padding:16px 16px;
  overflow:hidden;
  background:
    radial-gradient(800px 220px at 20% 20%, rgba(255,255,255,.18), transparent 60%),
    linear-gradient(90deg, rgba(109,87,255,1), rgba(255,77,166,0.98));
  color:white;
  box-shadow:0 22px 70px rgba(109,87,255,.22);
  display:flex;align-items:center;justify-content:space-between;gap:12px;
}
.helloLeft{display:flex;align-items:center;gap:12px;}
.helloLogo{
  width:48px;height:48px;border-radius:18px;
  background:rgba(255,255,255,.20);
  border:1px solid rgba(255,255,255,.22);
  display:grid;place-items:center;
  font-weight:1000;
}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
.miniChip{
  font-size:12px;font-weight:1000;
  padding:6px 10px;border-radius:999px;
  background:rgba(255,255,255,.18);
  border:1px solid rgba(255,255,255,.22);
  display:flex;gap:6px;align-items:center;
}
.helloTitle{font-weight:1000;font-size:18px}
.helloSub{font-size:12px;font-weight:900;opacity:.92}
.helloRight{
  display:flex;flex-direction:column;align-items:flex-end;gap:8px;
}
.helloRightTop{display:flex;align-items:center;gap:10px}
.idChip{
  padding:8px 12px;border-radius:999px;
  background:rgba(255,255,255,.18);
  border:1px solid rgba(255,255,255,.22);
  font-weight:1000;font-size:12px;
}
.logoutBtn{
  width:46px;height:46px;border-radius:999px;border:none;
  cursor:pointer;
  background:rgba(239,68,68,0.95);
  color:#fff;
  font-weight:1000;
  box-shadow:0 16px 40px rgba(239,68,68,.22);
}
.datetimeChip{
  padding:6px 10px;border-radius:999px;
  background:rgba(255,255,255,.16);
  border:1px solid rgba(255,255,255,.20);
  font-weight:1000;font-size:12px;
  color:#fff;
  white-space:nowrap;
}

/* ===== BOX ===== */
.box{
  border:1px solid rgba(255,255,255,.12);
  border-radius:24px;
  padding:16px;
  background:
    radial-gradient(700px 220px at 12% 10%, rgba(56,189,248,.14), transparent 62%),
    radial-gradient(700px 220px at 88% 18%, rgba(255,77,166,.10), transparent 62%),
    linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  box-shadow:0 26px 90px rgba(0,0,0,.55);
  backdrop-filter: blur(12px);
  margin-top:14px;
}
.box h2{margin:0;font-size:20px;font-weight:1000}
.small{color:var(--muted);font-size:13px;margin-top:8px}
.ok{color:var(--ok);font-weight:1000}
.err{color:var(--err);font-weight:1000}
.card{
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:12px;
  background:rgba(0,0,0,.22);
  box-shadow:0 16px 40px rgba(0,0,0,.35);
}

/* ‚úÖ highlight polish on touch */
.box, .balanceCard, .cryptoRow, .action, .card, .obCol, .chartWrap{
  -webkit-tap-highlight-color: transparent;
}

/* ===== balanceCard ===== */
.balanceCard{
  margin-top:14px;
  border-radius:24px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(900px 400px at 15% 20%, rgba(0,0,0,0.55), transparent 55%),
    radial-gradient(900px 400px at 70% 20%, rgba(52,211,153,.24), transparent 55%),
    linear-gradient(135deg, rgba(3,7,18,0.92), rgba(15,23,42,0.84));
  color:white;
  box-shadow: 0 26px 60px rgba(0,0,0,0.25);
  padding:16px;
}
.bTitle{font-size:13px;font-weight:1000;opacity:.85}
.bValue{font-size:34px;font-weight:1000;margin-top:8px}
.bHint{margin-top:6px;font-size:13px;font-weight:900;opacity:.88;display:flex;gap:10px;align-items:center}
.dot{width:10px;height:10px;border-radius:999px;background:var(--green)}
.actionGrid{
  margin-top:16px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
}
.action{
  border-radius:18px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.12);
  padding:12px;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  gap:8px;
  cursor:pointer;
  transition:.18s ease;
}
.action:hover{transform: translateY(-2px);background:rgba(255,255,255,.10)}
.aIcon{
  width:48px;height:48px;border-radius:999px;
  display:grid;place-items:center;
  font-size:20px;
  font-weight:1000;color:#fff;
}
.aSend{background:linear-gradient(180deg,#6d57ff,#7c4dff)}
.aReceive{background:linear-gradient(180deg,#18c07b,#11b981)}
.aPlans{background:linear-gradient(180deg,#f59e0b,#f97316)}
.aSupport{background:linear-gradient(180deg,#38bdf8,#5b6cff)}
.aText{font-weight:1000;font-size:13px}

/* ===== converters ===== */
.convGrid{margin-top:14px;display:grid;gap:12px}
.convRow{display:flex;gap:10px;flex-wrap:wrap}
.inp{
  flex:1;min-width:140px;
  height:50px;border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  color:var(--text);
  padding:10px 12px;
  font-weight:1000;
  outline:none;
  box-shadow:0 16px 40px rgba(0,0,0,.35);
}
.swapBtn{
  width:54px;height:50px;border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.08);
  color:#fff;
  font-weight:1000;
  cursor:pointer;
  box-shadow:0 16px 40px rgba(0,0,0,.35);
}
.swapBtn:hover{filter:brightness(1.05)}
.convBtn{
  width:100%;
  height:54px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background:linear-gradient(180deg, rgba(91,108,255,1), rgba(124,77,255,1));
  color:white;
  font-weight:1000;
  cursor:pointer;
  box-shadow:0 18px 55px rgba(91,108,255,.18);
  display:flex;align-items:center;justify-content:center;gap:10px;
}
.convBtn:hover{filter:brightness(1.05)}
.rateLine{
  margin-top:10px;
  font-size:12px;
  color:rgba(234,240,255,.75);
  font-weight:900;
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}
.rateDot{
  width:10px;height:10px;border-radius:999px;
  background:rgba(52,211,153,1);
  box-shadow:0 0 18px rgba(52,211,153,.55);
}

/* ===== searchable dropdown unlimited ===== */
.ddWrap{flex:1;min-width:220px;position:relative}
.ddBtn{
  width:100%;
  height:50px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  color:rgba(234,240,255,.95);
  padding:10px 12px;
  font-weight:1000;
  outline:none;
  box-shadow:0 16px 40px rgba(0,0,0,.35);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.ddLeft{display:flex;align-items:center;gap:10px;min-width:0}
.ddIcon{
  width:34px;height:34px;border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  display:grid;place-items:center;
  font-size:14px;
}
.ddName{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ddPanel{
  position:absolute; top:56px; left:0; right:0;
  z-index:100;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(2,6,23,.94);
  box-shadow:0 26px 90px rgba(0,0,0,.65);
  backdrop-filter: blur(16px);
  overflow:hidden;
  display:none;
}
.ddPanel.show{display:block;}
.ddSearch{
  width:100%;
  height:46px;
  border:none; outline:none;
  padding:0 12px;
  font-weight:1000;
  color:#fff;
  background:rgba(0,0,0,.20);
  border-bottom:1px solid rgba(255,255,255,.10);
}
.ddList{max-height:320px;overflow:auto;}
.ddItem{
  padding:12px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  cursor:pointer;
  border-bottom:1px solid rgba(255,255,255,.06);
  color:rgba(234,240,255,.86);
  font-weight:900;
}
.ddItem:hover{background:rgba(255,255,255,.06)}
.ddItem small{color:rgba(234,240,255,.55);font-weight:900}

/* ===== order book ===== */
.orderWrap{
  margin-top:12px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.obCol{
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  padding:12px;
  box-shadow:0 16px 40px rgba(0,0,0,.35);
}
.obTitle{
  font-weight:1000;
  color:rgba(234,240,255,.85);
  font-size:13px;
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
}
.obList{
  display:grid;
  gap:8px;
  max-height:260px;
  overflow:auto;
  padding-right:6px;
}
.obItem{
  display:flex;
  justify-content:space-between;
  gap:8px;
  font-weight:900;
  font-size:12px;
  color:rgba(234,240,255,.78);
}
@media(max-width:520px){.orderWrap{grid-template-columns:1fr}}

/* ===== mini chart ===== */
.chartWrap{
  margin-top:12px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  overflow:hidden;
  background:rgba(0,0,0,.22);
  box-shadow:0 16px 40px rgba(0,0,0,.35);
}
.chartHead{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,.10);
  font-weight:1000;
  color:rgba(234,240,255,.78);
  font-size:13px;
}
.chartFrame{width:100%;height:340px;border:0;display:block}

/* ===== SIDEBAR ===== */
.overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.65);
  display:none; z-index:999;
  backdrop-filter: blur(4px);
}
.overlay.show{display:block;}
.sidebar{
  position:fixed; top:0; left:-315px;
  width:292px; height:100vh;
  padding:16px;
  z-index:1000;
  transition: .28s ease;
  border-right:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(900px 420px at 15% 10%, rgba(91,108,255,.18), transparent 55%),
    radial-gradient(900px 420px at 90% 20%, rgba(52,211,153,.12), transparent 55%),
    linear-gradient(180deg, rgba(4,8,20,0.98), rgba(2,6,23,0.98));
  box-shadow:0 26px 90px rgba(0,0,0,.60);
  backdrop-filter: blur(16px);
}
.sidebar.open{ left:0; }
.sideTop{
  display:flex;align-items:center;justify-content:space-between;
  gap:10px;margin-bottom:12px;
}
.sideBrand{
  display:flex;align-items:center;gap:10px;
  font-weight:1000;font-size:16px;letter-spacing:.9px;
  color:#fff;
  padding:10px 12px;border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:linear-gradient(90deg, rgba(109,87,255,.85), rgba(124,77,255,.85));
  box-shadow:0 16px 50px rgba(109,87,255,.18);
  min-width:170px;
}
.sideBrandIcon{
  width:30px;height:30px;border-radius:12px;
  display:grid;place-items:center;
  background:rgba(255,255,255,.16);
  border:1px solid rgba(255,255,255,.20);
}
.closeBtn{
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.14);
  color:rgba(234,240,255,.95);
  border-radius:14px;
  width:44px;height:44px;
  cursor:pointer;
  display:grid;place-items:center;
  font-weight:1000;
}
.closeBtn:hover{background:rgba(255,255,255,.08)}

.userTag{
  padding:12px 12px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.10);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  box-shadow:0 18px 55px rgba(0,0,0,.35);
  margin:10px 0 14px;
  display:flex;align-items:center;justify-content:space-between;gap:12px;
}
.userTagLeft{min-width:0}
.userTag .t1{color:rgba(234,240,255,.55);font-weight:1000;font-size:12px}
.userTag .t2{
  margin-top:6px;font-weight:1000;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  max-width:180px;
}
.sideAvatar{
  width:46px;height:46px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.25);
  display:grid;place-items:center;
  position:relative;overflow:hidden;
  box-shadow:0 16px 40px rgba(0,0,0,.35);
  flex:0 0 auto;
}
.sideAvatar span{font-size:18px}
.sideAvatar img{
  position:absolute; inset:0;
  width:100%;height:100%;
  object-fit:cover;
  display:none;
}

.menuGroupTitle{
  margin:10px 0 8px;
  font-size:12px;font-weight:1000;
  color:rgba(234,240,255,.50);
  letter-spacing:.8px;
  text-transform:uppercase;
}
.sideItem{
  display:flex;align-items:center;gap:12px;
  padding:12px 12px;border-radius:18px;
  color:rgba(234,240,255,.82);
  text-decoration:none;
  font-weight:1000;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.22);
  box-shadow:0 16px 40px rgba(0,0,0,.35);
  margin-bottom:10px;
  position:relative;overflow:hidden;
}
.sideItem:hover{background:rgba(255,255,255,.08)}
.sideItem .i{
  width:42px;height:42px;border-radius:16px;
  display:grid;place-items:center;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  font-size:18px;
}
.sideItem small{display:block;color:rgba(234,240,255,.55);font-size:12px;font-weight:900;margin-top:2px}
.activeLink{
  border:1px solid rgba(56,189,248,.55);
  background:linear-gradient(180deg, rgba(56,189,248,0.14), rgba(56,189,248,0.08));
  color:#cfefff;
}
.activeLink::after{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(600px 160px at 30% 20%, rgba(56,189,248,.20), transparent 60%);
  pointer-events:none;
}
.sideLogout{
  margin-top:10px;
  background:linear-gradient(90deg, rgba(248,113,113,1), rgba(239,68,68,1));
  color:#020617;border:none;width:100%;
  padding:14px;border-radius:18px;font-weight:1000;cursor:pointer;
  box-shadow:0 18px 55px rgba(239,68,68,.18);
}
.sideLogout:hover{filter:brightness(1.03)}

/* ===== DOCK ===== */
.dock{
  position:fixed;
  left:0; right:0; bottom:14px;
  z-index:2000;
  pointer-events:none;
}
.dockInner{
  pointer-events:auto;
  max-width:980px;
  margin:0 auto;
  padding:0 14px;
}
.dockBar{
  height:76px;
  border-radius:28px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 20px 70px rgba(0,0,0,.45);
  backdrop-filter: blur(14px);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  gap:10px;
}
.dockItem{
  flex:1;
  min-width:70px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:6px;
  border-radius:18px;
  padding:10px 0;
  color:rgba(234,240,255,.55);
  font-size:12px;
  font-weight:1000;
  cursor:pointer;
  user-select:none;
  position:relative;
}
.dockItem .ico{font-size:18px;opacity:.95}
.dockItem:hover{background:rgba(255,255,255,.06)}
.dockActive{color:#9bdcff;background:rgba(56,189,248,.10)}
.dockHome{
  width:78px;height:78px;border-radius:26px;
  background:linear-gradient(180deg, rgba(109,87,255,1), rgba(91,108,255,1));
  box-shadow:0 22px 55px rgba(109,87,255,.30);
  display:grid;place-items:center;
  margin-top:-32px;
  border:1px solid rgba(255,255,255,.16);
  cursor:pointer;user-select:none;
  flex:0 0 auto;
  pointer-events:auto;
}
.dockHome span{font-size:28px;color:white}
.dockHome:hover{filter:brightness(1.05)}
.dockBadge{
  position:absolute;
  top:2px;
  right:18px;
  min-width:18px;
  height:18px;
  padding:0 6px;
  border-radius:999px;
  background:#f87171;
  color:#020617;
  font-weight:1000;
  font-size:11px;
  display:none;
  align-items:center;
  justify-content:center;
  border:1px solid rgba(255,255,255,.18);
}

/* ============================================================
   ‚úÖ TOP 10 CRYPTO LIST (ADDED)
   ============================================================ */
.crypto10Grid{
  margin-top:12px;
  display:grid;
  gap:10px;
}
.cryptoRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:12px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.22);
  box-shadow:0 16px 40px rgba(0,0,0,.35);
}
.cryptoLeft{
  display:flex;
  align-items:center;
  gap:12px;
  min-width:0;
}
.cryptoLogo{
  width:42px;
  height:42px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  display:grid;
  place-items:center;
  overflow:hidden;
  flex:0 0 auto;
}
.cryptoLogo img{width:100%;height:100%;object-fit:cover;display:block;}
.cryptoName{
  font-weight:1000;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.cryptoSym{
  display:block;
  font-size:12px;
  font-weight:1000;
  color:rgba(234,240,255,.55);
  margin-top:2px;
}
.cryptoRight{
  text-align:right;
  flex:0 0 auto;
}
.cryptoPrice{
  font-weight:1000;
  font-size:14px;
}
.cryptoChg{
  margin-top:4px;
  font-weight:1000;
  font-size:12px;
  color:rgba(234,240,255,.65);
}
.cryptoChg.up{color:rgba(34,197,94,1)}
.cryptoChg.down{color:rgba(248,113,113,1)}
</style>
</head>

<body>
<div class="bgFlow"></div>
<div class="blob b1"></div>
<div class="blob b2"></div>
<div class="blob b3"></div>
<div class="blob b4"></div>
<div class="shimmer"></div>

<!-- Loading -->
<div id="authGate">
  <div class="gateCard">
    <div class="gateLogo">üì£</div>
    <div class="gateTxt">Coinluxora</div>
    <div class="gateSub">Securing your session‚Ä¶</div>
    <div class="spinner"></div>
  </div>
</div>

<div id="overlay" class="overlay" onclick="closeMenu()"></div>

<!-- Sidebar -->
<div id="sidebar" class="sidebar">
  <div class="sideTop">
    <div class="sideBrand">
      <div class="sideBrandIcon">‚óà</div>
      COINLUXORA
    </div>
    <button class="closeBtn" onclick="closeMenu()">‚úï</button>
  </div>

  <div class="userTag">
    <div class="userTagLeft">
      <div class="t1">Logged in as</div>
      <div id="sideName" class="t2">---</div>
    </div>
    <div class="sideAvatar" title="Profile photo">
      <span id="sideAvatarFallback">üë§</span>
      <img id="sideAvatarImg" alt="Avatar"/>
    </div>
  </div>

  <div class="menuGroupTitle">Navigation</div>

  <a class="sideItem activeLink" href="user-dashboard.html"><div class="i">üè†</div><div>Dashboard<small>Main overview</small></div></a>
  <a class="sideItem" href="portfolio.html"><div class="i">üìä</div><div>Portfolio<small>Your assets</small></div></a>
  <a class="sideItem" href="deposits.html"><div class="i">üí≥</div><div>Deposit<small>Fund your account</small></div></a>
  <a class="sideItem" href="withdraw.html"><div class="i">‚û°</div><div>Withdraw Funds<small>Request payout</small></div></a>
  <a class="sideItem" href="support.html"><div class="i">üßë‚Äçüíª</div><div>Support / Contact<small>Tickets & help</small></div></a>
  <a class="sideItem" href="plans.html"><div class="i">üíº</div><div>Investment Plans<small>Start investing</small></div></a>
  <a class="sideItem" href="profile.html"><div class="i">üë§</div><div>Profile / Settings<small>Account security</small></div></a>

  <button class="sideLogout" onclick="logout()">Logout</button>
</div>

<div class="container">

  <!-- ‚úÖ STICKY WRAP -->
  <div id="stickyMenu" class="stickyMenu">
    <div class="topRow">
      <div class="brand"><div class="brandIcon">üì£</div>COIN</div>
      <div class="headerActions">
        <button class="avatarBtn" onclick="goProfile()" title="Profile">
          <span id="avatarFallback" class="avatarFallback">üë§</span>
          <img id="avatarImgBtn" class="avatarImgBtn" alt="Avatar"/>
        </button>
        <button class="iconBtn" onclick="openMenu()" title="Menu">‚ò∞</button>
      </div>
    </div>
  </div>

  <div class="helloCard">
    <div class="helloLeft">
      <div class="helloLogo">üí´</div>
      <div>
        <div class="chips">
          <div class="miniChip">üü¢ active</div>
          <div class="miniChip" id="countryChip" style="display:none"></div>
        </div>
        <div class="helloTitle" id="greetingTitle">Greetings‚Ä¶</div>
        <div class="helloSub" id="helloName">Loading‚Ä¶</div>
      </div>
    </div>

    <div class="helloRight">
      <div class="helloRightTop">
        <div class="idChip" id="userIdChip">ID:</div>
        <button class="logoutBtn" onclick="logout()" title="Logout">‚éã</button>
      </div>
      <div class="datetimeChip" id="dateTimeNow">--- | ---</div>
    </div>
  </div>

  <div class="balanceCard">
    <div class="bTitle">Total Portfolio Value</div>
    <div class="bValue" id="balance">--</div>
    <div class="bHint"><div class="dot"></div> <div>Your trading account balance</div></div>

    <div class="actionGrid">
      <div class="action" onclick="goWithdrawAndClear()"><div class="aIcon aSend">‚úàÔ∏è</div><div class="aText">Send</div></div>
      <div class="action" onclick="goDepositAndClear()"><div class="aIcon aReceive">‚¨áÔ∏è</div><div class="aText">Receive</div></div>
      <div class="action" onclick="goPlans()"><div class="aIcon aPlans">üìà</div><div class="aText">Plans</div></div>
      <div class="action" onclick="goSupportAndClear()"><div class="aIcon aSupport">üí¨</div><div class="aText">Support</div></div>
    </div>
  </div>

  <div class="box">
    <h2>Active Investment Plan</h2>
    <div id="planMsg" class="small">Loading‚Ä¶</div>
    <div id="planBox"></div>
  </div>

  <div class="box">
    <h2>Top 10 Major Cryptos</h2>
    <div class="small">Live market prices (auto refresh every 20 seconds).</div>
    <div id="top10Msg" class="small">Loading‚Ä¶</div>
    <div id="top10List" class="crypto10Grid"></div>
  </div>

  <div class="box">
    <h2>Top 10 Forex Pairs</h2>
    <div class="small">Live prices (auto refresh every 30 seconds).</div>
    <div id="fxMsg" class="small">Loading‚Ä¶</div>
    <div id="fxList" class="crypto10Grid"></div>
  </div>

  <div class="box">
    <h2>Top Stocks</h2>
    <div class="small">Live prices (auto refresh every 30 seconds).</div>
    <div id="stocksMsg" class="small">Loading‚Ä¶</div>
    <div id="stocksList" class="crypto10Grid"></div>
  </div>

  <div class="box">
    <h2>Top 10 Futures</h2>
    <div class="small">Live prices (auto refresh every 30 seconds).</div>
    <div id="futuresMsg" class="small">Loading‚Ä¶</div>
    <div id="futuresList" class="crypto10Grid"></div>
  </div>

  <div class="box">
    <h2>Top 10 Indices</h2>
    <div class="small">Live prices (auto refresh every 30 seconds).</div>
    <div id="indicesMsg" class="small">Loading‚Ä¶</div>
    <div id="indicesList" class="crypto10Grid"></div>
  </div>

  <div class="box">
    <h2>Crypto Converter</h2>
    <div class="small">Search & convert from ALL coins to ALL fiat currencies.</div>

    <div class="convGrid">
      <div class="convRow">
        <div class="ddWrap" id="ddCryptoA"></div>
        <button class="swapBtn" onclick="swapCrypto()">‚áÑ</button>
        <div class="ddWrap" id="ddCryptoB"></div>
      </div>

      <div class="convRow">
        <input id="cryptoAmount" class="inp" type="number" min="0" step="0.00000001" placeholder="Enter amount"/>
      </div>

      <button class="convBtn" onclick="convertCrypto()">‚ö° Convert</button>

      <div class="card">
        <div class="rateLine"><span class="rateDot"></span> <span id="cryptoRate">Rate: --</span></div>
        <div class="small" style="margin-top:10px;font-size:14px;">Result: <strong id="cryptoResult">--</strong></div>
        <div class="small" style="margin-top:10px;font-size:14px;">Reverse: <strong id="cryptoReverse">--</strong></div>
        <div class="small" style="margin-top:10px;font-size:13px;color:rgba(234,240,255,.55)">
          Tip: Search by coin name or symbol (example: ‚Äúbtc‚Äù, ‚Äúeth‚Äù, ‚Äúsol‚Äù, ‚Äúxrp‚Äù).
        </div>
      </div>
    </div>
  </div>

  <div class="box">
    <h2>Fiat Currency Converter</h2>
    <div class="small">Search & convert from ALL fiat currencies to ALL fiat currencies.</div>

    <div class="convGrid">
      <div class="convRow">
        <div class="ddWrap" id="ddFiatA"></div>
        <button class="swapBtn" onclick="swapFiat()">‚áÑ</button>
        <div class="ddWrap" id="ddFiatB"></div>
      </div>

      <div class="convRow">
        <input id="fiatAmount" class="inp" type="number" min="0" step="0.01" placeholder="Enter amount"/>
      </div>

      <button class="convBtn" onclick="convertFiat()">üí± Convert Fiat</button>

      <div class="card">
        <div class="rateLine"><span class="rateDot"></span> <span id="fiatRate">Rate: --</span></div>
        <div class="small" style="margin-top:10px;font-size:14px;">Result: <strong id="fiatResult">--</strong></div>
      </div>
    </div>
  </div>

  <div class="box">
    <h2>Live Crypto Order Book</h2>
    <div class="small">Auto refresh every 3 seconds. Binance ‚Üí OKX ‚Üí Bybit fallback.</div>

    <div class="convRow" style="margin-top:12px">
      <select id="obPair" class="inp" style="min-width:220px">
        <option value="BTCUSDT">BTC/USDT</option>
        <option value="ETHUSDT">ETH/USDT</option>
        <option value="BNBUSDT">BNB/USDT</option>
        <option value="XRPUSDT">XRP/USDT</option>
        <option value="SOLUSDT">SOL/USDT</option>
      </select>
      <button class="convBtn" style="height:50px" onclick="loadOrderBook(true)">üîÑ Refresh Now</button>
    </div>

    <div class="orderWrap">
      <div class="obCol">
        <div class="obTitle"><span>üü• Asks</span><span style="color:rgba(234,240,255,.55);font-size:12px">Price | Amount</span></div>
        <div id="asks" class="obList"></div>
      </div>
      <div class="obCol">
        <div class="obTitle"><span>üü© Bids</span><span style="color:rgba(234,240,255,.55);font-size:12px">Price | Amount</span></div>
        <div id="bids" class="obList"></div>
      </div>
    </div>

    <div class="chartWrap">
      <div class="chartHead">
        <span>Mini Candlestick Chart</span>
        <span id="chartPair">BTC/USDT</span>
      </div>
      <iframe id="tvChart" class="chartFrame"></iframe>
    </div>
  </div>

</div>

<div class="dock">
  <div class="dockInner">
    <div class="dockBar">
      <div class="dockItem" onclick="goDepositAndClear()"><div id="badgeDepositDock" class="dockBadge">0</div><div class="ico">üí≥</div><div>Deposit</div></div>
      <div class="dockItem" onclick="goWithdrawAndClear()"><div id="badgeWithdrawDock" class="dockBadge">0</div><div class="ico">‚û°</div><div>Withdraw</div></div>
      <div class="dockHome" onclick="goDashboard()"><span>üè†</span></div>
      <div class="dockItem" onclick="goPlans()"><div class="ico">üíº</div><div>Plans</div></div>
      <div class="dockItem" onclick="goProfile()"><div class="ico">üë§</div><div>Profile</div></div>
    </div>
  </div>
</div>

<script>
/* ============================================================
   ‚úÖ STICKY MENU POLISH SCRIPT
   - adds blur background only after scroll
   ============================================================ */
(function(){
  const sticky = document.getElementById("stickyMenu");
  if(!sticky) return;
  const onScroll = ()=>{
    if(window.scrollY > 14) sticky.classList.add("isStuck");
    else sticky.classList.remove("isStuck");
  };
  onScroll();
  window.addEventListener("scroll", onScroll, {passive:true});
})();

/* ============================================================
   ‚úÖ AUTH GUARD
   ============================================================ */
const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";
const EDGE_CLEAR_BADGE_URL = `${SUPABASE_URL}/functions/v1/clear_badge`;
const supabaseClient=supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUserEmail="";
let currentUserId="";
let badgeChannel=null;

/* converter global */
let ALL_COINS=[];
let FIATS=[];
let FX_RATES=null;
let cryptoDirection="crypto_to_fiat"; // or fiat_to_crypto

let selectedCryptoA={ id:"bitcoin", label:"Bitcoin (BTC)", icon:"‚Çø", symbol:"btc" };
let selectedCryptoB={ id:"USD", label:"USD", icon:"$", symbol:"usd" };
let selectedFiatA={ id:"USD", label:"USD", icon:"$" };
let selectedFiatB={ id:"NGN", label:"NGN", icon:"‚Ç¶" };

let orderTimer=null;

/* ============================================================
   ‚úÖ TOP 10 MAJOR CRYPTO (ADDED)
   ============================================================ */
const TOP10_IDS = [
  "bitcoin",
  "ethereum",
  "tether",
  "binancecoin",
  "solana",
  "ripple",
  "usd-coin",
  "dogecoin",
  "cardano",
  "tron"
];
let top10Timer=null;

/* ============================================================
   ‚úÖ MARKET LISTS (FOREX/STOCKS/FUTURES/INDICES) - ADDED
   - Stooq CSV feed (browser safe)
   ============================================================ */
const FX_SYMBOLS = [
  { title:"EUR/USD", sym:"EURUSD" },
  { title:"GBP/USD", sym:"GBPUSD" },
  { title:"USD/JPY", sym:"USDJPY" },
  { title:"AUD/USD", sym:"AUDUSD" },
  { title:"USD/CAD", sym:"USDCAD" },
  { title:"USD/CHF", sym:"USDCHF" },
  { title:"NZD/USD", sym:"NZDUSD" },
  { title:"EUR/GBP", sym:"EURGBP" },
  { title:"EUR/JPY", sym:"EURJPY" },
  { title:"GBP/JPY", sym:"GBPJPY" }
];

const STOCK_SYMBOLS = [
  { title:"Apple", sym:"AAPL.US" },
  { title:"Microsoft", sym:"MSFT.US" },
  { title:"NVIDIA", sym:"NVDA.US" },
  { title:"Amazon", sym:"AMZN.US" },
  { title:"Alphabet", sym:"GOOGL.US" },
  { title:"Meta", sym:"META.US" },
  { title:"Tesla", sym:"TSLA.US" },
  { title:"Visa", sym:"V.US" },
  { title:"JPMorgan", sym:"JPM.US" },
  { title:"Coca-Cola", sym:"KO.US" }
];

const FUTURES_SYMBOLS = [
  { title:"Gold", sym:"GC.F" },
  { title:"Silver", sym:"SI.F" },
  { title:"Crude Oil", sym:"CL.F" },
  { title:"Brent Oil", sym:"BZZ.F" },
  { title:"Natural Gas", sym:"NG.F" },
  { title:"Corn", sym:"ZC.F" },
  { title:"Wheat", sym:"ZW.F" },
  { title:"Soybeans", sym:"ZS.F" },
  { title:"Copper", sym:"HG.F" },
  { title:"Coffee", sym:"KC.F" }
];

const INDEX_SYMBOLS = [
  { title:"S&P 500", sym:"^SPX" },
  { title:"NASDAQ 100", sym:"^NDX" },
  { title:"Dow Jones", sym:"^DJI" },
  { title:"DAX", sym:"^DAX" },
  { title:"FTSE 100", sym:"^FTSE" },
  { title:"CAC 40", sym:"^CAC" },
  { title:"Nikkei 225", sym:"^N225" },
  { title:"Hang Seng", sym:"^HSI" },
  { title:"Shanghai", sym:"^SSEC" },
  { title:"Sensex", sym:"^BSESN" }
];

let marketTimer=null;

function parseCSVLine(line){
  const out=[];
  let cur="", inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch === '"'){ inQ=!inQ; continue; }
    if(ch === "," && !inQ){ out.push(cur); cur=""; continue; }
    cur += ch;
  }
  out.push(cur);
  return out;
}

async function fetchStooqQuote(symbol){
  const s=String(symbol||"").toLowerCase();
  const url = `https://stooq.com/q/l/?s=${encodeURIComponent(s)}&f=sd2t2ohlcv&h&e=csv`;
  const res = await fetch(url);
  const text = await res.text();
  const lines = text.trim().split(/\r?\n/);
  if(lines.length < 2) throw new Error("no csv");
  const hdr=parseCSVLine(lines[0]);
  const row=parseCSVLine(lines[1]);
  const m={};
  hdr.forEach((k,idx)=>m[k]=row[idx]);
  if(!m.Close || m.Close==="N/A") throw new Error("na");
  const close=Number(m.Close||0);
  const open=Number(m.Open||0);
  const chg = open ? ((close-open)/open)*100 : 0;
  return { close, open, chg };
}

function logoForMarket(type, sym){
  if(type==="stock"){
    const t = sym.replace(".US","").replace(".us","");
    const domainMap={
      AAPL:"apple.com", MSFT:"microsoft.com", NVDA:"nvidia.com", AMZN:"amazon.com",
      GOOGL:"abc.xyz", META:"meta.com", TSLA:"tesla.com", V:"visa.com",
      JPM:"jpmorganchase.com", KO:"coca-colacompany.com"
    };
    const domain = domainMap[String(t||"").toUpperCase()];
    if(domain){
      return `<img src="https://logo.clearbit.com/${domain}" alt="${t}" onerror="this.style.display='none'">`;
    }
  }
  return "";
}

function buildMarketRow(type, title, symbol, price, chg){
  const up = (chg>=0);
  const chgClass = up ? "up" : "down";
  const sign = up ? "+" : "";
  let leftIcon="";
  if(type==="fx") leftIcon="üí±";
  if(type==="future") leftIcon="üßæ";
  if(type==="index") leftIcon="üìå";
  const logoHTML = (type==="stock") ? logoForMarket(type, symbol) : "";
  return `
    <div class="cryptoRow">
      <div class="cryptoLeft">
        <div class="cryptoLogo">
          ${logoHTML || `<span style="font-weight:1000">${leftIcon}</span>`}
        </div>
        <div style="min-width:0">
          <div class="cryptoName">${title}</div>
          <span class="cryptoSym">${symbol}</span>
        </div>
      </div>
      <div class="cryptoRight">
        <div class="cryptoPrice">${Number(price).toLocaleString(undefined,{maximumFractionDigits:6})}</div>
        <div class="cryptoChg ${chgClass}">${sign}${Number(chg).toFixed(2)}%</div>
      </div>
    </div>
  `;
}

async function loadMarketList(type, items, msgId, listId){
  const msg=document.getElementById(msgId);
  const list=document.getElementById(listId);
  if(!msg || !list) return;

  try{
    msg.textContent="Loading‚Ä¶";
    const results=[];
    for(const it of items){
      try{
        const stooqSym = (type==="fx") ? `${it.sym}` : it.sym;
        const q = await fetchStooqQuote(stooqSym);
        results.push({ ...it, close:q.close, chg:q.chg });
      }catch{
        results.push({ ...it, close:null, chg:0, fail:true });
      }
    }

    msg.textContent="";
    list.innerHTML = results.map(r=>{
      if(r.fail || r.close===null){
        return buildMarketRow(type, r.title, r.sym, "--", 0).replace("0.00%","--");
      }
      return buildMarketRow(type, r.title, r.sym, r.close, r.chg);
    }).join("");
  }catch(e){
    msg.innerHTML = "<span class='err'>Unable to load market prices (blocked / network).</span>";
    list.innerHTML="";
  }
}

async function loadAllMarkets(){
  await loadMarketList("fx", FX_SYMBOLS, "fxMsg", "fxList");
  await loadMarketList("stock", STOCK_SYMBOLS, "stocksMsg", "stocksList");
  await loadMarketList("future", FUTURES_SYMBOLS, "futuresMsg", "futuresList");
  await loadMarketList("index", INDEX_SYMBOLS, "indicesMsg", "indicesList");
}

function startMarketAutoRefresh(){
  if(marketTimer) clearInterval(marketTimer);
  marketTimer=setInterval(loadAllMarkets, 30000);
}

function fmtMoneySmart(n){
  const num=Number(n||0);
  if(num >= 1000) return "$" + num.toLocaleString(undefined,{maximumFractionDigits:2});
  if(num >= 1) return "$" + num.toLocaleString(undefined,{maximumFractionDigits:4});
  return "$" + num.toLocaleString(undefined,{maximumFractionDigits:8});
}

async function loadTop10MajorCryptos(){
  const msg=document.getElementById("top10Msg");
  const list=document.getElementById("top10List");
  if(!msg || !list) return;

  try{
    msg.textContent="Loading‚Ä¶";
    const url =
      `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${encodeURIComponent(TOP10_IDS.join(","))}&order=market_cap_desc&per_page=10&page=1&sparkline=false`;
    const res=await fetch(url);
    const data=await res.json();

    if(!Array.isArray(data) || data.length===0) throw new Error("No data");
    msg.textContent="";
    list.innerHTML = data.map(c=>{
      const chg=Number(c.price_change_percentage_24h||0);
      const chgClass = chg>=0 ? "up" : "down";
      const sign = chg>=0 ? "+" : "";
      return `
        <div class="cryptoRow">
          <div class="cryptoLeft">
            <div class="cryptoLogo">
              <img src="${c.image}" alt="${c.symbol}"/>
            </div>
            <div style="min-width:0">
              <div class="cryptoName">${c.name}</div>
              <span class="cryptoSym">${String(c.symbol||"").toUpperCase()}</span>
            </div>
          </div>

          <div class="cryptoRight">
            <div class="cryptoPrice">${fmtMoneySmart(c.current_price)}</div>
            <div class="cryptoChg ${chgClass}">${sign}${chg.toFixed(2)}% (24h)</div>
          </div>
        </div>
      `;
    }).join("");
  }catch(e){
    msg.innerHTML = "<span class='err'>Unable to load live crypto prices (network blocked).</span>";
    list.innerHTML = "";
  }
}

function startTop10AutoRefresh(){
  if(top10Timer) clearInterval(top10Timer);
  top10Timer=setInterval(loadTop10MajorCryptos, 20000);
}

/* ===== auth ===== */
(async function authGuard(){
  try{
    const { data: sessionData } = await supabaseClient.auth.getSession();
    const session = sessionData?.session;
    if(!session){ window.location.replace("login.html"); return; }

    const { data, error } = await supabaseClient.auth.getUser();
    const user = data?.user;
    if(error || !user){ window.location.replace("login.html"); return; }

    if(!user.email_confirmed_at){
      await supabaseClient.auth.signOut();
      window.location.replace("verify.html?status=unverified");
      return;
    }
    window.COINLUXORA_USER=user;
    initWithUser(user);
  }catch(e){
    window.location.replace("login.html");
  }
})();

/* NAV */
function goPlans(){ window.location.href="plans.html"; }
function goProfile(){ window.location.href="profile.html"; }
function goDepositAndClear(){ clearBadge("deposits"); window.location.href="deposits.html"; }
function goWithdrawAndClear(){ clearBadge("withdrawals"); window.location.href="withdraw.html"; }
function goSupportAndClear(){ clearBadge("notifications"); window.location.href="support.html"; }
function goDashboard(){ window.scrollTo({top:0,behavior:"smooth"}); }

function openMenu(){ document.getElementById("sidebar").classList.add("open"); document.getElementById("overlay").classList.add("show"); }
function closeMenu(){ document.getElementById("sidebar").classList.remove("open"); document.getElementById("overlay").classList.remove("show"); }
function hideGate(){ const g=document.getElementById("authGate"); if(g) g.style.display="none"; }

/* greeting */
function setGreeting(){
  const h = new Date().getHours();
  let text="Greetings", emoji="‚ú®";
  if(h>=5 && h<12){ text="Good Morning"; emoji="üåû"; }
  else if(h>=12 && h<17){ text="Good Afternoon"; emoji="‚òÄÔ∏è"; }
  else { text="Good Evening"; emoji="üåô"; }
  document.getElementById("greetingTitle").textContent = `${text} ${emoji}`;
}
function startClock(){
  const dtEl=document.getElementById("dateTimeNow");
  const days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const tick=()=>{
    const now=new Date();
    const dayName=days[now.getDay()];
    const day=String(now.getDate()).padStart(2,"0");
    const mon=months[now.getMonth()];
    const yr=now.getFullYear();
    let hh=now.getHours();
    const ampm=hh>=12?"PM":"AM";
    hh=hh%12; hh=hh?hh:12;
    const hhs=String(hh).padStart(2,"0");
    const mm=String(now.getMinutes()).padStart(2,"0");
    const ss=String(now.getSeconds()).padStart(2,"0");
    dtEl.textContent=`${dayName}, ${day} ${mon} ${yr} | ${hhs}:${mm}:${ss} ${ampm}`;
  };
  tick(); setInterval(tick,1000);
}

/* avatar */
function setTopAvatar(avatarUrl){
  const fallback=document.getElementById("avatarFallback");
  const img=document.getElementById("avatarImgBtn");
  if(avatarUrl){
    img.src=avatarUrl+"?t="+Date.now();
    img.style.display="block";
    fallback.style.display="none";
  }else{
    img.style.display="none";
    fallback.style.display="block";
  }
}
function setSideAvatar(avatarUrl){
  const fb=document.getElementById("sideAvatarFallback");
  const img=document.getElementById("sideAvatarImg");
  if(avatarUrl){
    img.src=avatarUrl+"?t="+Date.now();
    img.style.display="block";
    fb.style.display="none";
  }else{
    img.style.display="none";
    fb.style.display="block";
  }
}
function setNameEverywhere(fullName){
  const nice=(fullName && fullName.trim()) ? fullName.trim() : "User";
  document.getElementById("helloName").innerHTML=`<span class="ok">${nice}</span>`;
  document.getElementById("sideName").textContent=nice;
}

/* ========= COUNTRY CHIP (FULL FIX + FULL NAME) ========= */
function isoToFlag(iso){
  if(!iso || iso.length!==2) return "";
  const code=iso.toUpperCase();
  const A=0x1F1E6;
  return String.fromCodePoint(...[...code].map(c=>A + c.charCodeAt(0)-65));
}
function setCountryChip(iso, fullName=""){
  const el=document.getElementById("countryChip");
  if(!el) return;

  if(!iso || iso.length!==2){
    el.style.display="none";
    el.textContent="";
    return;
  }

  const flag=isoToFlag(iso);
  if(!flag){
    el.style.display="none";
    el.textContent="";
    return;
  }

  const cleanName = (fullName || "").trim();
  el.textContent = cleanName
    ? `${flag} ${iso.toUpperCase()} ¬∑ ${cleanName}`
    : `${flag} ${iso.toUpperCase()}`;

  el.style.display="inline-flex";
}
function normalizeCountryText(v){
  if(!v) return "";
  return String(v)
    .replace(/[\uD83C-\uDBFF\uDC00-\uDFFF]/g,"")
    .replace(/[^\w\s-]/g," ")
    .trim()
    .toLowerCase();
}
function isoToCountryName(iso){
  if(!iso) return "";
  const c = iso.toUpperCase();
  const map = {
    NG:"Nigeria",
    US:"United States",
    GB:"United Kingdom",
    CA:"Canada",
    DE:"Germany",
    FR:"France",
    ZA:"South Africa",
    KE:"Kenya",
    GH:"Ghana",
    AE:"United Arab Emirates",
    SA:"Saudi Arabia",
    IN:"India",
    AU:"Australia",
    BR:"Brazil",
    MX:"Mexico",
    JP:"Japan",
    SG:"Singapore"
  };
  return map[c] || "";
}
function countryNameToISO(name){
  if(!name) return "";
  const raw = String(name).trim();
  if(/^[A-Za-z]{2}$/.test(raw)) return raw.toUpperCase();

  const n=normalizeCountryText(raw);

  const map={
    "nigeria":"NG",
    "ng":"NG",
    "nigerian":"NG",

    "united states":"US",
    "united states of america":"US",
    "usa":"US",
    "us":"US",
    "america":"US",

    "united kingdom":"GB",
    "great britain":"GB",
    "britain":"GB",
    "england":"GB",
    "uk":"GB",
    "gb":"GB",

    "canada":"CA",
    "germany":"DE",
    "france":"FR",
    "south africa":"ZA",
    "kenya":"KE",
    "ghana":"GH",

    "united arab emirates":"AE",
    "uae":"AE",
    "dubai":"AE",

    "saudi arabia":"SA",
    "india":"IN",
    "australia":"AU",
    "brazil":"BR",
    "mexico":"MX",
    "japan":"JP",
    "singapore":"SG"
  };

  if(map[n]) return map[n];
  for(const key of Object.keys(map)){
    if(n.includes(key)) return map[key];
  }
  return "";
}
async function detectCountryFromIP(){
  try{
    const res=await fetch("https://ipapi.co/json/");
    const data=await res.json();
    if(data?.country_code) return String(data.country_code).toUpperCase();
  }catch(e){}
  return "";
}
function detectCountryFromLocale(){
  try{
    const loc = (navigator.language || "").toUpperCase();
    const parts = loc.split("-");
    if(parts.length>=2 && /^[A-Z]{2}$/.test(parts[1])) return parts[1];
  }catch{}
  return "";
}
async function resolveCountryISO(countryNameFromDB){
  let iso = countryNameToISO(countryNameFromDB);
  if(iso) return iso;

  iso = await detectCountryFromIP();
  if(iso) return iso;

  iso = detectCountryFromLocale();
  if(iso) return iso;

  return "";
}

/* identity */
async function loadDashboardIdentity(){
  try{
    let fullName="", avatarUrl="", countryName="";
    const { data: row, error } = await supabaseClient
      .from("users")
      .select("full_name, avatar_url, country")
      .eq("email", currentUserEmail)
      .maybeSingle();
    if(!error && row){
      fullName=row.full_name||"";
      avatarUrl=row.avatar_url||"";
      countryName=row.country||"";
    }
    const md=(window.COINLUXORA_USER?.user_metadata||{});
    if(!fullName) fullName=md.full_name||"User";
    if(!avatarUrl) avatarUrl=md.avatar_url||"";

    setNameEverywhere(fullName);
    setTopAvatar(avatarUrl);
    setSideAvatar(avatarUrl);

    const iso = await resolveCountryISO(countryName);
    const niceName = (countryName && countryName.trim()) ? countryName.trim() : isoToCountryName(iso);
    setCountryChip(iso, niceName);
  }catch(e){
    setNameEverywhere("User");
    setTopAvatar("");
    setSideAvatar("");
    setCountryChip("");
  }
}

/* helpers */
function nfmt(n, dp=2){
  return Number(n).toLocaleString(undefined,{minimumFractionDigits:dp, maximumFractionDigits:dp});
}

/* ==============================
   ‚úÖ SEARCHABLE DROPDOWN (ALL ITEMS)
   ============================== */
function mountDropdown(elId, items, getLabel, getSearch, onPick, initial){
  const root=document.getElementById(elId);
  root.innerHTML = `
    <button class="ddBtn" type="button">
      <div class="ddLeft">
        <div class="ddIcon">‚óà</div>
        <div class="ddName">Select</div>
      </div>
      <div>‚ñæ</div>
    </button>

    <div class="ddPanel">
      <input class="ddSearch" placeholder="Search..." />
      <div class="ddList"></div>
    </div>
  `;

  const btn=root.querySelector(".ddBtn");
  const panel=root.querySelector(".ddPanel");
  const list=root.querySelector(".ddList");
  const search=root.querySelector(".ddSearch");
  const nameEl=root.querySelector(".ddName");

  let renderItems = items;

  function render(filter=""){
    const q=filter.trim().toLowerCase();
    if(!q){
      renderItems = items;
    }else{
      renderItems = items.filter(x => getSearch(x).includes(q));
    }

    const MAX = Math.min(renderItems.length, 600);
    const slice = renderItems.slice(0, MAX);

    list.innerHTML = slice.map(x => {
      const lab=getLabel(x);
      return `<div class="ddItem" data-id="${encodeURIComponent(JSON.stringify(x))}">
        <span>${lab}</span>
        <small>tap</small>
      </div>`;
    }).join("") || `<div class="ddItem"><span>No results</span></div>`;

    if(renderItems.length > MAX){
      const remain = renderItems.length - MAX;
      list.innerHTML += `<div class="ddItem" style="opacity:.7"><span>Scroll/search to narrow results (${remain} more)‚Ä¶</span></div>`;
    }
  }

  function setSelected(obj){
    nameEl.textContent = getLabel(obj);
    onPick(obj);
  }

  if(initial) setSelected(initial);
  render("");

  btn.addEventListener("click",(e)=>{
    e.stopPropagation();
    panel.classList.toggle("show");
    if(panel.classList.contains("show")){
      search.value="";
      render("");
      setTimeout(()=>search.focus(),40);
    }
  });

  search.addEventListener("input",()=>render(search.value));

  list.addEventListener("click",(e)=>{
    const item=e.target.closest(".ddItem");
    if(!item) return;
    const raw=item.getAttribute("data-id");
    if(!raw) return;
    try{
      const obj=JSON.parse(decodeURIComponent(raw));
      setSelected(obj);
      panel.classList.remove("show");
    }catch{}
  });

  document.addEventListener("click",(e)=>{
    if(!root.contains(e.target)) panel.classList.remove("show");
  });
}

/* ==============================
   ‚úÖ Load ALL COINS + ALL FIATS
   ============================== */
const FAVORITES = [
  { id:"bitcoin", label:"Bitcoin (BTC)", icon:"‚Çø", symbol:"btc" },
  { id:"ethereum", label:"Ethereum (ETH)", icon:"Œû", symbol:"eth" },
  { id:"tether", label:"Tether (USDT)", icon:"‚ÇÆ", symbol:"usdt" },
  { id:"binancecoin", label:"BNB (BNB)", icon:"‚óé", symbol:"bnb" },
  { id:"solana", label:"Solana (SOL)", icon:"‚ü†", symbol:"sol" },
  { id:"ripple", label:"XRP (XRP)", icon:"‚úï", symbol:"xrp" }
];

async function loadCoinGeckoLists(){
  try{
    const fiatRes = await fetch("https://api.coingecko.com/api/v3/simple/supported_vs_currencies");
    const fiats = await fiatRes.json();
    FIATS = (fiats || []).map(x => String(x).toUpperCase());
  }catch{
    FIATS = ["USD","NGN","EUR","GBP","CAD","AUD","JPY","CNY","INR"];
  }

  try{
    const coinRes = await fetch("https://api.coingecko.com/api/v3/coins/list?include_platform=false");
    const coins = await coinRes.json();

    const favMap = new Map(FAVORITES.map(f=>[f.id,f]));
    const list = [];
    for(const c of (coins||[])){
      if(!c?.id || !c?.name) continue;
      if(favMap.has(c.id)) continue;
      const sym = (c.symbol||"").toLowerCase();
      list.push({ id:c.id, label:`${c.name}${sym?` (${sym.toUpperCase()})`:""}`, icon:"‚óà", symbol:sym });
    }
    ALL_COINS = [...FAVORITES, ...list];
  }catch{
    ALL_COINS = [...FAVORITES];
  }

  const FIAT_ITEMS = FIATS.map(f => ({ id:f, label:f, icon:"$", symbol:f.toLowerCase() }));

  mountDropdown(
    "ddCryptoA",
    ALL_COINS,
    x=>x.label,
    x=>(`${x.label} ${x.symbol} ${x.id}`).toLowerCase(),
    x=>{ selectedCryptoA=x; },
    selectedCryptoA
  );

  mountDropdown(
    "ddCryptoB",
    FIAT_ITEMS,
    x=>x.label,
    x=>(`${x.label} ${x.id}`).toLowerCase(),
    x=>{ selectedCryptoB=x; },
    selectedCryptoB
  );

  mountDropdown(
    "ddFiatA",
    FIAT_ITEMS,
    x=>x.label,
    x=>(`${x.label} ${x.id}`).toLowerCase(),
    x=>{ selectedFiatA=x; },
    selectedFiatA
  );

  mountDropdown(
    "ddFiatB",
    FIAT_ITEMS,
    x=>x.label,
    x=>(`${x.label} ${x.id}`).toLowerCase(),
    x=>{ selectedFiatB=x; },
    selectedFiatB
  );

  await loadFxRates();
}

async function loadFxRates(){
  try{
    const res = await fetch("https://open.er-api.com/v6/latest/USD");
    const data = await res.json();
    if(data?.result !== "success") throw new Error("fx fail");
    FX_RATES = data.rates || {};
  }catch{
    FX_RATES = null;
  }
}

function swapCrypto(){
  cryptoDirection = (cryptoDirection === "crypto_to_fiat") ? "fiat_to_crypto" : "crypto_to_fiat";

  const tmp = selectedCryptoA;
  selectedCryptoA = selectedCryptoB;
  selectedCryptoB = tmp;

  const FIAT_ITEMS = FIATS.map(f => ({ id:f, label:f, icon:"$", symbol:f.toLowerCase() }));

  if(cryptoDirection === "crypto_to_fiat"){
    if(!selectedCryptoA?.id || typeof selectedCryptoA.id !== "string" || selectedCryptoA.id.length<=4){
      selectedCryptoA = FAVORITES[0];
    }
    if(!selectedCryptoB?.id || selectedCryptoB.id.length>4) selectedCryptoB = {id:"USD",label:"USD",icon:"$",symbol:"usd"};

    mountDropdown("ddCryptoA", ALL_COINS, x=>x.label, x=>(`${x.label} ${x.symbol} ${x.id}`).toLowerCase(), x=>{selectedCryptoA=x;}, selectedCryptoA);
    mountDropdown("ddCryptoB", FIAT_ITEMS, x=>x.label, x=>(`${x.label} ${x.id}`).toLowerCase(), x=>{selectedCryptoB=x;}, selectedCryptoB);

  }else{
    selectedCryptoA = {id:"USD",label:"USD",icon:"$",symbol:"usd"};
    if(!selectedCryptoB?.id || selectedCryptoB.id.length<=4) selectedCryptoB = FAVORITES[0];

    mountDropdown("ddCryptoA", FIAT_ITEMS, x=>x.label, x=>(`${x.label} ${x.id}`).toLowerCase(), x=>{selectedCryptoA=x;}, selectedCryptoA);
    mountDropdown("ddCryptoB", ALL_COINS, x=>x.label, x=>(`${x.label} ${x.symbol} ${x.id}`).toLowerCase(), x=>{selectedCryptoB=x;}, selectedCryptoB);
  }

  document.getElementById("cryptoRate").textContent="Rate: --";
  document.getElementById("cryptoResult").textContent="--";
  document.getElementById("cryptoReverse").textContent="--";
}

async function convertCrypto(){
  const amt = Number(document.getElementById("cryptoAmount").value || 0);
  if(!amt || amt<=0){
    document.getElementById("cryptoResult").textContent="--";
    document.getElementById("cryptoReverse").textContent="--";
    return;
  }

  try{
    if(cryptoDirection === "crypto_to_fiat"){
      const coinId = selectedCryptoA?.id || "bitcoin";
      const fiat   = String(selectedCryptoB?.id || "USD").toLowerCase();

      const url = `https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(coinId)}&vs_currencies=${encodeURIComponent(fiat)}`;
      const res = await fetch(url);
      const data = await res.json();
      const rate = Number(data?.[coinId]?.[fiat] || 0);
      if(!rate) throw new Error("rate missing");

      const result = rate * amt;
      document.getElementById("cryptoRate").textContent = `Rate: 1 ${selectedCryptoA.label} = ${nfmt(rate,6)} ${fiat.toUpperCase()}`;
      document.getElementById("cryptoResult").textContent = `${nfmt(result,2)} ${fiat.toUpperCase()}`;
      document.getElementById("cryptoReverse").textContent = `1 ${fiat.toUpperCase()} ‚âà ${(1/rate).toFixed(10)} ${selectedCryptoA.symbol?.toUpperCase()||coinId}`;

    }else{
      const fiat = String(selectedCryptoA?.id || "USD").toLowerCase();
      const coinId = selectedCryptoB?.id || "bitcoin";

      const url = `https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(coinId)}&vs_currencies=${encodeURIComponent(fiat)}`;
      const res = await fetch(url);
      const data = await res.json();
      const rate = Number(data?.[coinId]?.[fiat] || 0);
      if(!rate) throw new Error("rate missing");

      const cryptoAmount = amt / rate;
      document.getElementById("cryptoRate").textContent = `Rate: 1 ${selectedCryptoB.label} = ${nfmt(rate,6)} ${fiat.toUpperCase()}`;
      document.getElementById("cryptoResult").textContent = `${cryptoAmount.toFixed(10)} ${selectedCryptoB.symbol?.toUpperCase()||coinId}`;
      document.getElementById("cryptoReverse").textContent = `1 ${selectedCryptoB.symbol?.toUpperCase()||coinId} ‚âà ${nfmt(rate,6)} ${fiat.toUpperCase()}`;
    }
  }catch(e){
    document.getElementById("cryptoRate").textContent="Rate: unavailable (network)";
    document.getElementById("cryptoResult").textContent="--";
    document.getElementById("cryptoReverse").textContent="--";
  }
}

function swapFiat(){
  const tmp = selectedFiatA;
  selectedFiatA = selectedFiatB;
  selectedFiatB = tmp;

  const FIAT_ITEMS = FIATS.map(f => ({ id:f, label:f, icon:"$", symbol:f.toLowerCase() }));
  mountDropdown("ddFiatA", FIAT_ITEMS, x=>x.label, x=>(`${x.label} ${x.id}`).toLowerCase(), x=>{selectedFiatA=x;}, selectedFiatA);
  mountDropdown("ddFiatB", FIAT_ITEMS, x=>x.label, x=>(`${x.label} ${x.id}`).toLowerCase(), x=>{selectedFiatB=x;}, selectedFiatB);

  document.getElementById("fiatRate").textContent="Rate: --";
  document.getElementById("fiatResult").textContent="--";
}

async function convertFiat(){
  const amt = Number(document.getElementById("fiatAmount").value || 0);
  if(!amt || amt<=0){
    document.getElementById("fiatResult").textContent="--";
    return;
  }

  const from = String(selectedFiatA?.id || "USD").toUpperCase();
  const to   = String(selectedFiatB?.id || "NGN").toUpperCase();

  try{
    if(!FX_RATES) await loadFxRates();
    if(!FX_RATES) throw new Error("fx missing");

    const fromRate = Number(FX_RATES[from] || 0);
    const toRate   = Number(FX_RATES[to] || 0);
    if(!fromRate || !toRate) throw new Error("rate missing");

    const usdAmount = amt / fromRate;
    const result = usdAmount * toRate;
    const rate = toRate / fromRate;

    document.getElementById("fiatRate").textContent = `Rate: 1 ${from} = ${nfmt(rate,6)} ${to}`;
    document.getElementById("fiatResult").textContent = `${nfmt(result,2)} ${to}`;
  }catch(e){
    document.getElementById("fiatRate").textContent="Rate: unavailable (network)";
    document.getElementById("fiatResult").textContent="--";
  }
}

function parsePairForProviders(pair){
  const base=pair.replace("USDT","").replace("USD","");
  return {
    binance: pair,
    okx: `${base}-USDT`,
    bybit: `${base}USDT`
  };
}

async function tryBinanceOrderBook(symbol){
  const res = await fetch(`https://api.binance.com/api/v3/depth?symbol=${encodeURIComponent(symbol)}&limit=20`);
  const data = await res.json();
  if(!data?.asks || !data?.bids) throw new Error("binance invalid");
  return { asks:data.asks, bids:data.bids, source:"Binance" };
}

async function tryOKXOrderBook(instId){
  const res = await fetch(`https://www.okx.com/api/v5/market/books?instId=${encodeURIComponent(instId)}&sz=20`);
  const data = await res.json();
  const book = data?.data?.[0];
  if(!book?.asks || !book?.bids) throw new Error("okx invalid");
  return { asks:book.asks, bids:book.bids, source:"OKX" };
}

async function tryBybitOrderBook(symbol){
  const res = await fetch(`https://api.bybit.com/v5/market/orderbook?category=spot&symbol=${encodeURIComponent(symbol)}&limit=20`);
  const data = await res.json();
  const book = data?.result;
  if(!book?.a || !book?.b) throw new Error("bybit invalid");
  return { asks:book.a, bids:book.b, source:"Bybit" };
}

async function loadOrderBook(force=false){
  const pair=document.getElementById("obPair").value;
  const asksEl=document.getElementById("asks");
  const bidsEl=document.getElementById("bids");
  const meta=parsePairForProviders(pair);

  if(force){
    asksEl.innerHTML="<div class='obItem'>Loading‚Ä¶</div>";
    bidsEl.innerHTML="<div class='obItem'>Loading‚Ä¶</div>";
  }

  try{
    let book=null;

    try{ book = await tryBinanceOrderBook(meta.binance); }
    catch(e1){
      try{ book = await tryOKXOrderBook(meta.okx); }
      catch(e2){
        book = await tryBybitOrderBook(meta.bybit);
      }
    }

    const asks=(book.asks||[]).slice(0,20);
    const bids=(book.bids||[]).slice(0,20);

    const aNorm = asks.map(x => [x[0], x[1]]);
    const bNorm = bids.map(x => [x[0], x[1]]);

    asksEl.innerHTML=aNorm.map(a=>`<div class="obItem"><span>${Number(a[0]).toLocaleString()}</span><span>${Number(a[1]).toFixed(6)}</span></div>`).join("") || "<div class='obItem'>No asks</div>";
    bidsEl.innerHTML=bNorm.map(b=>`<div class="obItem"><span>${Number(b[0]).toLocaleString()}</span><span>${Number(b[1]).toFixed(6)}</span></div>`).join("") || "<div class='obItem'>No bids</div>";

  }catch(e){
    asksEl.innerHTML="<div class='obItem'>Order book blocked / unavailable</div>";
    bidsEl.innerHTML="<div class='obItem'>Try changing pair</div>";
  }
}

function startOrderAutoRefresh(){
  if(orderTimer) clearInterval(orderTimer);
  orderTimer=setInterval(()=>loadOrderBook(false), 3000);
}

function loadChart(){
  const pair=document.getElementById("obPair").value;
  const base=pair.replace("USDT","").toUpperCase();
  const tvSymbol = `BINANCE:${base}USDT`;
  document.getElementById("chartPair").textContent = `${base}/USDT`;
  const frame=document.getElementById("tvChart");
  frame.src = `https://s.tradingview.com/widgetembed/?frameElementId=tradingview_chart&symbol=${encodeURIComponent(tvSymbol)}&interval=60&hidesidetoolbar=1&symboledit=1&saveimage=1&toolbarbg=rgba(0,0,0,0)&studies=[]&theme=dark&style=1&timezone=Etc/UTC&withdateranges=1&hideideas=1`;
}
document.getElementById("obPair").addEventListener("change",()=>{
  loadOrderBook(true);
  loadChart();
});

async function loadBalance(){
  const { data } = await supabaseClient.from("users").select("*").eq("email", currentUserEmail).single();
  const balNum = Number(data?.balance || 0);
  const bal = balNum.toLocaleString(undefined,{ minimumFractionDigits:2, maximumFractionDigits:2 });
  document.getElementById("balance").innerHTML = "$" + bal;
}
function money(n){ return "$" + Number(n||0).toFixed(2); }
function pill(status){
  const s=(status||"pending").toLowerCase();
  return `<span style="padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.08);font-weight:1000;font-size:12px">${s}</span>`;
}
function daysBetween(date1, date2){
  const d1=new Date(date1);
  const d2=new Date(date2);
  const diff=(d2 - d1) / (1000*60*60*24);
  return Math.max(0, Math.ceil(diff));
}
async function loadActivePlan(){
  const planMsg=document.getElementById("planMsg");
  const planBox=document.getElementById("planBox");

  const { data, error } = await supabaseClient
    .from("investment_plans")
    .select("*")
    .eq("user_email", currentUserEmail)
    .order("created_at",{ascending:false})
    .limit(1);

  if(error){
    planMsg.innerHTML="<span class='err'>"+error.message+"</span>";
    planBox.innerHTML="";
    return;
  }

  if(!data || data.length===0){
    planMsg.innerHTML="<span class='err'>No investment plan started yet.</span>";
    planBox.innerHTML=`<div class="small">Go to <a style="color:#9bdcff;font-weight:1000" href="plans.html">Investment Plans</a> to start.</div>`;
    return;
  }

  planMsg.innerHTML="";
  const plan=data[0];
  const amount=Number(plan.amount||0);
  const roi=Number(plan.roi_percent||0);
  const expected=amount+(amount*(roi/100));

  let daysLeft="--";
  if(plan.duration_days && plan.created_at){
    const start=new Date(plan.created_at);
    const end=new Date(start);
    end.setDate(end.getDate()+Number(plan.duration_days||0));
    daysLeft = daysBetween(new Date(), end);
  }

  planBox.innerHTML=`
    <div class="card">
      <strong>${plan.plan_name} Plan</strong> ${pill(plan.status)}
      <div class="small" style="margin-top:10px">Amount: <strong>${money(amount)}</strong></div>
      <div class="small">ROI: <strong>${roi}%</strong></div>
      <div class="small">Duration: <strong>${plan.duration_days} days</strong></div>
      <div class="small">Expected Return: <strong>${money(expected)}</strong></div>
      <div class="small">Days remaining: <strong>${daysLeft}</strong></div>
      ${plan.admin_note ? `<div class="small">Admin note: <strong>${plan.admin_note}</strong></div>` : ""}
    </div>
  `;
}

function setBadge(elId, count){
  const el=document.getElementById(elId);
  if(!el) return;
  const n=Number(count||0);
  if(n<=0) el.style.display="none";
  else { el.style.display="flex"; el.innerText = n>99?"99+":String(n); }
}
function setBadgeFromKey(key,val){
  if(key==="deposits") setBadge("badgeDepositDock", val);
  else if(key==="withdrawals") setBadge("badgeWithdrawDock", val);
}
async function loadRealtimeBadgesOnce(){
  if(!currentUserId) return;
  setBadge("badgeDepositDock", 0);
  setBadge("badgeWithdrawDock", 0);

  const { data, error } = await supabaseClient
    .from("user_badges")
    .select("badge_key, badge_value")
    .eq("user_id", currentUserId);

  if(error) return;
  (data || []).forEach(row => setBadgeFromKey(row.badge_key, row.badge_value));
}
function subscribeToRealtimeBadges(){
  if(!currentUserId) return;
  if(badgeChannel){
    supabaseClient.removeChannel(badgeChannel);
    badgeChannel=null;
  }
  badgeChannel = supabaseClient
    .channel("realtime-user-badges-dashboard")
    .on("postgres_changes", {
      event: "*",
      schema: "public",
      table: "user_badges",
      filter: `user_id=eq.${currentUserId}`
    }, payload => {
      const row = payload.new;
      if(!row) return;
      setBadgeFromKey(row.badge_key, row.badge_value);
    })
    .subscribe();
}
async function clearBadge(badge_key){
  try{
    const { data: sessionData } = await supabaseClient.auth.getSession();
    const accessToken = sessionData?.session?.access_token;
    if(!accessToken) return;

    await fetch(EDGE_CLEAR_BADGE_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${accessToken}`,
        "apikey": SUPABASE_ANON_KEY
      },
      body: JSON.stringify({ badge_key })
    });
  }catch(e){}
}

async function logout(){
  await supabaseClient.auth.signOut();
  window.location.replace("login.html");
}

function initWithUser(user){
  currentUserEmail=user.email;
  currentUserId=user.id;

  setGreeting();
  startClock();
  document.getElementById("userIdChip").innerText = "ID: " + currentUserId.slice(0,6).toUpperCase();

  hideGate();
  loadDashboardIdentity();

  loadBalance();
  loadActivePlan();
  loadRealtimeBadgesOnce();
  subscribeToRealtimeBadges();

  loadTop10MajorCryptos();
  startTop10AutoRefresh();

  loadAllMarkets();
  startMarketAutoRefresh();

  loadCoinGeckoLists().then(async ()=>{
    await loadOrderBook(true);
    loadChart();
    startOrderAutoRefresh();
  });
}
</script>

</body>
</html>
