<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Coinluxora User Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#020617;color:#e5e7eb;padding:16px;padding-bottom:90px}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid #1e293b;margin-bottom:14px}
button{border:none;padding:10px 14px;border-radius:10px;font-weight:900;cursor:pointer;background:#38bdf8;color:#020617}
.menuBtn{background:#0b1224;color:#e5e7eb;border:1px solid #1e293b}
.box{border:1px solid #1e293b;border-radius:12px;padding:14px;background:#020617;margin-bottom:14px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.card{border:1px solid #1e293b;border-radius:12px;padding:10px}
h2{margin:0;font-size:18px}
.small{color:#94a3b8;font-size:12px;margin-top:6px}
.ok{color:#22c55e}
.err{color:#f87171}
input,select{width:100%;padding:12px;margin-bottom:10px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb}
a{color:#38bdf8;text-decoration:none;font-weight:1000}
a:hover{text-decoration:underline}
.pill{padding:6px 10px;border-radius:999px;font-weight:1000;font-size:12px;display:inline-block}
.pending{background:#facc15;color:#020617}
.active{background:#38bdf8;color:#020617}
.completed{background:#22c55e;color:#020617}
.rejected{background:#f87171;color:#020617}

/* SIDEBAR */
.overlay{position:fixed; inset:0;background:rgba(0,0,0,.65);display:none; z-index:999;backdrop-filter: blur(4px);}
.sidebar{position:fixed; top:0; left:-290px;width:270px; height:100vh;background:#020617;border-right:1px solid #1e293b;padding:16px;transition:.28s ease;z-index:1000;box-shadow:0 20px 80px rgba(0,0,0,.6);}
.sidebar.open{ left:0; }
.overlay.show{ display:block; }

.brandRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.brand{font-weight:1000;font-size:18px;letter-spacing:.6px;}
.closeBtn{background:#0b1224;border:1px solid #1e293b;color:#e5e7eb;border-radius:10px;padding:8px 12px;}
.userTag{padding:10px;border-radius:12px;border:1px solid #1e293b;background:#0b1224;margin-bottom:12px;}
.sideItem{display:flex;gap:10px;align-items:center;padding:12px;border:1px solid #1e293b;border-radius:12px;margin-bottom:10px;color:#e5e7eb;background:#0b1224;}
.sideItem:hover{background:#0f1a33}
.activeLink{border:1px solid #38bdf8;background:rgba(56,189,248,0.12);}
.sideLogout{background:#f87171;color:#020617;border:none;width:100%;padding:12px;border-radius:12px;font-weight:1000}

/* BOTTOM NAV */
.bottomNav{
  position:fixed;left:0;right:0;bottom:0;
  height:72px;
  background:#020617;
  border-top:1px solid #1e293b;
  display:flex;
  justify-content:space-around;
  align-items:center;
  z-index:1200;
  padding:6px 10px;
}
.navItem{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  color:#94a3b8;
  font-size:12px;
  font-weight:900;
  padding:8px 0;
  border-radius:14px;
  cursor:pointer;
}
.navItem span{font-size:18px;margin-bottom:4px}
.navActive{color:#38bdf8;background:rgba(56,189,248,0.10)}
</style>
</head>

<body>

<!-- OVERLAY + SIDEBAR -->
<div id="overlay" class="overlay" onclick="closeMenu()"></div>

<div id="sidebar" class="sidebar">
  <div class="brandRow">
    <div class="brand">COINLUXORA</div>
    <button class="closeBtn" onclick="closeMenu()">‚úï</button>
  </div>

  <div class="userTag">
    <div class="small">Logged in as</div>
    <div id="sideEmail" style="font-weight:1000;margin-top:6px;">---</div>
  </div>

  <a class="sideItem activeLink" href="user-dashboard.html">üè† Dashboard</a>
  <a class="sideItem" href="portfolio.html">üìä Portfolio</a>
  <a class="sideItem" href="plans.html">üíº Investment Plans</a>
  <a class="sideItem" href="support.html">üßë‚Äçüíª Support / Contact</a>
  <a class="sideItem" href="deposits.html">üìå Deposits History</a>
  <a class="sideItem" href="withdraw.html">‚û° Withdraw Funds</a>
  <a class="sideItem" href="withdrawals.html">üìå Withdrawals History</a>

  <div style="height:12px"></div>
  <button class="sideLogout" onclick="logout()">Logout</button>
</div>

<header>
  <button class="menuBtn" onclick="openMenu()">‚ò∞</button>
  <strong>User Dashboard</strong>
  <button onclick="logout()">Logout</button>
</header>

<div class="box">
  <h2>Welcome</h2>
  <div id="email" class="small">Loading‚Ä¶</div>
</div>

<div class="box">
  <h2>Balance</h2>
  <div id="balance" style="font-size:26px;font-weight:1000;margin-top:8px;">--</div>
  <div class="small">Your trading account balance</div>
</div>

<div class="box">
  <h2>Active Investment Plan</h2>
  <div id="planMsg" class="small">Loading‚Ä¶</div>
  <div id="planBox"></div>
</div>

<div class="box">
  <h2>Live Crypto Prices</h2>
  <div class="grid" id="prices">
    <div class="card">Loading‚Ä¶</div>
  </div>
</div>

<div class="box" id="depositSection">
  <h2>Deposit</h2>
  <div class="small">Select asset/network to see wallet address</div>

  <select id="depAsset" onchange="renderDepositAddress()">
    <option value="btc">BTC</option>
    <option value="eth">ETH</option>
    <option value="usdt">USDT</option>
  </select>

  <select id="depNetwork" onchange="renderDepositAddress()">
    <option value="BTC">BTC</option>
    <option value="ERC20">ERC20</option>
    <option value="TRC20">TRC20</option>
  </select>

  <div class="card">
    <div class="small">Deposit Address</div>
    <div id="depAddress" style="margin-top:8px;font-weight:1000;">--</div>
    <button style="margin-top:10px;width:100%;background:#22c55e" onclick="copyAddress()">Copy Address</button>
  </div>
</div>

<div class="box">
  <h2>Submit Deposit Proof</h2>
  <div class="small">After depositing, submit confirmation</div>

  <select id="confAsset">
    <option value="btc">BTC</option>
    <option value="eth">ETH</option>
    <option value="usdt">USDT</option>
  </select>

  <select id="confNetwork">
    <option value="BTC">BTC</option>
    <option value="ERC20">ERC20</option>
    <option value="TRC20">TRC20</option>
  </select>

  <input id="confAmount" type="number" step="0.01" placeholder="Amount deposited"/>
  <input id="confTx" placeholder="Transaction hash"/>
  <input id="confProof" type="file" accept="image/*,.pdf"/>

  <button style="width:100%;background:#22c55e" onclick="submitDeposit()">Submit Deposit</button>
  <div id="depMsg" class="small"></div>
</div>

<!-- BOTTOM NAV -->
<div class="bottomNav">
  <div class="navItem navActive" onclick="goHome()"><span>üè†</span>Home</div>
  <div class="navItem" onclick="goDeposit()"><span>üí≥</span>Deposit</div>
  <div class="navItem" onclick="goWithdraw()"><span>‚û°</span>Withdraw</div>
  <div class="navItem" onclick="goPlans()"><span>üíº</span>Plans</div>
  <div class="navItem" onclick="goSupport()"><span>üßë‚Äçüíª</span>Support</div>
</div>

<script>
const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
const BUCKET_NAME="proofs";

let currentUserEmail="";
let depositAddresses=[];

init();

/* NAV FUNCTIONS */
function goHome(){ window.scrollTo({top:0,behavior:"smooth"}); }
function goDeposit(){ document.getElementById("depositSection").scrollIntoView({behavior:"smooth"}); }
function goWithdraw(){ window.location.href="withdraw.html"; }
function goPlans(){ window.location.href="plans.html"; }
function goSupport(){ window.location.href="support.html"; }

function openMenu(){
  document.getElementById("sidebar").classList.add("open");
  document.getElementById("overlay").classList.add("show");
}
function closeMenu(){
  document.getElementById("sidebar").classList.remove("open");
  document.getElementById("overlay").classList.remove("show");
}

function money(n){ return "$" + Number(n||0).toFixed(2); }
function pill(status){
  const s=(status||"pending").toLowerCase();
  return `<span class="pill ${s}">${s}</span>`;
}
function daysBetween(date1, date2){
  const d1=new Date(date1);
  const d2=new Date(date2);
  const diff=(d2 - d1) / (1000*60*60*24);
  return Math.max(0, Math.ceil(diff));
}

async function init(){
  const { data:userData } = await supabaseClient.auth.getUser();
  if(!userData.user){
    document.body.innerHTML="<h2 style='color:white'>You must login first.</h2>";
    return;
  }

  currentUserEmail=userData.user.email;
  document.getElementById("email").innerHTML=`Logged in as: <span class="ok">${currentUserEmail}</span>`;
  document.getElementById("sideEmail").innerText=currentUserEmail;

  await loadBalance();
  await loadActivePlan();
  await loadDepositAddresses();
  renderDepositAddress();
  fetchPrices();
}

async function loadBalance(){
  const { data } = await supabaseClient.from("users").select("*").eq("email", currentUserEmail).single();
  document.getElementById("balance").innerHTML = Number(data?.balance || 0).toFixed(2);
}

async function loadActivePlan(){
  const planMsg=document.getElementById("planMsg");
  const planBox=document.getElementById("planBox");

  const { data, error } = await supabaseClient
    .from("investment_plans")
    .select("*")
    .eq("user_email", currentUserEmail)
    .order("created_at",{ascending:false})
    .limit(1);

  if(error){
    planMsg.innerHTML="<span class='err'>"+error.message+"</span>";
    planBox.innerHTML="";
    return;
  }

  if(!data || data.length===0){
    planMsg.innerHTML="<span class='err'>No investment plan started yet.</span>";
    planBox.innerHTML=`<div class="small">Go to <a href="plans.html">Investment Plans</a> to start.</div>`;
    return;
  }

  const plan=data[0];
  const amount=Number(plan.amount||0);
  const roi=Number(plan.roi_percent||0);
  const expected=amount+(amount*(roi/100));

  let daysLeft="--";
  if(plan.duration_days && plan.created_at){
    const start=new Date(plan.created_at);
    const end=new Date(start);
    end.setDate(end.getDate()+Number(plan.duration_days||0));
    daysLeft = daysBetween(new Date(), end);
  }

  planMsg.innerHTML="<span class='ok'>Plan details loaded ‚úÖ</span>";
  planBox.innerHTML=`
    <div class="card">
      <strong>${plan.plan_name} Plan</strong> ${pill(plan.status)}
      <div class="small" style="margin-top:10px">Amount: <strong>${money(amount)}</strong></div>
      <div class="small">ROI: <strong>${roi}%</strong></div>
      <div class="small">Duration: <strong>${plan.duration_days} days</strong></div>
      <div class="small">Expected Return: <strong>${money(expected)}</strong></div>
      <div class="small">Days remaining: <strong>${daysLeft}</strong></div>
      ${plan.admin_note ? `<div class="small">Admin note: <strong>${plan.admin_note}</strong></div>` : ""}
    </div>
  `;
}

async function loadDepositAddresses(){
  const { data } = await supabaseClient.from("deposit_addresses").select("asset,network,address");
  depositAddresses = data || [];
}

function renderDepositAddress(){
  const asset=document.getElementById("depAsset").value.toLowerCase();
  const network=document.getElementById("depNetwork").value.toUpperCase();
  const found=depositAddresses.find(d =>
    (d.asset||"").toLowerCase()===asset &&
    (d.network||"").toUpperCase()===network
  );
  document.getElementById("depAddress").innerText = found ? found.address : "No address configured";
}

function copyAddress(){
  const addr=document.getElementById("depAddress").innerText;
  navigator.clipboard.writeText(addr);
  alert("Copied ‚úÖ");
}

async function fetchPrices(){
  try{
    const res=await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,tether&vs_currencies=usd");
    const data=await res.json();
    document.getElementById("prices").innerHTML=`
      <div class="card"><strong>BTC</strong><br>$${data.bitcoin.usd}</div>
      <div class="card"><strong>ETH</strong><br>$${data.ethereum.usd}</div>
      <div class="card"><strong>USDT</strong><br>$${data.tether.usd}</div>
    `;
  }catch{
    document.getElementById("prices").innerHTML="<div class='card err'>Failed to load prices</div>";
  }
}

async function submitDeposit(){
  const msg=document.getElementById("depMsg");
  msg.innerHTML="Submitting‚Ä¶";

  const asset=document.getElementById("confAsset").value;
  const network=document.getElementById("confNetwork").value;
  const amount=Number(document.getElementById("confAmount").value||0);
  const tx_hash=document.getElementById("confTx").value.trim();
  const file=document.getElementById("confProof").files[0];

  if(amount<=0 || tx_hash.length<5 || !file){
    msg.innerHTML="<span class='err'>Fill all fields + upload proof</span>";
    return;
  }

  const filePath = `${currentUserEmail}/${Date.now()}-${file.name}`;
  const upload = await supabaseClient.storage.from(BUCKET_NAME).upload(filePath,file);

  if(upload.error){
    msg.innerHTML="<span class='err'>Upload failed: "+upload.error.message+"</span>";
    return;
  }

  const proof_url = `${BUCKET_NAME}/${filePath}`;

  const res = await supabaseClient.from("deposit_confirmations").insert([{
    user_email: currentUserEmail,
    asset, network, amount, tx_hash,
    proof_url,
    status: "pending"
  }]);

  if(res.error){
    msg.innerHTML="<span class='err'>"+res.error.message+"</span>";
    return;
  }

  msg.innerHTML="<span class='ok'>Deposit submitted ‚úÖ</span>";
  document.getElementById("confAmount").value="";
  document.getElementById("confTx").value="";
  document.getElementById("confProof").value="";
}

async function logout(){
  await supabaseClient.auth.signOut();
  window.location.href="login.html";
}
</script>

</body>
</html>
