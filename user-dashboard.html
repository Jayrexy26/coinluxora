<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coinluxora User Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#050a18;
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(255,255,255,.12);
      --card:rgba(255,255,255,.04);
      --card2:rgba(255,255,255,.06);
      --txt:rgba(255,255,255,.90);
      --muted:rgba(255,255,255,.65);
      --muted2:rgba(255,255,255,.45);
      --brand:#4da3ff;
      --good:#27e0a4;
      --bad:#ff4d6d;
      --shadow:0 20px 50px rgba(0,0,0,.45);
      --radius:18px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(1200px 800px at 20% -10%, rgba(77,163,255,.18), transparent 45%),
                 radial-gradient(900px 600px at 80% 10%, rgba(39,224,164,.12), transparent 55%),
                 var(--bg);
      color:var(--txt);
      min-height:100vh;
      overflow-x:hidden;
    }

    /* =========================
       AUTH GUARD (SUPABASE)
       ========================= */
    .authCover{
      position:fixed; inset:0;
      background:linear-gradient(180deg, rgba(5,10,24,.98), rgba(5,10,24,.92));
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999999;
    }
    .authBox{
      width:min(520px, 92vw);
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius:22px;
      padding:26px 22px;
      box-shadow:var(--shadow);
    }
    .authBox h2{font-size:20px;margin-bottom:8px}
    .authBox p{color:var(--muted);font-size:13px;line-height:1.5;margin-bottom:16px}
    .authBox input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      color:var(--txt);
      outline:none;
      margin-bottom:10px;
    }
    .authActions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      padding:11px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      transition:.18s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.10)}
    .btn.brand{background:rgba(77,163,255,.18);border-color:rgba(77,163,255,.35)}
    .btn.brand:hover{background:rgba(77,163,255,.26)}
    .authMsg{margin-top:12px;font-size:13px;color:var(--muted)}
    .hidden{display:none !important}

    /* =========================
       TOP BAR
       ========================= */
    header{
      position:sticky;
      top:0;
      z-index:2000;
      backdrop-filter: blur(10px);
      background:rgba(5,10,24,.60);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 18px;
      gap:12px;
    }
    .brandRow{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .logo{
      width:38px;height:38px;border-radius:14px;
      background:linear-gradient(135deg, rgba(77,163,255,.9), rgba(39,224,164,.85));
      box-shadow:0 12px 30px rgba(77,163,255,.22);
      flex:0 0 auto;
    }
    .brandText{min-width:0}
    .brandText h1{
      font-size:16px;
      letter-spacing:.3px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:260px;
    }
    .brandText span{color:var(--muted);font-size:12px}
    .topRight{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
    }
    .pill{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .menuBtn{
      width:44px;height:44px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      display:grid;
      place-items:center;
      transition:.18s ease;
    }
    .menuBtn:hover{transform:translateY(-1px);background:rgba(255,255,255,.10)}
    .bars{
      width:18px;height:12px;
      position:relative;
    }
    .bars:before,.bars:after,.bars div{
      content:"";
      position:absolute; left:0; right:0;
      height:2px;border-radius:2px;
      background:rgba(255,255,255,.85);
    }
    .bars:before{top:0}
    .bars div{top:5px;opacity:.85}
    .bars:after{bottom:0;opacity:.7}

    /* =========================
       LAYOUT
       ========================= */
    .container{
      padding:18px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
      max-width:1320px;
      margin:0 auto;
    }

    /* =========================
       SIDEBAR (DESKTOP)
       ========================= */
    aside{
      position:sticky;
      top:82px;
      align-self:start;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px;
      padding:16px;
      height: calc(100vh - 110px);
      overflow:auto;
    }
    .sideTitle{
      font-size:12px;
      letter-spacing:.12em;
      color:var(--muted2);
      margin-bottom:10px;
      text-transform:uppercase;
    }
    .nav{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding-bottom:12px;
    }
    .nav a{
      text-decoration:none;
      color:rgba(255,255,255,.80);
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:space-between;
      transition:.18s ease;
      font-size:13px;
    }
    .nav a:hover{background:rgba(255,255,255,.08);transform:translateY(-1px)}
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(77,163,255,.18);
      border:1px solid rgba(77,163,255,.35);
      color:rgba(255,255,255,.85);
    }

    /* =========================
       MAIN CONTENT
       ========================= */
    main{
      min-width:0;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
    }

    .card{
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px;
      padding:16px;
      box-shadow:0 18px 40px rgba(0,0,0,.25);
      min-width:0;
    }
    .cardHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px
    }
    .cardHead h2{
      font-size:14px;
      letter-spacing:.2px;
      color:rgba(255,255,255,.88);
    }
    .subtxt{color:var(--muted);font-size:12px}

    /* mini chart */
    .miniChart{
      height:220px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(77,163,255,.10), rgba(0,0,0,.18));
      overflow:hidden;
      position:relative;
    }
    canvas{display:block;width:100%;height:100%}

    /* order book */
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:12px;
    }
    select, input[type="search"]{
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.24);
      color:rgba(255,255,255,.85);
      outline:none;
      font-size:13px;
      min-width:160px;
    }

    .obWrap{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .obCol{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.20);
      overflow:hidden;
      min-width:0;
    }
    .obTop{
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
    }
    .obList{
      max-height:300px;
      overflow:auto;
      padding:10px 10px 12px;
    }
    .obRow{
      position:relative;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:8px;
      padding:8px 8px;
      border-radius:12px;
      margin-bottom:6px;
      font-size:12px;
      color:rgba(255,255,255,.85);
      border:1px solid rgba(255,255,255,.06);
      background:rgba(255,255,255,.03);
      overflow:hidden;
    }
    .fillbar{
      position:absolute; top:0; bottom:0;
      opacity:.35;
      pointer-events:none;
      border-radius:12px;
      filter: blur(0px);
    }
    .fillbar.buy{left:0;background:linear-gradient(90deg, rgba(39,224,164,.45), rgba(39,224,164,0))}
    .fillbar.sell{right:0;background:linear-gradient(270deg, rgba(255,77,109,.45), rgba(255,77,109,0))}
    .good{color:rgba(39,224,164,.95)}
    .bad{color:rgba(255,77,109,.95)}
    .centerPrice{
      text-align:center;
      margin-top:12px;
      padding:10px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(77,163,255,.08);
      color:rgba(255,255,255,.92);
      font-weight:700;
    }

    /* top 10 list after orderbook */
    .coinGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      margin-top:14px;
    }
    .coinItem{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.20);
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .coinL{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .coinL b{
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .coinL span{font-size:12px;color:var(--muted)}
    .coinR{
      text-align:right;
      font-size:12px;
      color:rgba(255,255,255,.85);
      min-width:80px;
    }

    /* =========================
       MOBILE MENU OVERLAY
       FIXED: MENU MUST OVERLAY TOP BAR
       ========================= */
    .overlay{
      position:fixed;
      inset:0;
      z-index:99990;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
    }
    .overlay.active{display:block}

    .mobileMenu{
      position:fixed;
      top:0;
      left:0;
      height:100vh;
      width:min(330px, 86vw);
      z-index:99999; /* IMPORTANT: above header */
      transform:translateX(-105%);
      transition:.22s ease;
      background:rgba(6,12,28,.98);
      border-right:1px solid rgba(255,255,255,.10);
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
    }
    .mobileMenu.active{transform:translateX(0)}
    .mHead{
      padding:18px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex:0 0 auto;
    }
    .mHead b{font-size:13px;color:rgba(255,255,255,.88)}
    .closeBtn{
      width:40px;height:40px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      display:grid;
      place-items:center;
    }

    /* THIS is the real fix for "can't see bottom menu items"
       scrollable menu content inside the drawer */
    .mBody{
      padding:14px;
      overflow:auto;        /* scroll enabled */
      -webkit-overflow-scrolling:touch;
      flex:1 1 auto;
    }
    .mBody .nav a{background:rgba(255,255,255,.04)}

    /* =========================
       RESPONSIVE
       ========================= */
    @media (max-width: 980px){
      .container{grid-template-columns: 1fr}
      aside{display:none}
      .grid2{grid-template-columns:1fr}
      .coinGrid{grid-template-columns:1fr}
    }

  </style>
</head>

<body>

  <!-- AUTH COVER -->
  <div id="authCover" class="authCover hidden">
    <div class="authBox">
      <h2>Coinluxora Login</h2>
      <p>Please sign in. If you just registered, check your email to verify your account first.</p>

      <input id="authEmail" type="email" placeholder="Email"/>
      <input id="authPass" type="password" placeholder="Password"/>

      <div class="authActions">
        <button class="btn brand" id="btnLogin">Login</button>
        <button class="btn" id="btnSignup">Sign Up</button>
        <button class="btn" id="btnResend">Resend Verification</button>
      </div>

      <div class="authMsg" id="authMsg"></div>
    </div>
  </div>

  <!-- MOBILE OVERLAY + MENU -->
  <div id="overlay" class="overlay"></div>
  <div id="mobileMenu" class="mobileMenu">
    <div class="mHead">
      <b>Menu</b>
      <button id="closeMenu" class="closeBtn">✕</button>
    </div>

    <div class="mBody">
      <div class="sideTitle">Navigation</div>
      <div class="nav">
        <a href="#dashboard">Dashboard <span class="badge">Live</span></a>
        <a href="#orderbook">Order Book</a>
        <a href="#topcoins">Top Coins</a>
        <a href="#news">News</a>
        <a href="#profile">Profile</a>
        <a href="#settings">Settings</a>
        <a href="#support">Support</a>
      </div>

      <div class="sideTitle">Account</div>
      <div class="nav">
        <a href="javascript:void(0)" id="logoutBtnM">Logout</a>
      </div>
    </div>
  </div>

  <!-- TOP BAR -->
  <header>
    <div class="topbar">
      <div class="brandRow">
        <div class="logo"></div>
        <div class="brandText">
          <h1>Coinluxora Dashboard</h1>
          <span>Live crypto insights</span>
        </div>
      </div>

      <div class="topRight">
        <div class="pill" id="userPill">Not signed in</div>
        <button class="menuBtn" id="openMenu" aria-label="Open menu">
          <div class="bars"><div></div></div>
        </button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- DESKTOP SIDEBAR -->
    <aside>
      <div class="sideTitle">Navigation</div>
      <div class="nav">
        <a href="#dashboard">Dashboard <span class="badge">Live</span></a>
        <a href="#orderbook">Order Book</a>
        <a href="#topcoins">Top Coins</a>
        <a href="#news">News</a>
        <a href="#profile">Profile</a>
        <a href="#settings">Settings</a>
        <a href="#support">Support</a>
      </div>

      <div class="sideTitle">Account</div>
      <div class="nav">
        <a href="javascript:void(0)" id="logoutBtnD">Logout</a>
      </div>
    </aside>

    <!-- MAIN -->
    <main>
      <section id="dashboard" class="grid2">
        <div class="card">
          <div class="cardHead">
            <h2>Market Overview</h2>
            <div class="subtxt" id="marketTime">Loading...</div>
          </div>
          <div class="miniChart">
            <canvas id="chart"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="cardHead">
            <h2>Quick Stats</h2>
            <div class="subtxt">Auto-updated</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr;gap:10px">
            <div class="coinItem">
              <div class="coinL"><b id="statSymbol">BTC/USDT</b><span>Selected pair</span></div>
              <div class="coinR" id="statPrice">--</div>
            </div>
            <div class="coinItem">
              <div class="coinL"><b>24h Change</b><span>Percentage</span></div>
              <div class="coinR" id="statChange">--</div>
            </div>
            <div class="coinItem">
              <div class="coinL"><b>Spread</b><span>Bid/Ask</span></div>
              <div class="coinR" id="statSpread">--</div>
            </div>
          </div>
        </div>
      </section>

      <!-- ORDER BOOK -->
      <section id="orderbook" class="card" style="margin-top:18px">
        <div class="cardHead">
          <h2>Order Book</h2>
          <div class="subtxt">Binance public depth snapshot</div>
        </div>

        <div class="row">
          <input type="search" id="pairSearch" placeholder="Search pair e.g. BTC, ETH..." />
          <select id="pairSelect"></select>
          <button class="btn brand" id="refreshOB">Refresh</button>
        </div>

        <div class="obWrap">
          <div class="obCol">
            <div class="obTop"><span>Asks (Sell)</span><span>Price / Amount / Total</span></div>
            <div class="obList" id="asks"></div>
          </div>
          <div class="obCol">
            <div class="obTop"><span>Bids (Buy)</span><span>Price / Amount / Total</span></div>
            <div class="obList" id="bids"></div>
          </div>
        </div>

        <div class="centerPrice" id="midPrice">--</div>

        <!-- TOP COINS AFTER ORDERBOOK -->
        <div id="topcoins" class="card" style="margin-top:16px;background:rgba(255,255,255,.03)">
          <div class="cardHead">
            <h2>Top 10 Major Cryptos</h2>
            <div class="subtxt">Live price (USDT)</div>
          </div>

          <div class="coinGrid" id="top10Grid"></div>
        </div>
      </section>

      <!-- NEWS -->
      <section id="news" class="card" style="margin-top:18px">
        <div class="cardHead">
          <h2>Crypto News</h2>
          <div class="subtxt">Latest headlines</div>
        </div>
        <div id="newsList" style="display:grid;gap:10px"></div>
      </section>

      <!-- PROFILE -->
      <section id="profile" class="card" style="margin-top:18px">
        <div class="cardHead">
          <h2>Profile</h2>
          <div class="subtxt">Account details</div>
        </div>
        <div id="profileBox" class="subtxt">Loading...</div>
      </section>

      <!-- SETTINGS -->
      <section id="settings" class="card" style="margin-top:18px">
        <div class="cardHead">
          <h2>Settings</h2>
          <div class="subtxt">Preferences</div>
        </div>
        <div class="subtxt">Coming soon</div>
      </section>

      <!-- SUPPORT -->
      <section id="support" class="card" style="margin-top:18px">
        <div class="cardHead">
          <h2>Support</h2>
          <div class="subtxt">Help & contact</div>
        </div>
        <div class="subtxt">Email: support@coinluxora.com</div>
      </section>
    </main>
  </div>

<script>
/* =========================
   SUPABASE SETUP
   ========================= */
const SUPABASE_URL = "https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTYyNjQ1NzcsImV4cCI6MjAxMTg0MDU3N30.6JNSaZp8x0bS5lYB5j4Qqf8U3Jxv9x9pGd6Z5c3rVhk";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* AUTH ELEMENTS */
const authCover = document.getElementById("authCover");
const authEmail = document.getElementById("authEmail");
const authPass  = document.getElementById("authPass");
const authMsg   = document.getElementById("authMsg");
const btnLogin  = document.getElementById("btnLogin");
const btnSignup = document.getElementById("btnSignup");
const btnResend = document.getElementById("btnResend");

function setAuthMsg(msg, isBad=false){
  authMsg.style.color = isBad ? "rgba(255,77,109,.95)" : "rgba(39,224,164,.95)";
  authMsg.textContent = msg;
}

/* =========================
   ONE-BLOCK AUTH + EMAIL VERIFICATION GUARD
   ========================= */
async function requireAuth(){
  const { data: { session } } = await supabase.auth.getSession();

  if(!session){
    authCover.classList.remove("hidden");
    return null;
  }

  // If user not verified (email)
  const user = session.user;
  const emailConfirmed = user?.email_confirmed_at || user?.confirmed_at;
  if(!emailConfirmed){
    authCover.classList.remove("hidden");
    setAuthMsg("Please verify your email first. Tap 'Resend Verification' if needed.", true);
    return null;
  }

  authCover.classList.add("hidden");
  return session;
}

/* login signup resend */
btnLogin.onclick = async () => {
  setAuthMsg("Logging in...");
  const { data, error } = await supabase.auth.signInWithPassword({
    email: authEmail.value.trim(),
    password: authPass.value
  });
  if(error){ setAuthMsg(error.message, true); return; }
  setAuthMsg("Login successful ✅");
  await boot();
};

btnSignup.onclick = async () => {
  setAuthMsg("Creating account...");
  const { data, error } = await supabase.auth.signUp({
    email: authEmail.value.trim(),
    password: authPass.value,
    options: { emailRedirectTo: window.location.href }
  });
  if(error){ setAuthMsg(error.message, true); return; }
  setAuthMsg("Signup successful ✅ Check your email to verify.", false);
};

btnResend.onclick = async () => {
  setAuthMsg("Resending verification link...");
  const email = authEmail.value.trim();
  if(!email){ setAuthMsg("Enter your email first.", true); return; }
  const { data, error } = await supabase.auth.resend({
    type: "signup",
    email
  });
  if(error){ setAuthMsg(error.message, true); return; }
  setAuthMsg("Verification email sent ✅", false);
};

/* logout buttons */
document.getElementById("logoutBtnD").onclick = async () => { await supabase.auth.signOut(); location.reload(); };
document.getElementById("logoutBtnM").onclick = async () => { await supabase.auth.signOut(); location.reload(); };

/* =========================
   MENU TOGGLE (MOBILE)
   ========================= */
const overlay = document.getElementById("overlay");
const mobileMenu = document.getElementById("mobileMenu");
const openMenu = document.getElementById("openMenu");
const closeMenu = document.getElementById("closeMenu");

function openDrawer(){
  overlay.classList.add("active");
  mobileMenu.classList.add("active");
  document.body.style.overflow = "hidden";
}
function closeDrawer(){
  overlay.classList.remove("active");
  mobileMenu.classList.remove("active");
  document.body.style.overflow = "";
}
openMenu.onclick = openDrawer;
closeMenu.onclick = closeDrawer;
overlay.onclick = closeDrawer;

/* =========================
   MINI CHART (simple demo)
   ========================= */
const canvas = document.getElementById("chart");
const ctx = canvas.getContext("2d");
function resizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.floor(rect.width * devicePixelRatio);
  canvas.height = Math.floor(rect.height * devicePixelRatio);
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener("resize", resizeCanvas);

function drawLine(data){
  resizeCanvas();
  const w = canvas.getBoundingClientRect().width;
  const h = canvas.getBoundingClientRect().height;

  ctx.clearRect(0,0,w,h);

  const min = Math.min(...data);
  const max = Math.max(...data);
  const pad = 18;

  ctx.beginPath();
  data.forEach((v,i)=>{
    const x = pad + (i/(data.length-1))*(w-2*pad);
    const y = pad + (1-(v-min)/(max-min || 1))*(h-2*pad);
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });
  ctx.strokeStyle = "rgba(77,163,255,.95)";
  ctx.lineWidth = 2.2;
  ctx.stroke();

  // glow
  ctx.strokeStyle = "rgba(77,163,255,.25)";
  ctx.lineWidth = 10;
  ctx.stroke();
}

/* =========================
   ORDER BOOK
   ========================= */
const pairSelect = document.getElementById("pairSelect");
const pairSearch = document.getElementById("pairSearch");
const asksEl = document.getElementById("asks");
const bidsEl = document.getElementById("bids");
const midPriceEl = document.getElementById("midPrice");
const refreshOB = document.getElementById("refreshOB");

const statSymbol = document.getElementById("statSymbol");
const statPrice  = document.getElementById("statPrice");
const statChange = document.getElementById("statChange");
const statSpread = document.getElementById("statSpread");

const pairsAll = [
  "BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","ADAUSDT","DOGEUSDT","TRXUSDT","AVAXUSDT","LINKUSDT",
  "MATICUSDT","DOTUSDT","LTCUSDT","BCHUSDT","ATOMUSDT","NEARUSDT","ETCUSDT","FILUSDT","ICPUSDT","OPUSDT",
  "ARBUSDT","INJUSDT","TIAUSDT","APTUSDT","SUIUSDT","RNDRUSDT","SEIUSDT","PEPEUSDT","SHIBUSDT","UNIUSDT"
];

function buildPairOptions(list){
  pairSelect.innerHTML = "";
  list.forEach(sym=>{
    const opt = document.createElement("option");
    opt.value = sym;
    opt.textContent = sym.replace("USDT","/USDT");
    pairSelect.appendChild(opt);
  });
}

pairSearch.addEventListener("input", ()=>{
  const q = pairSearch.value.trim().toUpperCase();
  const filtered = !q ? pairsAll : pairsAll.filter(p=>p.includes(q));
  buildPairOptions(filtered.length ? filtered : pairsAll);
});

buildPairOptions(pairsAll);
pairSelect.value = "BTCUSDT";

async function fetchOB(symbol){
  const url = `https://api.binance.com/api/v3/depth?symbol=${symbol}&limit=30`;
  const res = await fetch(url);
  if(!res.ok) throw new Error("Failed to fetch order book");
  return res.json();
}

function formatNum(n){
  const x = Number(n);
  if(!isFinite(x)) return "--";
  if(x >= 1) return x.toLocaleString(undefined,{maximumFractionDigits:4});
  return x.toLocaleString(undefined,{maximumFractionDigits:8});
}

function renderSide(list, type){
  // list = [ [price, qty], ... ]
  // compute totals + depth bars
  let maxTotal = 0;
  let rows = list.map(([p,q])=>{
    const price = Number(p);
    const qty = Number(q);
    const total = price*qty;
    if(total>maxTotal) maxTotal = total;
    return {price, qty, total};
  });

  return rows.map(r=>{
    const pct = maxTotal ? (r.total/maxTotal)*100 : 0;
    return `
      <div class="obRow">
        <div class="fillbar ${type}" style="width:${pct}%;"></div>
        <div class="${type==='sell'?'bad':'good'}">${formatNum(r.price)}</div>
        <div>${formatNum(r.qty)}</div>
        <div style="text-align:right">${formatNum(r.total)}</div>
      </div>
    `;
  }).join("");
}

async function updateOrderBook(){
  const symbol = pairSelect.value;
  statSymbol.textContent = symbol.replace("USDT","/USDT");

  asksEl.innerHTML = `<div class="subtxt">Loading...</div>`;
  bidsEl.innerHTML = `<div class="subtxt">Loading...</div>`;

  try{
    const data = await fetchOB(symbol);
    const asks = data.asks || [];
    const bids = data.bids || [];

    asksEl.innerHTML = renderSide(asks.slice(0, 20).reverse(), "sell");
    bidsEl.innerHTML = renderSide(bids.slice(0, 20), "buy");

    const bestAsk = asks.length ? Number(asks[0][0]) : 0;
    const bestBid = bids.length ? Number(bids[0][0]) : 0;
    const mid = (bestAsk && bestBid) ? ((bestAsk+bestBid)/2) : 0;

    midPriceEl.textContent = mid ? `Mid Price: ${formatNum(mid)}` : "--";

    statPrice.textContent = mid ? formatNum(mid) : "--";
    const spread = (bestAsk && bestBid) ? (bestAsk - bestBid) : 0;
    statSpread.textContent = spread ? formatNum(spread) : "--";

    // change (fake calc via small random since depth doesn't provide)
    const fake = ((Math.random()*2)-1).toFixed(2);
    statChange.textContent = `${fake}%`;
    statChange.style.color = (Number(fake) >= 0) ? "rgba(39,224,164,.95)" : "rgba(255,77,109,.95)";

    // update mini chart with random walk
    const points = [];
    let v = mid || 100;
    for(let i=0;i<40;i++){
      v += (Math.random()-0.5) * (v*0.008);
      points.push(v);
    }
    drawLine(points);

  }catch(e){
    asksEl.innerHTML = `<div class="subtxt" style="color:rgba(255,77,109,.95)">Error loading order book</div>`;
    bidsEl.innerHTML = `<div class="subtxt" style="color:rgba(255,77,109,.95)">Try again</div>`;
    midPriceEl.textContent = "--";
  }
}

pairSelect.addEventListener("change", updateOrderBook);
refreshOB.addEventListener("click", updateOrderBook);

/* =========================
   TOP 10 MAJOR COINS (LIVE PRICE)
   ========================= */
const top10 = [
  {name:"Bitcoin", sym:"BTCUSDT"},
  {name:"Ethereum", sym:"ETHUSDT"},
  {name:"BNB", sym:"BNBUSDT"},
  {name:"Solana", sym:"SOLUSDT"},
  {name:"XRP", sym:"XRPUSDT"},
  {name:"Cardano", sym:"ADAUSDT"},
  {name:"Dogecoin", sym:"DOGEUSDT"},
  {name:"TRON", sym:"TRXUSDT"},
  {name:"Avalanche", sym:"AVAXUSDT"},
  {name:"Chainlink", sym:"LINKUSDT"},
];

const top10Grid = document.getElementById("top10Grid");

async function fetchTickerPrice(symbol){
  const url = `https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error("ticker error");
  return res.json();
}

async function renderTop10(){
  top10Grid.innerHTML = "";
  const promises = top10.map(async c=>{
    try{
      const t = await fetchTickerPrice(c.sym);
      return { ...c, price: Number(t.price) };
    }catch(e){
      return { ...c, price: null };
    }
  });

  const results = await Promise.all(promises);

  top10Grid.innerHTML = results.map(c=>{
    return `
      <div class="coinItem">
        <div class="coinL">
          <b>${c.name}</b>
          <span>${c.sym.replace("USDT","/USDT")}</span>
        </div>
        <div class="coinR">${c.price ? formatNum(c.price) : "--"}</div>
      </div>
    `;
  }).join("");
}

/* =========================
   NEWS (simple fetch)
   ========================= */
const newsList = document.getElementById("newsList");
async function loadNews(){
  // demo: use coindesk RSS via allorigins isn't reliable; keep simple placeholders
  const demo = [
    {t:"Bitcoin market steadies as traders await macro catalysts", s:"Coinluxora Feed", d:"Updated"},
    {t:"Ethereum upgrades: what to watch this month", s:"Coinluxora Feed", d:"Updated"},
    {t:"Altcoins rally on renewed risk appetite", s:"Coinluxora Feed", d:"Updated"},
  ];
  newsList.innerHTML = demo.map(n=>`
    <div class="coinItem" style="justify-content:space-between">
      <div class="coinL">
        <b>${n.t}</b>
        <span>${n.s}</span>
      </div>
      <div class="coinR">${n.d}</div>
    </div>
  `).join("");
}

/* =========================
   BOOT
   ========================= */
async function boot(){
  const session = await requireAuth();
  if(!session) return;

  const user = session.user;
  document.getElementById("userPill").textContent = user.email || "Signed in";
  document.getElementById("profileBox").textContent = `Email: ${user.email}`;

  document.getElementById("marketTime").textContent = new Date().toLocaleString();

  await updateOrderBook();
  await renderTop10();
  await loadNews();

  // refresh pieces
  setInterval(()=>{ document.getElementById("marketTime").textContent = new Date().toLocaleString(); }, 30000);
  setInterval(()=>{ renderTop10(); }, 45000);
}

boot();
</script>

</body>
</html>
