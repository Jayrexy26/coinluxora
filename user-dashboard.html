<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Coinluxora User Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#050a18;
  --stroke:rgba(255,255,255,.12);
  --text:#eaf0ff;
  --muted:rgba(234,240,255,.65);

  --ok:#22c55e;
  --err:#f87171;

  --blue:#5b6cff;
  --purple:#7c4dff;
  --green:#34d399;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(900px 420px at 10% 0%, rgba(83,113,255,.22), transparent 55%),
    radial-gradient(900px 420px at 90% 0%, rgba(52,211,153,.18), transparent 55%),
    var(--bg);
  color:var(--text);
  padding:16px;
  padding-bottom:96px;
}
.container{max-width:920px;margin:0 auto}

/* ===== Loading Gate (prevents flicker) ===== */
#authGate{
  position:fixed;
  inset:0;
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  background:
    radial-gradient(900px 420px at 10% 0%, rgba(83,113,255,.22), transparent 55%),
    radial-gradient(900px 420px at 90% 0%, rgba(52,211,153,.18), transparent 55%),
    var(--bg);
}
.gateCard{
  width:min(520px,92vw);
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.25);
  border-radius:22px;
  padding:18px;
  box-shadow:0 26px 90px rgba(0,0,0,.55);
  backdrop-filter: blur(14px);
  text-align:center;
}
.gateLogo{
  width:62px;height:62px;
  border-radius:18px;
  margin:0 auto 10px;
  display:grid;place-items:center;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(109,87,255,1), rgba(124,77,255,1));
  box-shadow:0 18px 50px rgba(109,87,255,.28);
  font-size:28px;font-weight:1000;
}
.gateTxt{font-weight:1000}
.gateSub{margin-top:6px;color:rgba(234,240,255,.70);font-weight:900;font-size:13px}
.spinner{
  width:46px;height:46px;margin:14px auto 0;
  border-radius:999px;
  border:3px solid rgba(255,255,255,.18);
  border-top-color:#9bdcff;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ====== TOP BAR ====== */
.topRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:14px;
}
.brand{
  display:flex;align-items:center;gap:12px;
  padding:12px 14px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(90deg, rgba(109,87,255,1), rgba(135,116,255,0.86));
  color:white;
  font-weight:1000;
  letter-spacing:.6px;
  box-shadow:0 18px 50px rgba(109,87,255,.25);
  min-width:140px;
}
.brandIcon{
  width:34px;height:34px;border-radius:12px;
  background:rgba(255,255,255,.18);
  border:1px solid rgba(255,255,255,.22);
  display:grid;place-items:center;
  font-weight:1000;
}
.headerActions{display:flex;gap:10px;align-items:center}

/* ‚úÖ new avatar icon button */
.avatarBtn{
  width:46px;height:46px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(124,77,255,1), rgba(109,87,255,1));
  color:white;
  font-weight:1000;
  cursor:pointer;
  box-shadow:0 16px 40px rgba(124,77,255,.32);
  display:grid;place-items:center;
}
.avatarBtn:hover{filter:brightness(1.05)}

.iconBtn{
  width:46px;height:46px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.18);
  color:white;
  font-weight:1000;
  cursor:pointer;
  box-shadow:0 16px 40px rgba(0,0,0,.35);
  backdrop-filter: blur(10px);
}
.iconBtn:hover{background:rgba(255,255,255,.08)}
.iconBtn.primary{
  background:linear-gradient(180deg, rgba(109,87,255,1), rgba(124,77,255,1));
  border:none;
}

/* ====== HELLO CARD ====== */
.helloCard{
  border-radius:18px;
  padding:14px 14px;
  background:linear-gradient(90deg, rgba(109,87,255,1), rgba(255,77,166,0.98));
  color:white;
  box-shadow:0 18px 50px rgba(109,87,255,.22);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.helloLeft{display:flex;align-items:center;gap:12px}
.helloLogo{
  width:46px;height:46px;border-radius:16px;
  background:rgba(255,255,255,.20);
  border:1px solid rgba(255,255,255,.22);
  display:grid;place-items:center;
  font-weight:1000;
}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
.miniChip{
  font-size:12px;font-weight:1000;
  padding:6px 10px;border-radius:999px;
  background:rgba(255,255,255,.18);
  border:1px solid rgba(255,255,255,.22);
  display:flex;gap:6px;align-items:center;
}
.helloTitle{font-weight:1000;font-size:18px}
.helloSub{font-size:12px;font-weight:900;opacity:.92}
.helloRight{display:flex;align-items:center;gap:10px}
.idChip{
  padding:8px 12px;border-radius:999px;
  background:rgba(255,255,255,.18);
  border:1px solid rgba(255,255,255,.22);
  font-weight:1000;font-size:12px;
}
.logoutBtn{
  width:46px;height:46px;border-radius:999px;border:none;
  cursor:pointer;
  background:rgba(239,68,68,0.95);
  color:#fff;
  font-weight:1000;
  box-shadow:0 16px 40px rgba(239,68,68,.22);
}

/* ‚úÖ TradingView ticker */
.tickerFloat{
  margin-top:12px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
  box-shadow:0 22px 70px rgba(0,0,0,.48);
  backdrop-filter: blur(12px);
  overflow:hidden;
}
.tickerHeader{
  padding:10px 12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid rgba(255,255,255,.10);
  color:rgba(234,240,255,.78);
  font-weight:1000;
  font-size:13px;
}
.tickerHint{color:rgba(234,240,255,.50);font-size:12px;font-weight:900}
.tickerFrame{width:100%;height:54px;border:0;display:block;background:transparent}

/* ===== BALANCE CARD ===== */
.balanceCard{
  margin-top:14px;
  border-radius:22px;
  overflow:hidden;
  position:relative;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(900px 400px at 15% 20%, rgba(0,0,0,0.55), transparent 55%),
    radial-gradient(900px 400px at 70% 20%, rgba(52,211,153,0.22), transparent 55%),
    linear-gradient(135deg, rgba(3,7,18,0.92), rgba(15,23,42,0.84));
  color:white;
  box-shadow: 0 26px 60px rgba(0,0,0,0.25);
  padding:16px;
}
.bTitle{font-size:13px;font-weight:1000;opacity:.85}
.bValue{font-size:34px;font-weight:1000;margin-top:8px}
.bHint{margin-top:6px;font-size:13px;font-weight:900;opacity:.88;display:flex;gap:10px;align-items:center}
.dot{width:10px;height:10px;border-radius:999px;background:var(--green)}

.actionGrid{
  margin-top:16px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
}
.action{
  border-radius:18px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.12);
  padding:12px;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  gap:8px;
  cursor:pointer;
}
.aIcon{
  width:48px;height:48px;border-radius:999px;
  display:grid;place-items:center;
  font-size:20px;
  font-weight:1000;color:#fff;
}
.aSend{background:linear-gradient(180deg,#6d57ff,#7c4dff)}
.aReceive{background:linear-gradient(180deg,#18c07b,#11b981)}
.aPlans{background:linear-gradient(180deg,#f59e0b,#f97316)}
.aSupport{background:linear-gradient(180deg,#38bdf8,#5b6cff)}
.aText{font-weight:1000;font-size:13px}

/* ===== GLASS BOX ===== */
.box{
  border:1px solid rgba(255,255,255,.12);
  border-radius:22px;
  padding:16px;
  background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
  box-shadow:0 26px 90px rgba(0,0,0,.55);
  backdrop-filter: blur(12px);
  margin-top:14px;
}
.box h2{margin:0;font-size:20px;font-weight:1000}
.small{color:var(--muted);font-size:13px;margin-top:8px}
.ok{color:var(--ok);font-weight:1000}
.err{color:var(--err);font-weight:1000}

.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
.card{
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:12px;
  background:rgba(0,0,0,.22);
  box-shadow:0 16px 40px rgba(0,0,0,.35);
}
@media(max-width:520px){
  .grid{grid-template-columns:1fr}
  .actionGrid{grid-template-columns:repeat(2,1fr)}
}

/* ===== SIDEBAR ===== */
.overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.65);
  display:none; z-index:999;
  backdrop-filter: blur(4px);
}
.sidebar{
  position:fixed; top:0; left:-290px;
  width:270px; height:100vh;
  background:linear-gradient(180deg, rgba(5,10,24,1), rgba(2,6,23,1));
  border-right:1px solid rgba(255,255,255,.12);
  padding:16px;
  transition:.28s ease;
  z-index:1000;
  box-shadow:0 20px 80px rgba(0,0,0,.6);
}
.sidebar.open{ left:0; }
.overlay.show{ display:block; }
.brandRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.brandSide{font-weight:1000;font-size:18px;letter-spacing:.6px;}
.closeBtn{
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.14);
  color:var(--text);
  border-radius:12px;padding:8px 12px;
  font-weight:1000;
}
.userTag{
  padding:12px;border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  margin-bottom:12px;
}
.sideItem{
  display:flex;gap:10px;align-items:center;
  padding:12px;
  border:1px solid rgba(255,255,255,.12);
  border-radius:16px;margin-bottom:10px;
  color:var(--text);
  background:rgba(0,0,0,.22);
  font-weight:1000;
  text-decoration:none;
}
.sideItem:hover{background:rgba(255,255,255,.08)}
.activeLink{border:1px solid rgba(56,189,248,.55);background:rgba(56,189,248,0.12);}
.sideLogout{
  background:linear-gradient(90deg, rgba(248,113,113,1), rgba(239,68,68,1));
  color:#020617;border:none;width:100%;
  padding:14px;border-radius:16px;font-weight:1000;cursor:pointer
}
.sideDivider{
  height:1px;background:rgba(255,255,255,.10);
  margin:12px 0;
}

/* ===== BOTTOM NAV ===== */
.bottomNav{
  position:fixed;left:0;right:0;bottom:0;
  height:76px;
  background:rgba(2,6,23,.78);
  border-top:1px solid rgba(255,255,255,.12);
  display:flex;justify-content:space-around;align-items:center;
  z-index:1200;padding:8px 10px;
  backdrop-filter: blur(12px);
}
.navItem{
  flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  color:rgba(234,240,255,.55);
  font-size:12px;font-weight:1000;
  padding:10px 0;border-radius:16px;cursor:pointer;
  position:relative;
}
.navItem span{font-size:18px;margin-bottom:4px}
.navActive{color:#9bdcff;background:rgba(56,189,248,0.10)}

/* BADGE */
.badge{
  position:absolute;
  top:6px;
  right:22%;
  min-width:18px;
  height:18px;
  padding:0 6px;
  border-radius:999px;
  background:#f87171;
  color:#020617;
  font-weight:1000;
  font-size:11px;
  display:none;
  align-items:center;
  justify-content:center;
  border:1px solid rgba(255,255,255,.18);
}
</style>
</head>

<body>

<!-- Loading Gate prevents rapid flicker -->
<div id="authGate">
  <div class="gateCard">
    <div class="gateLogo">üì£</div>
    <div class="gateTxt">Coinluxora</div>
    <div class="gateSub">Securing your session‚Ä¶</div>
    <div class="spinner"></div>
  </div>
</div>

<div id="overlay" class="overlay" onclick="closeMenu()"></div>

<div id="sidebar" class="sidebar">
  <div class="brandRow">
    <div class="brandSide">COINLUXORA</div>
    <button class="closeBtn" onclick="closeMenu()">‚úï</button>
  </div>

  <div class="userTag">
    <div class="small">Logged in as</div>
    <div id="sideEmail" style="font-weight:1000;margin-top:6px;">---</div>
  </div>

  <a class="sideItem activeLink" href="user-dashboard.html">üè† Dashboard</a>
  <a class="sideItem" href="portfolio.html">üìä Portfolio</a>
  <a class="sideItem" href="plans.html">üíº Investment Plans</a>
  <a class="sideItem" href="support.html">üßë‚Äçüíª Support / Contact</a>
  <a class="sideItem" href="deposits.html">üí≥ Deposit</a>
  <a class="sideItem" href="withdraw.html">‚û° Withdraw Funds</a>

  <div class="sideDivider"></div>

  <!-- ‚úÖ Settings is now only Profile page -->
  <a class="sideItem" href="profile.html">üë§ Profile / Settings</a>

  <div style="height:12px"></div>
  <button class="sideLogout" onclick="logout()">Logout</button>
</div>

<div class="container">

  <div class="topRow">
    <div class="brand">
      <div class="brandIcon">üì£</div>
      COIN
    </div>

    <div class="headerActions">
      <!-- ‚úÖ Avatar opens profile -->
      <button class="avatarBtn" onclick="goProfile()" title="Profile">üë§</button>
      <button class="iconBtn" onclick="openMenu()" title="Menu">‚ò∞</button>
    </div>
  </div>

  <div class="helloCard">
    <div class="helloLeft">
      <div class="helloLogo">üì∂</div>
      <div>
        <div class="chips">
          <div class="miniChip">üü¢ active</div>
          <div class="miniChip">üá≥üá¨ NG</div>
        </div>
        <div class="helloTitle">Hello! üåô</div>
        <div class="helloSub" id="email">Loading‚Ä¶</div>
      </div>
    </div>

    <div class="helloRight">
      <div class="idChip" id="userIdChip">ID:</div>
      <button class="logoutBtn" onclick="logout()" title="Logout">‚éã</button>
    </div>
  </div>

  <div class="tickerFloat">
    <div class="tickerHeader">
      <div>Live Market Prices</div>
      <div class="tickerHint">TradingView</div>
    </div>
    <iframe class="tickerFrame" src="tv-ticker.html"></iframe>
  </div>

  <div class="balanceCard">
    <div class="bTitle">Total Portfolio Value</div>
    <div class="bValue" id="balance">--</div>
    <div class="bHint"><div class="dot"></div> <div>Your trading account balance</div></div>

    <div class="actionGrid">
      <div class="action" onclick="goWithdrawAndClear()">
        <div class="aIcon aSend">‚úàÔ∏è</div>
        <div class="aText">Send</div>
      </div>
      <div class="action" onclick="goDepositAndClear()">
        <div class="aIcon aReceive">‚¨áÔ∏è</div>
        <div class="aText">Receive</div>
      </div>
      <div class="action" onclick="goPlans()">
        <div class="aIcon aPlans">üìà</div>
        <div class="aText">Plans</div>
      </div>
      <div class="action" onclick="goSupportAndClear()">
        <div class="aIcon aSupport">üí¨</div>
        <div class="aText">Support</div>
      </div>
    </div>
  </div>

  <div class="box">
    <h2>Active Investment Plan</h2>
    <div id="planMsg" class="small">Loading‚Ä¶</div>
    <div id="planBox"></div>
  </div>

  <div class="box">
    <h2>Live Crypto Prices</h2>
    <div class="grid" id="prices"><div class="card">Loading‚Ä¶</div></div>
  </div>

</div>

<div class="bottomNav">
  <div class="navItem navActive" onclick="goHome()"><span>üè†</span>Home</div>

  <div class="navItem" onclick="goDepositAndClear()">
    <div id="badgeDeposit" class="badge">0</div>
    <span>üí≥</span>Deposit
  </div>

  <div class="navItem" onclick="goWithdrawAndClear()">
    <div id="badgeWithdraw" class="badge">0</div>
    <span>‚û°</span>Withdraw
  </div>

  <div class="navItem" onclick="goPlans()"><span>üíº</span>Plans</div>

  <div class="navItem" onclick="goProfile()"><span>üë§</span>Profile</div>
</div>

<script>
/* ============================================================
   ‚úÖ COINLUXORA AUTH GUARD (LOGIN + EMAIL VERIFIED REQUIRED)
   FIXED: no flicker/loop, uses session first, then user check.
   ============================================================ */
const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";
const EDGE_CLEAR_BADGE_URL = `${SUPABASE_URL}/functions/v1/clear_badge`;
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

let currentUserEmail="";
let currentUserId="";
let badgeChannel=null;

(async function authGuard(){
  try{
    // 1) session check first (fast + stable)
    const { data: sessionData } = await supabaseClient.auth.getSession();
    const session = sessionData?.session;

    if(!session){
      window.location.replace("login.html");
      return;
    }

    // 2) now validate user + verified
    const { data, error } = await supabaseClient.auth.getUser();
    const user = data?.user;

    if(error || !user){
      window.location.replace("login.html");
      return;
    }

    if(!user.email_confirmed_at){
      await supabaseClient.auth.signOut();
      window.location.replace("verify.html?status=unverified");
      return;
    }

    window.COINLUXORA_USER = user;
    initWithUser(user);

  }catch(e){
    window.location.replace("login.html");
  }
})();

/* NAV */
function goHome(){ window.scrollTo({top:0,behavior:"smooth"}); }
function goPlans(){ window.location.href="plans.html"; }
function goProfile(){ window.location.href="profile.html"; }
function goDepositAndClear(){ clearBadge("deposits"); window.location.href="deposits.html"; }
function goWithdrawAndClear(){ clearBadge("withdrawals"); window.location.href="withdraw.html"; }
function goSupportAndClear(){ clearBadge("notifications"); window.location.href="support.html"; }

function openMenu(){
  document.getElementById("sidebar").classList.add("open");
  document.getElementById("overlay").classList.add("show");
}
function closeMenu(){
  document.getElementById("sidebar").classList.remove("open");
  document.getElementById("overlay").classList.remove("show");
}

function hideGate(){
  const g=document.getElementById("authGate");
  if(g) g.style.display="none";
}

function setBadge(id, count){
  const el=document.getElementById(id);
  if(!el) return;
  const n=Number(count||0);
  if(n<=0){
    el.style.display="none";
  }else{
    el.style.display="flex";
    el.innerText = n > 99 ? "99+" : String(n);
  }
}

function setBadgeFromKey(badge_key, badge_value){
  if(badge_key === "deposits"){
    setBadge("badgeDeposit", badge_value);
  } else if(badge_key === "withdrawals"){
    setBadge("badgeWithdraw", badge_value);
  }
}

async function loadRealtimeBadgesOnce(){
  if(!currentUserId) return;
  setBadge("badgeDeposit", 0);
  setBadge("badgeWithdraw", 0);

  const { data, error } = await supabaseClient
    .from("user_badges")
    .select("badge_key, badge_value")
    .eq("user_id", currentUserId);

  if(error){
    console.log("Badge load error:", error.message);
    return;
  }

  (data || []).forEach(row => setBadgeFromKey(row.badge_key, row.badge_value));
}

function subscribeToRealtimeBadges(){
  if(!currentUserId) return;
  if(badgeChannel){
    supabaseClient.removeChannel(badgeChannel);
    badgeChannel=null;
  }

  badgeChannel = supabaseClient
    .channel("realtime-user-badges-dashboard")
    .on("postgres_changes", {
      event: "*",
      schema: "public",
      table: "user_badges",
      filter: `user_id=eq.${currentUserId}`
    }, payload => {
      const row = payload.new;
      if(!row) return;
      setBadgeFromKey(row.badge_key, row.badge_value);
    })
    .subscribe();
}

async function clearBadge(badge_key){
  try{
    const { data: sessionData } = await supabaseClient.auth.getSession();
    const accessToken = sessionData?.session?.access_token;
    if(!accessToken) return;

    await fetch(EDGE_CLEAR_BADGE_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${accessToken}`,
        "apikey": SUPABASE_ANON_KEY
      },
      body: JSON.stringify({ badge_key })
    });
  }catch(e){
    console.log("clearBadge error:", e);
  }
}

function initWithUser(user){
  currentUserEmail=user.email;
  currentUserId=user.id;

  document.getElementById("email").innerHTML=`Logged in as: <span class="ok">${currentUserEmail}</span>`;
  document.getElementById("sideEmail").innerText=currentUserEmail;
  document.getElementById("userIdChip").innerText = "ID: " + currentUserId.slice(0,6).toUpperCase();

  hideGate();

  // load features
  loadBalance();
  loadActivePlan();
  fetchPrices();
  loadRealtimeBadgesOnce();
  subscribeToRealtimeBadges();
}

async function loadBalance(){
  const { data } = await supabaseClient.from("users").select("*").eq("email", currentUserEmail).single();
  const bal = Number(data?.balance || 0).toFixed(2);
  document.getElementById("balance").innerHTML = "$" + bal;
}

function money(n){ return "$" + Number(n||0).toFixed(2); }
function pill(status){
  const s=(status||"pending").toLowerCase();
  return `<span style="padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.08);font-weight:1000;font-size:12px">${s}</span>`;
}
function daysBetween(date1, date2){
  const d1=new Date(date1);
  const d2=new Date(date2);
  const diff=(d2 - d1) / (1000*60*60*24);
  return Math.max(0, Math.ceil(diff));
}

async function loadActivePlan(){
  const planMsg=document.getElementById("planMsg");
  const planBox=document.getElementById("planBox");

  const { data, error } = await supabaseClient
    .from("investment_plans")
    .select("*")
    .eq("user_email", currentUserEmail)
    .order("created_at",{ascending:false})
    .limit(1);

  if(error){
    planMsg.innerHTML="<span class='err'>"+error.message+"</span>";
    planBox.innerHTML="";
    return;
  }

  if(!data || data.length===0){
    planMsg.innerHTML="<span class='err'>No investment plan started yet.</span>";
    planBox.innerHTML=`<div class="small">Go to <a style="color:#9bdcff;font-weight:1000" href="plans.html">Investment Plans</a> to start.</div>`;
    return;
  }

  const plan=data[0];
  const amount=Number(plan.amount||0);
  const roi=Number(plan.roi_percent||0);
  const expected=amount+(amount*(roi/100));

  let daysLeft="--";
  if(plan.duration_days && plan.created_at){
    const start=new Date(plan.created_at);
    const end=new Date(start);
    end.setDate(end.getDate()+Number(plan.duration_days||0));
    daysLeft = daysBetween(new Date(), end);
  }

  planMsg.innerHTML="<span class='ok'>Plan details loaded ‚úÖ</span>";
  planBox.innerHTML=`
    <div class="card">
      <strong>${plan.plan_name} Plan</strong> ${pill(plan.status)}
      <div class="small" style="margin-top:10px">Amount: <strong>${money(amount)}</strong></div>
      <div class="small">ROI: <strong>${roi}%</strong></div>
      <div class="small">Duration: <strong>${plan.duration_days} days</strong></div>
      <div class="small">Expected Return: <strong>${money(expected)}</strong></div>
      <div class="small">Days remaining: <strong>${daysLeft}</strong></div>
      ${plan.admin_note ? `<div class="small">Admin note: <strong>${plan.admin_note}</strong></div>` : ""}
    </div>
  `;
}

async function fetchPrices(){
  try{
    const res=await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,tether&vs_currencies=usd");
    const data=await res.json();
    document.getElementById("prices").innerHTML=`
      <div class="card"><strong>BTC</strong><div class="small" style="margin-top:8px">$${data.bitcoin.usd}</div></div>
      <div class="card"><strong>ETH</strong><div class="small" style="margin-top:8px">$${data.ethereum.usd}</div></div>
      <div class="card"><strong>USDT</strong><div class="small" style="margin-top:8px">$${data.tether.usd}</div></div>
    `;
  }catch{
    document.getElementById("prices").innerHTML="<div class='card err'>Failed to load prices</div>";
  }
}

async function logout(){
  await supabaseClient.auth.signOut();
  window.location.replace("login.html");
}
</script>

</body>
</html>
