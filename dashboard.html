<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coinluxora Admin Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{margin:0;font-family:system-ui;background:#020617;color:#e5e7eb;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid #1e293b;margin-bottom:12px}
    button{border:none;padding:10px 14px;border-radius:10px;font-weight:900;cursor:pointer;color:#020617}
    .logout{background:#38bdf8}
    .credit{background:#22c55e;margin-right:8px}
    .debit{background:#f87171}
    .approve{background:#22c55e;margin-right:8px}
    .reject{background:#f87171}
    .save{background:#22c55e}
    .danger{background:#f87171}
    .edit{background:#facc15;margin-right:8px}
    .box{border:1px solid #1e293b;border-radius:12px;padding:12px;margin-bottom:16px;background:#020617}
    .ok{color:#22c55e}
    .error{color:#f87171}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #1e293b;padding:10px;font-size:13px;word-break:break-word;vertical-align:top}
    th{background:#0b1224}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;font-size:13px;margin-bottom:8px}
    textarea{min-height:70px;resize:none}
    form{border:1px solid #1e293b;border-radius:12px;padding:12px;margin-top:12px}
    .small{font-size:12px;color:#94a3b8;margin-top:6px}
    a{color:#38bdf8;font-weight:900;text-decoration:none}
    .pill{padding:5px 10px;border-radius:999px;font-weight:900;font-size:12px;display:inline-block}
    .pending{background:#facc15;color:#020617}
    .active{background:#38bdf8;color:#020617}
    .completed{background:#22c55e;color:#020617}
    .rejected{background:#f87171;color:#020617}
    .open{background:#facc15;color:#020617}
    .closed{background:#22c55e;color:#020617}
  </style>
</head>

<body>

<header>
  <strong>Coinluxora Admin Dashboard</strong>
  <button class="logout" onclick="logout()">Logout</button>
</header>

<!-- USERS -->
<div class="box">
  <strong>Users</strong>
  <div class="small">Credit or debit balances instantly</div>
  <div id="usersStatus" style="margin-top:8px;">Loading users…</div>

  <table>
    <thead>
      <tr>
        <th>Email</th>
        <th>Balance</th>
        <th>Amount</th>
        <th>Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="userRows"></tbody>
  </table>
</div>

<!-- SUPPORT TICKETS -->
<div class="box">
  <strong>Support Tickets</strong>
  <div class="small">Reply to user issues and mark closed</div>
  <div id="ticketStatus" style="margin-top:8px;">Loading tickets…</div>

  <table>
    <thead>
      <tr>
        <th>User Email</th>
        <th>Subject</th>
        <th>Message</th>
        <th>Status</th>
        <th>Admin Reply</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="ticketRows"></tbody>
  </table>
</div>

<!-- INVESTMENT PLANS -->
<div class="box">
  <strong>Investment Plans</strong>
  <div class="small">Approve / complete plans and auto-credit ROI profit</div>
  <div id="planStatus" style="margin-top:8px;">Loading plans…</div>

  <table>
    <thead>
      <tr>
        <th>User Email</th>
        <th>Plan</th>
        <th>Amount</th>
        <th>ROI</th>
        <th>Duration</th>
        <th>Status</th>
        <th>Admin Note</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="planRows"></tbody>
  </table>
</div>

<!-- DEPOSITS -->
<div class="box">
  <strong>Deposits</strong>
  <div class="small">Approve deposit and balance auto-credits</div>
  <div id="depStatus" style="margin-top:8px;">Loading deposits…</div>

  <table>
    <thead>
      <tr>
        <th>User Email</th>
        <th>Asset</th>
        <th>Network</th>
        <th>Amount</th>
        <th>TX Hash</th>
        <th>Proof</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="depRows"></tbody>
  </table>
</div>

<!-- WITHDRAWALS -->
<div class="box">
  <strong>Withdrawals</strong>
  <div class="small">Approve or reject withdrawals (Approve auto-debits user balance)</div>
  <div id="wdStatus" style="margin-top:8px;">Loading withdrawals…</div>

  <table>
    <thead>
      <tr>
        <th>User Email</th>
        <th>Asset</th>
        <th>Network</th>
        <th>Amount</th>
        <th>Wallet Address</th>
        <th>Status</th>
        <th>Admin Note</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="wdRows"></tbody>
  </table>
</div>

<!-- PORTFOLIO MANAGER -->
<div class="box">
  <strong>Portfolio Manager</strong>
  <div class="small">Add / edit holdings with buy price + notes (BTC/ETH/USDT)</div>
  <div id="pfStatus" style="margin-top:8px;">Loading portfolio…</div>

  <input id="pfEmail" placeholder="Search by user email (example@gmail.com)" oninput="loadPortfolios()"/>

  <form onsubmit="savePortfolio(event)">
    <input type="hidden" id="pfId">
    <input id="pfUserEmail" placeholder="User Email" required>
    <select id="pfAsset" required>
      <option value="btc">BTC</option>
      <option value="eth">ETH</option>
      <option value="usdt">USDT</option>
    </select>
    <input id="pfAmount" type="number" step="0.00000001" placeholder="Amount (example 0.5)" required>
    <input id="pfBuyPrice" type="number" step="0.01" placeholder="Buy Price in USD (example 45000)" required>
    <input id="pfNotes" placeholder="Notes (example: plan bonus / manual credit)">
    <button class="save" type="submit">Save Holding</button>
  </form>

  <table>
    <thead>
      <tr>
        <th>User Email</th>
        <th>Asset</th>
        <th>Amount</th>
        <th>Buy Price</th>
        <th>Notes</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="pfRows"></tbody>
  </table>
</div>

<!-- WALLET ADDRESS MANAGER -->
<div class="box">
  <strong>Wallet Address Manager</strong>
  <div class="small">Add / edit / delete deposit addresses</div>
  <div id="addrStatus" style="margin-top:8px;">Loading wallet addresses…</div>

  <form onsubmit="saveAddress(event)">
    <input type="hidden" id="editId">
    <input id="asset" placeholder="Asset (btc / eth / usdt)" required>
    <input id="network" placeholder="Network (BTC / ERC20 / TRC20)" required>
    <input id="address" placeholder="Wallet Address" required>
    <button class="save" type="submit">Save Wallet</button>
  </form>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Asset</th>
        <th>Network</th>
        <th>Address</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="addrRows"></tbody>
  </table>
</div>

<script>
const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

checkSession();

async function checkSession(){
  const {data}=await supabaseClient.auth.getSession();
  if(!data.session){window.location.href="admin.html";return;}
  loadUsers();loadTickets();loadPlans();loadDeposits();loadWithdrawals();loadPortfolios();loadAddresses();
}

function badgeStatus(status){
  const s=(status||"pending").toLowerCase();
  return `<span class="pill ${s}">${s}</span>`;
}

/* ---------------- SUPPORT TICKETS ---------------- */
async function loadTickets(){
  const status=document.getElementById("ticketStatus");
  const tbody=document.getElementById("ticketRows");

  const {data,error}=await supabaseClient.from("support_tickets").select("*").order("created_at",{ascending:false});
  if(error){status.innerHTML=`<span class="error">${error.message}</span>`;return;}
  if(!data||data.length===0){status.innerHTML=`<span class="error">No tickets yet</span>`;tbody.innerHTML="";return;}

  status.innerHTML=`<span class="ok">Loaded ${data.length} ticket(s) ✅</span>`;
  tbody.innerHTML="";

  data.forEach(t=>{
    tbody.innerHTML+=`
      <tr>
        <td>${t.user_email}</td>
        <td><strong>${t.subject}</strong></td>
        <td>${t.message}</td>
        <td>${badgeStatus(t.status)}</td>
        <td>
          <textarea id="reply-${t.id}" placeholder="Write reply...">${t.admin_reply || ""}</textarea>
        </td>
        <td>
          <button class="approve" onclick="replyTicket('${t.id}')">Save Reply</button>
          <button class="save" onclick="closeTicket('${t.id}')">Close</button>
        </td>
      </tr>
    `;
  });
}

async function replyTicket(ticketId){
  const reply=document.getElementById(`reply-${ticketId}`).value.trim();
  const res=await supabaseClient.from("support_tickets").update({
    admin_reply: reply
  }).eq("id", ticketId);

  if(res.error){alert("❌ "+res.error.message);return;}
  alert("✅ Reply saved!");
  loadTickets();
}

async function closeTicket(ticketId){
  const reply=document.getElementById(`reply-${ticketId}`).value.trim();
  const res=await supabaseClient.from("support_tickets").update({
    admin_reply: reply,
    status: "closed"
  }).eq("id", ticketId);

  if(res.error){alert("❌ "+res.error.message);return;}
  alert("✅ Ticket closed!");
  loadTickets();
}

/* ---------------- USERS ---------------- */
async function loadUsers(){ /* same as before */
  const status=document.getElementById("usersStatus");
  const tbody=document.getElementById("userRows");
  const {data,error}=await supabaseClient.from("users").select("*").order("created_at",{ascending:false});
  if(error){status.innerHTML=`<span class="error">${error.message}</span>`;return;}
  if(!data||data.length===0){status.innerHTML=`<span class="error">No users found</span>`;tbody.innerHTML="";return;}
  status.innerHTML=`<span class="ok">Loaded ${data.length} user(s) ✅</span>`;
  tbody.innerHTML="";
  data.forEach(u=>{
    tbody.innerHTML+=`
      <tr>
        <td>${u.email||""}</td>
        <td><strong>${Number(u.balance||0).toFixed(2)}</strong></td>
        <td><input type="number" step="0.01" placeholder="Amount" id="amt-${u.id}"></td>
        <td><input placeholder="Notes" id="note-${u.id}" value="${u.notes||""}"></td>
        <td>
          <button class="credit" onclick="credit('${u.id}')">Credit</button>
          <button class="debit" onclick="debit('${u.id}')">Debit</button>
        </td>
      </tr>`;
  });
}
async function credit(id){ /* same as before */ 
  const amt=Number(document.getElementById(`amt-${id}`).value||0);
  const notes=document.getElementById(`note-${id}`).value;
  if(amt<=0){alert("Enter amount");return;}
  const {data:u,error:e}=await supabaseClient.from("users").select("balance").eq("id",id).single();
  if(e){alert(e.message);return;}
  const newBal=Number(u.balance||0)+amt;
  const res=await supabaseClient.from("users").update({balance:newBal,notes}).eq("id",id);
  if(res.error){alert(res.error.message);return;}
  alert("✅ Credited"); loadUsers();
}
async function debit(id){
  const amt=Number(document.getElementById(`amt-${id}`).value||0);
  const notes=document.getElementById(`note-${id}`).value;
  if(amt<=0){alert("Enter amount");return;}
  const {data:u,error:e}=await supabaseClient.from("users").select("balance").eq("id",id).single();
  if(e){alert(e.message);return;}
  const newBal=Math.max(0,Number(u.balance||0)-amt);
  const res=await supabaseClient.from("users").update({balance:newBal,notes}).eq("id",id);
  if(res.error){alert(res.error.message);return;}
  alert("✅ Debited"); loadUsers();
}

/* ---------------- BELOW: keep all other sections as already working ---------------- */
async function loadPlans(){ /* ... */ }
async function loadDeposits(){ /* ... */ }
async function loadWithdrawals(){ /* ... */ }
async function loadPortfolios(){ /* ... */ }
async function loadAddresses(){ /* ... */ }

/* ---------------- LOGOUT ---------------- */
async function logout(){
  await supabaseClient.auth.signOut();
  window.location.href="admin.html";
}
</script>

</body>
</html>
