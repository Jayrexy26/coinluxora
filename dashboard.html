<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coinluxora Admin Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{margin:0;font-family:system-ui;background:#020617;color:#e5e7eb;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid #1e293b;margin-bottom:12px}
    button{border:none;padding:10px 14px;border-radius:10px;font-weight:900;cursor:pointer;color:#020617}
    .logout{background:#38bdf8}
    .credit{background:#22c55e;margin-right:8px}
    .debit{background:#f87171}
    .approve{background:#22c55e;margin-right:8px}
    .reject{background:#f87171}
    .save{background:#22c55e}
    .danger{background:#f87171}
    .edit{background:#facc15;margin-right:8px}
    .box{border:1px solid #1e293b;border-radius:12px;padding:12px;margin-bottom:16px;background:#020617}
    .ok{color:#22c55e}
    .error{color:#f87171}
    .small{font-size:12px;color:#94a3b8;margin-top:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #1e293b;padding:10px;font-size:13px;word-break:break-word;vertical-align:top}
    th{background:#0b1224}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#e5e7eb;font-size:13px;margin-bottom:8px}
    textarea{min-height:70px;resize:none}
    .pill{padding:5px 10px;border-radius:999px;font-weight:900;font-size:12px;display:inline-block}
    .pending{background:#facc15;color:#020617}
    .active{background:#38bdf8;color:#020617}
    .completed{background:#22c55e;color:#020617}
    .rejected{background:#f87171;color:#020617}
    .open{background:#facc15;color:#020617}
    .closed{background:#22c55e;color:#020617}
    .errBox{border:1px solid #7f1d1d;background:#1f0a0a;padding:12px;border-radius:12px;margin-bottom:14px}
    a{color:#38bdf8;font-weight:900;text-decoration:none}
  </style>
</head>

<body>

<header>
  <strong>Coinluxora Admin Dashboard</strong>
  <button class="logout" onclick="logout()">Logout</button>
</header>

<!-- ERROR VIEWER -->
<div class="errBox">
  <strong>System Status</strong>
  <div class="small">If any section fails, it will show here üëá</div>
  <div id="sys" class="small">Checking‚Ä¶</div>
</div>

<!-- SUPPORT TICKETS -->
<div class="box">
  <strong>Support Tickets</strong>
  <div class="small">Reply to user issues and mark closed</div>
  <div id="ticketStatus" style="margin-top:8px;">Loading tickets‚Ä¶</div>

  <table>
    <thead>
      <tr>
        <th>User Email</th>
        <th>Subject</th>
        <th>Message</th>
        <th>Status</th>
        <th>Admin Reply</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="ticketRows"></tbody>
  </table>
</div>

<!-- USERS -->
<div class="box">
  <strong>Users</strong>
  <div class="small">Credit or debit balances instantly</div>
  <div id="usersStatus" style="margin-top:8px;">Loading users‚Ä¶</div>

  <table>
    <thead>
      <tr>
        <th>Email</th>
        <th>Balance</th>
        <th>Amount</th>
        <th>Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="userRows"></tbody>
  </table>
</div>

<!-- INVESTMENT PLANS -->
<div class="box">
  <strong>Investment Plans</strong>
  <div class="small">Approve / complete plans and auto-credit ROI profit</div>
  <div id="planStatus" style="margin-top:8px;">Loading plans‚Ä¶</div>

  <table>
    <thead>
      <tr>
        <th>User Email</th>
        <th>Plan</th>
        <th>Amount</th>
        <th>ROI</th>
        <th>Duration</th>
        <th>Status</th>
        <th>Admin Note</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="planRows"></tbody>
  </table>
</div>

<!-- DEPOSITS -->
<div class="box">
  <strong>Deposits</strong>
  <div class="small">Approve deposit and balance auto-credits</div>
  <div id="depStatus" style="margin-top:8px;">Loading deposits‚Ä¶</div>

  <table>
    <thead>
      <tr>
        <th>User Email</th>
        <th>Asset</th>
        <th>Network</th>
        <th>Amount</th>
        <th>TX Hash</th>
        <th>Proof</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="depRows"></tbody>
  </table>
</div>

<!-- WITHDRAWALS -->
<div class="box">
  <strong>Withdrawals</strong>
  <div class="small">Approve or reject withdrawals (Approve auto-debits user balance)</div>
  <div id="wdStatus" style="margin-top:8px;">Loading withdrawals‚Ä¶</div>

  <table>
    <thead>
      <tr>
        <th>User Email</th>
        <th>Asset</th>
        <th>Network</th>
        <th>Amount</th>
        <th>Wallet Address</th>
        <th>Status</th>
        <th>Admin Note</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="wdRows"></tbody>
  </table>
</div>

<!-- PORTFOLIO MANAGER -->
<div class="box">
  <strong>Portfolio Manager</strong>
  <div class="small">Add / edit holdings with buy price + notes</div>
  <div id="pfStatus" style="margin-top:8px;">Loading portfolio‚Ä¶</div>

  <input id="pfEmail" placeholder="Search by user email" oninput="loadPortfolios()"/>

  <form onsubmit="savePortfolio(event)">
    <input type="hidden" id="pfId">
    <input id="pfUserEmail" placeholder="User Email" required>

    <select id="pfAsset" required>
      <option value="btc">BTC</option>
      <option value="eth">ETH</option>
      <option value="usdt">USDT</option>
    </select>

    <input id="pfAmount" type="number" step="0.00000001" placeholder="Amount" required>
    <input id="pfBuyPrice" type="number" step="0.01" placeholder="Buy Price in USD" required>
    <input id="pfNotes" placeholder="Notes">

    <button class="save" type="submit">Save Holding</button>
  </form>

  <table>
    <thead>
      <tr>
        <th>User Email</th>
        <th>Asset</th>
        <th>Amount</th>
        <th>Buy Price</th>
        <th>Notes</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="pfRows"></tbody>
  </table>
</div>

<!-- WALLET ADDRESS MANAGER -->
<div class="box">
  <strong>Wallet Address Manager</strong>
  <div class="small">Add / edit / delete deposit addresses</div>
  <div id="addrStatus" style="margin-top:8px;">Loading wallet addresses‚Ä¶</div>

  <form onsubmit="saveAddress(event)">
    <input type="hidden" id="editId">
    <input id="asset" placeholder="Asset (btc/eth/usdt)" required>
    <input id="network" placeholder="Network (BTC/ERC20/TRC20)" required>
    <input id="address" placeholder="Wallet Address" required>
    <button class="save" type="submit">Save Wallet</button>
  </form>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Asset</th>
        <th>Network</th>
        <th>Address</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="addrRows"></tbody>
  </table>
</div>

<script>
const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

checkSession();

function setSys(msg, ok=true){
  document.getElementById("sys").innerHTML = ok ? `<span class="ok">${msg}</span>` : `<span class="error">${msg}</span>`;
}
function badgeStatus(status){
  const s=(status||"pending").toLowerCase();
  return `<span class="pill ${s}">${s}</span>`;
}

async function checkSession(){
  try{
    const {data}=await supabaseClient.auth.getSession();
    if(!data.session){window.location.href="admin.html";return;}
    setSys("Admin authenticated ‚úÖ Loading data...");
    safeLoad(loadUsers);
    safeLoad(loadTickets);
    safeLoad(loadPlans);
    safeLoad(loadDeposits);
    safeLoad(loadWithdrawals);
    safeLoad(loadPortfolios);
    safeLoad(loadAddresses);
  }catch(e){
    setSys("Fatal Error: "+e.message,false);
  }
}

async function safeLoad(fn){
  try{ await fn(); }
  catch(e){ setSys("Error: "+e.message,false); }
}

/* SUPPORT */
async function loadTickets(){
  const status=document.getElementById("ticketStatus");
  const tbody=document.getElementById("ticketRows");

  const {data,error}=await supabaseClient.from("support_tickets").select("*").order("created_at",{ascending:false});
  if(error){status.innerHTML=`<span class="error">${error.message}</span>`; setSys("Support tickets error: "+error.message,false); return;}
  if(!data||data.length===0){status.innerHTML=`<span class="error">No tickets yet</span>`;tbody.innerHTML="";return;}
  status.innerHTML=`<span class="ok">Loaded ${data.length} ticket(s) ‚úÖ</span>`;
  tbody.innerHTML="";
  data.forEach(t=>{
    tbody.innerHTML+=`
      <tr>
        <td>${t.user_email}</td>
        <td><strong>${t.subject}</strong></td>
        <td>${t.message}</td>
        <td>${badgeStatus(t.status)}</td>
        <td><textarea id="reply-${t.id}">${t.admin_reply||""}</textarea></td>
        <td>
          <button class="approve" onclick="replyTicket('${t.id}')">Save Reply</button>
          <button class="save" onclick="closeTicket('${t.id}')">Close</button>
        </td>
      </tr>
    `;
  });
}
async function replyTicket(ticketId){
  const reply=document.getElementById(`reply-${ticketId}`).value.trim();
  const res=await supabaseClient.from("support_tickets").update({admin_reply:reply}).eq("id",ticketId);
  if(res.error){alert("‚ùå "+res.error.message);return;}
  alert("‚úÖ Reply saved!");
  loadTickets();
}
async function closeTicket(ticketId){
  const reply=document.getElementById(`reply-${ticketId}`).value.trim();
  const res=await supabaseClient.from("support_tickets").update({admin_reply:reply,status:"closed"}).eq("id",ticketId);
  if(res.error){alert("‚ùå "+res.error.message);return;}
  alert("‚úÖ Ticket closed!");
  loadTickets();
}

/* USERS */
async function loadUsers(){
  const status=document.getElementById("usersStatus");
  const tbody=document.getElementById("userRows");

  const {data,error}=await supabaseClient.from("users").select("*").order("created_at",{ascending:false});
  if(error){status.innerHTML=`<span class="error">${error.message}</span>`; setSys("Users error: "+error.message,false); return;}
  if(!data||data.length===0){status.innerHTML=`<span class="error">No users found</span>`;tbody.innerHTML="";return;}

  status.innerHTML=`<span class="ok">Loaded ${data.length} user(s) ‚úÖ</span>`;
  tbody.innerHTML="";
  data.forEach(u=>{
    tbody.innerHTML+=`
      <tr>
        <td>${u.email||""}</td>
        <td><strong>${Number(u.balance||0).toFixed(2)}</strong></td>
        <td><input type="number" step="0.01" id="amt-${u.id}"></td>
        <td><input id="note-${u.id}" value="${u.notes||""}"></td>
        <td>
          <button class="credit" onclick="credit('${u.id}')">Credit</button>
          <button class="debit" onclick="debit('${u.id}')">Debit</button>
        </td>
      </tr>`;
  });
}
async function credit(id){
  const amt=Number(document.getElementById(`amt-${id}`).value||0);
  const notes=document.getElementById(`note-${id}`).value;
  if(amt<=0){alert("Enter amount");return;}
  const {data:u,error:e}=await supabaseClient.from("users").select("balance").eq("id",id).single();
  if(e){alert(e.message);return;}
  const newBal=Number(u.balance||0)+amt;
  const res=await supabaseClient.from("users").update({balance:newBal,notes}).eq("id",id);
  if(res.error){alert(res.error.message);return;}
  alert("‚úÖ Credited"); loadUsers();
}
async function debit(id){
  const amt=Number(document.getElementById(`amt-${id}`).value||0);
  const notes=document.getElementById(`note-${id}`).value;
  if(amt<=0){alert("Enter amount");return;}
  const {data:u,error:e}=await supabaseClient.from("users").select("balance").eq("id",id).single();
  if(e){alert(e.message);return;}
  const newBal=Math.max(0,Number(u.balance||0)-amt);
  const res=await supabaseClient.from("users").update({balance:newBal,notes}).eq("id",id);
  if(res.error){alert(res.error.message);return;}
  alert("‚úÖ Debited"); loadUsers();
}

/* PLANS */
async function loadPlans(){
  const status=document.getElementById("planStatus");
  const tbody=document.getElementById("planRows");

  const {data,error}=await supabaseClient.from("investment_plans").select("*").order("created_at",{ascending:false});
  if(error){status.innerHTML=`<span class="error">${error.message}</span>`; setSys("Plans error: "+error.message,false); return;}
  if(!data||data.length===0){status.innerHTML=`<span class="error">No plans yet</span>`;tbody.innerHTML="";return;}

  status.innerHTML=`<span class="ok">Loaded ${data.length} plan(s) ‚úÖ</span>`;
  tbody.innerHTML="";

  data.forEach(p=>{
    tbody.innerHTML+=`
      <tr>
        <td>${p.user_email}</td>
        <td><strong>${p.plan_name}</strong></td>
        <td>$${Number(p.amount||0).toFixed(2)}</td>
        <td>${p.roi_percent}%</td>
        <td>${p.duration_days} days</td>
        <td>${badgeStatus(p.status)}</td>
        <td><input id="plan-note-${p.id}" value="${p.admin_note||""}"></td>
        <td>
          <button class="approve" onclick="approvePlan('${p.id}')">Approve</button>
          <button class="approve" onclick="completePlan('${p.id}','${p.user_email}',${p.amount},${p.roi_percent})">Complete</button>
          <button class="reject" onclick="rejectPlan('${p.id}')">Reject</button>
        </td>
      </tr>`;
  });
}
async function approvePlan(planId){
  const note=document.getElementById(`plan-note-${planId}`).value;
  const res=await supabaseClient.from("investment_plans").update({status:"active",admin_note:note}).eq("id",planId);
  if(res.error){alert("‚ùå "+res.error.message);return;}
  alert("‚úÖ Approved");
  loadPlans();
}
async function rejectPlan(planId){
  const note=document.getElementById(`plan-note-${planId}`).value;
  const res=await supabaseClient.from("investment_plans").update({status:"rejected",admin_note:note}).eq("id",planId);
  if(res.error){alert("‚ùå "+res.error.message);return;}
  alert("‚úÖ Rejected");
  loadPlans();
}
async function completePlan(planId,userEmail,amount,roi){
  const note=document.getElementById(`plan-note-${planId}`).value;
  if(!confirm("Complete plan and credit ROI profit?")) return;

  const {data:user,error:userErr}=await supabaseClient.from("users").select("*").eq("email",userEmail).single();
  if(userErr){alert("‚ùå User not found");return;}

  const profit = Number(amount||0) * (Number(roi||0)/100);
  const newBalance = Number(user.balance||0) + profit;

  const {error:balErr}=await supabaseClient.from("users").update({balance:newBalance}).eq("id",user.id);
  if(balErr){alert("‚ùå "+balErr.message);return;}

  const {error:planErr}=await supabaseClient.from("investment_plans").update({status:"completed",admin_note:note}).eq("id",planId);
  if(planErr){alert("‚ùå "+planErr.message);return;}

  alert("‚úÖ Completed + Profit credited!");
  loadUsers(); loadPlans();
}

/* DEPOSITS */
async function loadDeposits(){
  const status=document.getElementById("depStatus");
  const tbody=document.getElementById("depRows");

  const {data,error}=await supabaseClient.from("deposit_confirmations").select("*").order("created_at",{ascending:false});
  if(error){status.innerHTML=`<span class="error">${error.message}</span>`; setSys("Deposits error: "+error.message,false); return;}
  if(!data||data.length===0){status.innerHTML=`<span class="error">No deposits</span>`;tbody.innerHTML="";return;}

  status.innerHTML=`<span class="ok">Loaded ${data.length} deposits ‚úÖ</span>`;
  tbody.innerHTML="";
  data.forEach(d=>{
    const proofLink=`${SUPABASE_URL}/storage/v1/object/public/${d.proof_url}`;
    tbody.innerHTML+=`
      <tr>
        <td>${d.user_email||"-"}</td>
        <td>${d.asset}</td>
        <td>${d.network}</td>
        <td>${d.amount}</td>
        <td>${d.tx_hash}</td>
        <td><a href="${proofLink}" target="_blank">View</a></td>
        <td><strong>${d.status||"pending"}</strong></td>
        <td>
          <button class="approve" onclick="approveAndCredit('${d.id}','${d.user_email}',${d.amount})">Approve</button>
          <button class="reject" onclick="updateDeposit('${d.id}','rejected')">Reject</button>
        </td>
      </tr>`;
  });
}
async function updateDeposit(id,status){
  const res=await supabaseClient.from("deposit_confirmations").update({status}).eq("id",id);
  if(res.error){alert(res.error.message);return;}
  alert("‚úÖ Deposit updated");
  loadDeposits(); loadUsers();
}
async function approveAndCredit(depositId,userEmail,amount){
  if(!userEmail||userEmail==="-"){alert("No user_email");return;}
  const {data:user,error:userErr}=await supabaseClient.from("users").select("*").eq("email",userEmail).single();
  if(userErr){alert("User not found");return;}

  const newBalance=Number(user.balance||0)+Number(amount||0);
  const {error:balErr}=await supabaseClient.from("users").update({balance:newBalance}).eq("id",user.id);
  if(balErr){alert(balErr.message);return;}

  const {error:depErr}=await supabaseClient.from("deposit_confirmations").update({status:"approved"}).eq("id",depositId);
  if(depErr){alert(depErr.message);return;}

  alert("‚úÖ Approved + credited");
  loadDeposits(); loadUsers();
}

/* WITHDRAWALS */
async function loadWithdrawals(){
  const status=document.getElementById("wdStatus");
  const tbody=document.getElementById("wdRows");

  const {data,error}=await supabaseClient.from("withdrawals").select("*").order("created_at",{ascending:false});
  if(error){status.innerHTML=`<span class="error">${error.message}</span>`; setSys("Withdrawals error: "+error.message,false); return;}
  if(!data||data.length===0){status.innerHTML=`<span class="error">No withdrawals</span>`;tbody.innerHTML="";return;}

  status.innerHTML=`<span class="ok">Loaded ${data.length} withdrawals ‚úÖ</span>`;
  tbody.innerHTML="";
  data.forEach(w=>{
    tbody.innerHTML+=`
      <tr>
        <td>${w.user_email}</td>
        <td>${w.asset}</td>
        <td>${w.network}</td>
        <td>${w.amount}</td>
        <td>${w.wallet_address}</td>
        <td><strong>${w.status||"pending"}</strong></td>
        <td><input id="note-${w.id}" value="${w.admin_note||""}"></td>
        <td>
          <button class="approve" onclick="approveWithdrawal('${w.id}','${w.user_email}',${w.amount})">Approve</button>
          <button class="reject" onclick="updateWithdrawal('${w.id}','rejected')">Reject</button>
        </td>
      </tr>`;
  });
}
async function updateWithdrawal(id,status){
  const note=document.getElementById(`note-${id}`).value;
  const res=await supabaseClient.from("withdrawals").update({status,admin_note:note}).eq("id",id);
  if(res.error){alert(res.error.message);return;}
  alert("‚úÖ Updated");
  loadWithdrawals();
}
async function approveWithdrawal(withdrawalId,userEmail,amount){
  const note=document.getElementById(`note-${withdrawalId}`).value;
  if(!confirm("Approve withdrawal & debit user?")) return;

  const {data:user,error:userErr}=await supabaseClient.from("users").select("*").eq("email",userEmail).single();
  if(userErr){alert("User not found");return;}

  const currentBalance=Number(user.balance||0);
  const withdrawAmt=Number(amount||0);

  if(currentBalance < withdrawAmt){alert("‚ùå Insufficient balance"); return;}

  const newBalance=currentBalance - withdrawAmt;
  const {error:balErr}=await supabaseClient.from("users").update({balance:newBalance}).eq("id",user.id);
  if(balErr){alert(balErr.message);return;}

  const {error:wdErr}=await supabaseClient.from("withdrawals").update({status:"approved",admin_note:note}).eq("id",withdrawalId);
  if(wdErr){alert(wdErr.message);return;}

  alert("‚úÖ Approved + debited");
  loadUsers(); loadWithdrawals();
}

/* PORTFOLIO */
async function loadPortfolios(){
  const status=document.getElementById("pfStatus");
  const tbody=document.getElementById("pfRows");
  const search=document.getElementById("pfEmail").value.trim();

  let query=supabaseClient.from("portfolios").select("*").order("created_at",{ascending:false});
  if(search.length>2){ query=query.ilike("user_email", `%${search}%`); }

  const {data,error}=await query;
  if(error){status.innerHTML=`<span class="error">${error.message}</span>`; setSys("Portfolio error: "+error.message,false); return;}
  if(!data||data.length===0){status.innerHTML=`<span class="error">No holdings found</span>`;tbody.innerHTML="";return;}

  status.innerHTML=`<span class="ok">Loaded ${data.length} holding(s) ‚úÖ</span>`;
  tbody.innerHTML="";
  data.forEach(p=>{
    tbody.innerHTML+=`
      <tr>
        <td>${p.user_email}</td>
        <td>${(p.asset||"").toUpperCase()}</td>
        <td>${p.amount}</td>
        <td>$${Number(p.buy_price||0).toFixed(2)}</td>
        <td>${p.notes||"-"}</td>
        <td>
          <button class="edit" onclick="editPortfolio('${p.id}','${p.user_email}','${p.asset}','${p.amount}','${p.buy_price}','${(p.notes||"").replace(/'/g,"")}')">Edit</button>
          <button class="danger" onclick="deletePortfolio('${p.id}')">Delete</button>
        </td>
      </tr>
    `;
  });
}
function editPortfolio(id,email,asset,amount,buy,notes){
  document.getElementById("pfId").value=id;
  document.getElementById("pfUserEmail").value=email;
  document.getElementById("pfAsset").value=(asset||"").toLowerCase();
  document.getElementById("pfAmount").value=amount;
  document.getElementById("pfBuyPrice").value=buy;
  document.getElementById("pfNotes").value=notes||"";
}
async function savePortfolio(e){
  e.preventDefault();
  const id=document.getElementById("pfId").value;
  const user_email=document.getElementById("pfUserEmail").value.trim();
  const asset=document.getElementById("pfAsset").value.trim().toLowerCase();
  const amount=Number(document.getElementById("pfAmount").value||0);
  const buy_price=Number(document.getElementById("pfBuyPrice").value||0);
  const notes=document.getElementById("pfNotes").value.trim();

  if(amount<=0||buy_price<=0){alert("Amount and buy price required");return;}

  let res;
  if(id){
    res=await supabaseClient.from("portfolios").update({user_email,asset,amount,buy_price,notes}).eq("id",id);
  }else{
    res=await supabaseClient.from("portfolios").insert([{user_email,asset,amount,buy_price,notes}]);
  }
  if(res.error){alert("‚ùå "+res.error.message);return;}
  alert("‚úÖ Holding saved");
  document.getElementById("pfId").value="";
  e.target.reset();
  loadPortfolios();
}
async function deletePortfolio(id){
  if(!confirm("Delete holding?")) return;
  const res=await supabaseClient.from("portfolios").delete().eq("id",id);
  if(res.error){alert("‚ùå "+res.error.message);return;}
  alert("‚úÖ Deleted");
  loadPortfolios();
}

/* WALLETS */
async function loadAddresses(){
  const status=document.getElementById("addrStatus");
  const tbody=document.getElementById("addrRows");

  const {data,error}=await supabaseClient.from("deposit_addresses").select("id,asset,network,address").order("id",{ascending:true});
  if(error){status.innerHTML=`<span class="error">${error.message}</span>`; setSys("Wallet error: "+error.message,false); return;}

  status.innerHTML=`<span class="ok">Loaded ${data.length} wallet(s) ‚úÖ</span>`;
  tbody.innerHTML="";
  data.forEach(a=>{
    tbody.innerHTML+=`
      <tr>
        <td>${a.id}</td>
        <td>${a.asset}</td>
        <td>${a.network}</td>
        <td>${a.address}</td>
        <td>
          <button class="edit" onclick="editAddress('${a.id}','${a.asset}','${a.network}','${a.address}')">Edit</button>
          <button class="danger" onclick="deleteAddress('${a.id}')">Delete</button>
        </td>
      </tr>`;
  });
}
function editAddress(id,asset,network,address){
  document.getElementById("editId").value=id;
  document.getElementById("asset").value=asset;
  document.getElementById("network").value=network;
  document.getElementById("address").value=address;
}
async function saveAddress(e){
  e.preventDefault();
  const id=document.getElementById("editId").value;
  const asset=document.getElementById("asset").value.trim().toLowerCase();
  const network=document.getElementById("network").value.trim().toUpperCase();
  const address=document.getElementById("address").value.trim();

  let res;
  if(id){
    res=await supabaseClient.from("deposit_addresses").update({asset,network,address}).eq("id",id);
  }else{
    res=await supabaseClient.from("deposit_addresses").insert([{asset,network,address}]);
  }
  if(res.error){alert("‚ùå "+res.error.message);return;}

  alert("‚úÖ Wallet saved");
  document.getElementById("editId").value="";
  e.target.reset();
  loadAddresses();
}
async function deleteAddress(id){
  if(!confirm("Delete wallet?")) return;
  const res=await supabaseClient.from("deposit_addresses").delete().eq("id",id);
  if(res.error){alert("‚ùå "+res.error.message);return;}
  alert("‚úÖ Deleted");
  loadAddresses();
}

/* LOGOUT */
async function logout(){
  await supabaseClient.auth.signOut();
  window.location.href="admin.html";
}
</script>

</body>
</html>
