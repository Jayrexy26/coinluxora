<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coinluxora Admin Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      margin:0;
      font-family:system-ui;
      background:#020617;
      color:#e5e7eb;
      padding:16px;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 0;
      border-bottom:1px solid #1e293b;
      margin-bottom:12px;
    }
    button{
      border:none;
      padding:10px 14px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      color:#020617;
    }
    .logout{background:#38bdf8}
    .save{background:#22c55e}
    .danger{background:#f87171}
    .edit{background:#facc15;margin-right:8px}

    .box{
      border:1px solid #1e293b;
      border-radius:12px;
      padding:12px;
      margin-bottom:16px;
      background:#020617;
    }
    .ok{color:#22c55e}
    .error{color:#f87171}
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
    }
    th,td{
      border:1px solid #1e293b;
      padding:10px;
      font-size:13px;
      word-break:break-all;
    }
    th{background:#0b1224}
    input{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #1e293b;
      background:#020617;
      color:#e5e7eb;
      font-size:13px;
      margin-bottom:8px;
    }
    form{
      border:1px solid #1e293b;
      border-radius:12px;
      padding:12px;
      margin-top:12px;
    }
  </style>
</head>

<body>

<header>
  <strong>Coinluxora Admin Dashboard</strong>
  <button class="logout" onclick="logout()">Logout</button>
</header>

<!-- WALLET ADDRESS MANAGER -->
<div class="box">
  <strong>Deposit Wallet Address Manager</strong>
  <div id="status" style="margin-top:8px;">Loading…</div>

  <form onsubmit="saveAddress(event)">
    <input type="hidden" id="editId">
    <input id="asset" placeholder="Asset (btc / eth / usdt)" required>
    <input id="network" placeholder="Network (BTC / ERC20 / TRC20)" required>
    <input id="address" placeholder="Wallet Address" required>
    <button class="save" type="submit">Save Wallet</button>
  </form>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Asset</th>
        <th>Network</th>
        <th>Address</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
  const SUPABASE_URL = "https://xdcscknfomlzwysczegc.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  checkSession();

  async function checkSession(){
    const { data } = await supabaseClient.auth.getSession();
    if(!data.session){
      window.location.href="admin.html";
      return;
    }
    loadAddresses();
  }

  async function loadAddresses(){
    const status=document.getElementById("status");
    const tbody=document.getElementById("rows");

    const { data, error } = await supabaseClient
      .from("deposit_addresses")
      .select("id, asset, network, address")
      .order("id",{ascending:true});

    console.log("LOAD:", data, error);

    if(error){
      status.innerHTML=`<span class="error">Error loading: ${error.message}</span>`;
      return;
    }

    status.innerHTML=`<span class="ok">Loaded ${data.length} wallet(s) ✅</span>`;
    tbody.innerHTML="";

    data.forEach(a=>{
      tbody.innerHTML+=`
      <tr>
        <td>${a.id}</td>
        <td>${a.asset}</td>
        <td>${a.network}</td>
        <td>${a.address}</td>
        <td>
          <button class="edit" onclick="editAddress('${a.id}','${a.asset}','${a.network}','${a.address}')">Edit</button>
          <button class="danger" onclick="deleteAddress('${a.id}')">Delete</button>
        </td>
      </tr>`;
    });
  }

  function editAddress(id,asset,network,address){
    document.getElementById("editId").value=id;
    document.getElementById("asset").value=asset;
    document.getElementById("network").value=network;
    document.getElementById("address").value=address;
  }

  async function saveAddress(e){
    e.preventDefault();

    const id=document.getElementById("editId").value;
    const asset=document.getElementById("asset").value.trim().toLowerCase();
    const network=document.getElementById("network").value.trim().toUpperCase();
    const address=document.getElementById("address").value.trim();

    let res;

    if(id){
      res = await supabaseClient
        .from("deposit_addresses")
        .update({ asset, network, address })
        .eq("id", id);
    }else{
      res = await supabaseClient
        .from("deposit_addresses")
        .insert([{ asset, network, address }]);
    }

    console.log("SAVE:", res);

    if(res.error){
      alert("❌ Save failed: " + res.error.message);
      return;
    }

    alert("✅ Saved successfully!");
    document.getElementById("editId").value="";
    e.target.reset();
    loadAddresses();
  }

  async function deleteAddress(id){
    if(!confirm("Delete this wallet address?")) return;

    const res = await supabaseClient
      .from("deposit_addresses")
      .delete()
      .eq("id", id);

    console.log("DELETE:", res);

    if(res.error){
      alert("❌ Delete failed: " + res.error.message);
      return;
    }

    alert("✅ Deleted successfully!");
    loadAddresses();
  }

  async function logout(){
    await supabaseClient.auth.signOut();
    window.location.href="admin.html";
  }
</script>

</body>
</html>
