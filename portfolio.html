<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Portfolio</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#020617;color:#e5e7eb;padding:16px}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid #1e293b;margin-bottom:14px}
button{border:none;padding:10px 14px;border-radius:10px;font-weight:900;cursor:pointer;background:#38bdf8;color:#020617}
.box{border:1px solid #1e293b;border-radius:12px;padding:14px;background:#020617;margin-bottom:16px}
h2{margin:0;font-size:18px}
.big{font-size:30px;font-weight:1000;margin-top:10px}
.small{color:#94a3b8;font-size:12px;margin-top:6px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
.card{border:1px solid #1e293b;border-radius:12px;padding:12px}
.ok{color:#22c55e}
.err{color:#f87171}
.neutral{color:#38bdf8}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #1e293b;padding:10px;font-size:13px;word-break:break-word}
th{background:#0b1224}
.progress{height:8px;border-radius:999px;background:#1e293b;margin-top:8px;overflow:hidden}
.bar{height:8px;background:#22c55e}
.barLoss{height:8px;background:#f87171}
.tag{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;margin-top:8px}
.tagProfit{background:#22c55e;color:#020617}
.tagLoss{background:#f87171;color:#020617}
.tagFlat{background:#38bdf8;color:#020617}
</style>
</head>

<body>

<header>
  <strong>My Portfolio</strong>
  <button onclick="goDashboard()">Dashboard</button>
</header>

<div class="box">
  <h2>Total Portfolio</h2>
  <div id="total" class="big">--</div>
  <div id="email" class="small">Loading…</div>

  <div class="grid">
    <div class="card">
      <div class="small">Total Invested</div>
      <div id="invested" style="font-size:20px;font-weight:1000;margin-top:6px;">--</div>
    </div>
    <div class="card">
      <div class="small">Total Profit / Loss</div>
      <div id="pnl" style="font-size:20px;font-weight:1000;margin-top:6px;">--</div>
      <div id="roi" class="small"></div>
    </div>
  </div>
</div>

<div class="box">
  <h2>Allocation</h2>
  <div id="alloc" class="grid">
    <div class="card">Loading…</div>
  </div>
</div>

<div class="box">
  <h2>Holdings (P&L)</h2>
  <div id="msg" class="small">Loading…</div>

  <table>
    <thead>
      <tr>
        <th>Asset</th>
        <th>Amount</th>
        <th>Buy Price</th>
        <th>Current Price</th>
        <th>Invested</th>
        <th>Value</th>
        <th>P/L</th>
        <th>ROI</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

function goDashboard(){ window.location.href="user-dashboard.html"; }

let userEmail="";

init();

function money(n){
  const v = Number(n||0);
  return "$" + v.toFixed(2);
}
function pct(n){
  const v = Number(n||0);
  return v.toFixed(2) + "%";
}

async function init(){
  const { data:userData } = await supabaseClient.auth.getUser();
  if(!userData.user){
    document.body.innerHTML="<h2 style='color:white'>You must login first.</h2>";
    return;
  }

  userEmail = userData.user.email;
  document.getElementById("email").innerHTML=`Logged in as: <span class="ok">${userEmail}</span>`;

  // Get holdings
  const { data:holdings, error } = await supabaseClient
    .from("portfolios")
    .select("*")
    .eq("user_email", userEmail)
    .order("created_at",{ascending:false});

  if(error){
    document.getElementById("msg").innerHTML="<span class='err'>"+error.message+"</span>";
    return;
  }

  if(!holdings || holdings.length===0){
    document.getElementById("total").innerHTML="$0.00";
    document.getElementById("alloc").innerHTML="<div class='card err'>No holdings yet</div>";
    document.getElementById("msg").innerHTML="<span class='err'>No holdings found. Admin must add holdings in portfolio manager.</span>";
    document.getElementById("rows").innerHTML="";
    document.getElementById("invested").innerHTML="$0.00";
    document.getElementById("pnl").innerHTML="$0.00";
    document.getElementById("roi").innerHTML="";
    return;
  }

  // Aggregate holdings by asset but keep buy_price/notes row-level for table
  const assetAgg = {};
  const idsMap = { btc:"bitcoin", eth:"ethereum", usdt:"tether" };

  holdings.forEach(h=>{
    const asset=(h.asset||"").toLowerCase();
    if(!assetAgg[asset]) assetAgg[asset]=0;
    assetAgg[asset]+=Number(h.amount||0);
  });

  const ids = Object.keys(assetAgg).map(a=>idsMap[a]).filter(Boolean).join(",");
  const pricesRes = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`);
  const prices = await pricesRes.json();

  // Build table rows
  let totalValue=0;
  let totalInvested=0;

  const tbody=document.getElementById("rows");
  tbody.innerHTML="";

  holdings.forEach(h=>{
    const asset=(h.asset||"").toLowerCase();
    const amount=Number(h.amount||0);
    const buy=Number(h.buy_price||0);

    const id=idsMap[asset];
    const current=Number(prices?.[id]?.usd || 0);

    const invested=amount*buy;
    const value=amount*current;
    const pnl=value-invested;
    const roi = invested>0 ? (pnl/invested)*100 : 0;

    totalValue += value;
    totalInvested += invested;

    const pnlClass = pnl>0 ? "tagProfit" : (pnl<0 ? "tagLoss" : "tagFlat");
    const pnlTextClass = pnl>0 ? "ok" : (pnl<0 ? "err" : "neutral");

    tbody.innerHTML += `
      <tr>
        <td><strong>${asset.toUpperCase()}</strong></td>
        <td>${amount}</td>
        <td>${money(buy)}</td>
        <td>${money(current)}</td>
        <td><strong>${money(invested)}</strong></td>
        <td><strong>${money(value)}</strong></td>
        <td>
          <span class="tag ${pnlClass}">${pnl>=0?"+":""}${money(pnl).replace("$","$")}</span>
        </td>
        <td class="${pnlTextClass}"><strong>${roi>=0?"+":""}${pct(roi)}</strong></td>
        <td>${h.notes || "-"}</td>
      </tr>
    `;
  });

  // Totals
  document.getElementById("total").innerHTML = money(totalValue);
  document.getElementById("invested").innerHTML = money(totalInvested);

  const totalPnL = totalValue-totalInvested;
  const totalROI = totalInvested>0 ? (totalPnL/totalInvested)*100 : 0;

  const pnlElem=document.getElementById("pnl");
  pnlElem.innerHTML = (totalPnL>=0?"+":"") + money(totalPnL);
  pnlElem.className = totalPnL>0 ? "ok" : (totalPnL<0 ? "err" : "neutral");

  document.getElementById("roi").innerHTML = `ROI: <strong>${totalROI>=0?"+":""}${pct(totalROI)}</strong>`;
  document.getElementById("msg").innerHTML = "<span class='ok'>Portfolio loaded ✅</span>";

  // Allocation cards
  const alloc=document.getElementById("alloc");
  alloc.innerHTML="";

  Object.keys(assetAgg).forEach(asset=>{
    const id=idsMap[asset];
    const current=Number(prices?.[id]?.usd || 0);
    const amount=Number(assetAgg[asset]||0);
    const value=amount*current;
    const percent = totalValue>0 ? (value/totalValue)*100 : 0;

    alloc.innerHTML += `
      <div class="card">
        <strong>${asset.toUpperCase()}</strong>
        <div class="small">${percent.toFixed(2)}% allocation</div>
        <div style="margin-top:8px;font-weight:1000">${money(value)}</div>
        <div class="progress">
          <div class="bar" style="width:${Math.min(100,percent)}%"></div>
        </div>
      </div>
    `;
  });
}
</script>

</body>
</html>
