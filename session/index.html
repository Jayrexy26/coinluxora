<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Secure Authentication | Coinluxora</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#050a18;
      --stroke:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.65);
      --danger:#ef4444;
      --ok:#22c55e;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(1200px 800px at 50% 20%, rgba(139,211,255,.10), transparent 55%) , var(--bg);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      padding:24px;
    }

    .card{
      width:min(520px, 100%);
      background:rgba(11,18,38,.86);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:22px 22px 18px;
      box-shadow:0 16px 50px rgba(0,0,0,.45);
      position:relative;
      overflow:hidden;
      isolation:isolate;
    }

    .card:before{
      content:"";
      position:absolute;
      inset:-120px -160px auto -160px;
      height:260px;
      background:radial-gradient(circle at 50% 40%, rgba(139,211,255,.18), transparent 60%);
      pointer-events:none;
      z-index:0;
    }

    .layer{ position:relative; z-index:2; }

    .top{
      display:flex;
      align-items:center;
      gap:14px;
    }

    .avatar{
      width:54px;
      height:54px;
      border-radius:50%;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
      flex:0 0 auto;
    }

    .avatar img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      display:none;
    }

    .avatar svg{ width:34px; height:34px; opacity:.9; }

    .who{ display:flex; flex-direction:column; gap:2px; }
    .name{ font-weight:700; letter-spacing:.2px; }
    .email{ font-size:.92rem; color:var(--muted); }

    .divider{
      height:1px;
      background:var(--stroke);
      margin:18px 0 16px;
    }

    h1{
      margin:0;
      font-size:1.75rem;
      letter-spacing:.2px;
    }
    .sub{
      margin:8px 0 0;
      color:var(--muted);
      font-size:1.02rem;
    }

    /* ✅ ONLY ROUND DOTS (NO SQUARE BOXES) */
    .pinDots{
      margin:22px 0 20px;
      display:flex;
      justify-content:center;
      gap:18px;
    }
    .dot{
      width:16px;
      height:16px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.20);
      transition:.12s ease;
    }
    .dot.filled{
      background:rgba(255,255,255,.92);
      border-color:rgba(255,255,255,.92);
      transform:scale(1.08);
    }

    .pad{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:14px;
      max-width:320px;
      margin:0 auto 18px;
      position:relative;
      z-index:5;
    }

    .key{
      height:64px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.90);
      color:#0a0f1f;
      font-weight:800;
      font-size:1.25rem;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .key:active{ transform:scale(.98); }

    .key.ghost{
      background:transparent;
      color:rgba(255,255,255,.75);
    }

    .btn{
      width:100%;
      height:52px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.10);
      color:rgba(234,240,255,.55);
      font-weight:800;
      letter-spacing:.6px;
      cursor:not-allowed;
    }
    .btn.ready{
      background:rgba(255,255,255,.16);
      color:var(--text);
      cursor:pointer;
    }

    .smallActions{
      display:flex;
      justify-content:center;
      gap:12px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .linkBtn{
      background:transparent;
      border:none;
      color:rgba(139,211,255,.90);
      cursor:pointer;
      font-weight:700;
      font-size:.95rem;
    }

    /* ✅ POPUP MODAL */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:18px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .overlay.show{ display:flex; }

    .modal{
      width:min(420px, 100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(11,18,38,.92);
      box-shadow:0 28px 90px rgba(0,0,0,.60);
      padding:20px 18px 18px;
      position:relative;
      overflow:hidden;
    }

    .modal:before{
      content:"";
      position:absolute;
      inset:-120px -140px auto -140px;
      height:240px;
      background:radial-gradient(circle at 50% 45%, rgba(255,255,255,.12), transparent 60%);
      pointer-events:none;
    }

    .modalInner{
      position:relative;
      z-index:2;
      text-align:center;
    }

    .statusCircle{
      width:66px;
      height:66px;
      border-radius:999px;
      margin:6px auto 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 16px 55px rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
    }
    .statusCircle.ok{
      border-color:rgba(34,197,94,.35);
      background:rgba(34,197,94,.18);
      box-shadow:0 16px 55px rgba(34,197,94,.18);
    }
    .statusCircle.err{
      border-color:rgba(239,68,68,.40);
      background:rgba(239,68,68,.16);
      box-shadow:0 16px 55px rgba(239,68,68,.16);
    }
    .statusCircle svg{ width:34px; height:34px; }

    .modalTitle{
      font-weight:900;
      font-size:1.5rem;
      letter-spacing:.2px;
      margin:0;
    }
    .modalSub{
      margin:10px 0 0;
      color:rgba(234,240,255,.72);
      font-size:1.02rem;
    }
  </style>
</head>

<body>

  <div class="card">
    <div class="layer">

      <div class="top">
        <div class="avatar">
          <img id="avatarImg" alt="Profile"/>
          <svg id="avatarIcon" viewBox="0 0 24 24" fill="none">
            <path d="M12 12c2.76 0 5-2.24 5-5S14.76 2 12 2 7 4.24 7 7s2.24 5 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z" fill="currentColor" opacity=".85"/>
          </svg>
        </div>

        <div class="who">
          <div class="name" id="userName">Loading...</div>
          <div class="email" id="userEmail"></div>
        </div>
      </div>

      <div class="divider"></div>

      <h1>Secure Authentication</h1>
      <div class="sub" id="subText">Please verify your 4-digit PIN code</div>

      <!-- ✅ only dots now -->
      <div class="pinDots" id="pinDots">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>

      <div class="pad" id="pad">
        <button type="button" class="key" data-num="7">7</button>
        <button type="button" class="key" data-num="0">0</button>
        <button type="button" class="key" data-num="1">1</button>

        <button type="button" class="key" data-num="2">2</button>
        <button type="button" class="key" data-num="3">3</button>
        <button type="button" class="key" data-num="8">8</button>

        <button type="button" class="key" data-num="4">4</button>
        <button type="button" class="key" data-num="5">5</button>
        <button type="button" class="key" data-num="6">6</button>

        <button type="button" class="key" data-num="9">9</button>
        <button type="button" class="key ghost" data-action="backspace">⌫</button>
        <button type="button" class="key ghost" data-action="clear">Clear</button>
      </div>

      <div>
        <button type="button" class="btn" id="verifyBtn" disabled>VERIFY</button>
      </div>

      <div class="smallActions">
        <button type="button" class="linkBtn" id="logoutBtn">Log out</button>
      </div>

    </div>
  </div>

  <!-- ✅ Popup -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modalInner">
        <div class="statusCircle" id="statusCircle"></div>
        <h2 class="modalTitle" id="modalTitle"></h2>
        <div class="modalSub" id="modalSub"></div>
      </div>
    </div>
  </div>

<script>
  const pad = document.getElementById("pad");
  const verifyBtn = document.getElementById("verifyBtn");
  const subText = document.getElementById("subText");
  const userName = document.getElementById("userName");
  const userEmail = document.getElementById("userEmail");
  const logoutBtn = document.getElementById("logoutBtn");

  const dots = Array.from(document.querySelectorAll(".dot"));

  const avatarImg = document.getElementById("avatarImg");
  const avatarIcon = document.getElementById("avatarIcon");

  const overlay = document.getElementById("overlay");
  const statusCircle = document.getElementById("statusCircle");
  const modalTitle = document.getElementById("modalTitle");
  const modalSub = document.getElementById("modalSub");

  let input = "";
  let mode = "verify";
  let pinHashFromDb = null;
  let user = null;
  let supabaseClient = null;
  let isBusy = false;

  function setVerifyReady(ready){
    verifyBtn.disabled = !ready;
    verifyBtn.classList.toggle("ready", !!ready);
  }

  function renderDots(){
    dots.forEach((d, i)=> d.classList.toggle("filled", i < input.length));
    setVerifyReady(input.length === 4 && !isBusy);
  }

  function resetInput(){
    input = "";
    renderDots();
  }

  function addDigit(n){
    if(isBusy) return;
    if(input.length >= 4) return;
    input += String(n);
    renderDots();
    if(input.length === 4){
      setTimeout(()=> verifyBtn.click(), 120);
    }
  }

  pad.addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;

    const num = btn.getAttribute("data-num");
    const action = btn.getAttribute("data-action");

    if(num !== null){
      addDigit(num);
      return;
    }

    if(action === "backspace"){
      if(isBusy) return;
      input = input.slice(0, -1);
      renderDots();
      return;
    }

    if(action === "clear"){
      if(isBusy) return;
      resetInput();
      return;
    }
  });

  function showPopup(type, title, sub){
    statusCircle.className = "statusCircle " + type;
    modalTitle.textContent = title;
    modalSub.textContent = sub;

    if(type === "ok"){
      statusCircle.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M20 6 9 17l-5-5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`;
    }else{
      statusCircle.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M6 6l12 12M18 6 6 18" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
        </svg>`;
    }

    overlay.classList.add("show");
  }

  function hidePopup(){
    overlay.classList.remove("show");
  }

  // Supabase
  const SUPABASE_URL = "https://xdcscknfomlzwysczegc.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";

  async function sha256(str){
    const data = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
  }

  function applyAvatarPhoto(u){
    const meta = u?.user_metadata || {};
    const photo = meta.avatar_url || meta.picture || meta.photoURL || meta.profile_photo || "";
    if(photo){
      avatarImg.src = photo;
      avatarImg.style.display = "block";
      avatarIcon.style.display = "none";
      avatarImg.onerror = () => {
        avatarImg.style.display = "none";
        avatarIcon.style.display = "block";
      };
    }
  }

  async function init(){
    try{
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      await new Promise(r => setTimeout(r, 150));
      const { data: sessData } = await supabaseClient.auth.getSession();
      const session = sessData?.session;

      if(!session?.user){
        window.location.href = "/login.html";
        return;
      }

      user = session.user;

      userEmail.textContent = user.email || "";
      userName.textContent = (user.user_metadata?.full_name || user.user_metadata?.name || "User");
      applyAvatarPhoto(user);

      const { data, error } = await supabaseClient
        .from("user_pins")
        .select("pin_hash")
        .eq("user_id", user.id)
        .maybeSingle();

      if(error){
        console.error(error);
        return;
      }

      if(!data){
        mode = "create";
        pinHashFromDb = null;
        subText.textContent = "Create your new 4-digit PIN";
      } else {
        mode = "verify";
        pinHashFromDb = data.pin_hash;
        subText.textContent = "Please verify your 4-digit PIN code";
      }

      resetInput();
    }catch(err){
      console.error(err);
    }
  }

  verifyBtn.addEventListener("click", async ()=>{
    if(isBusy) return;
    if(input.length !== 4) return;
    if(!supabaseClient || !user) return;

    isBusy = true;
    setVerifyReady(false);

    try{
      if(mode === "create"){
        const newHash = await sha256(input + ":" + user.id);

        const { error } = await supabaseClient
          .from("user_pins")
          .insert([{ user_id: user.id, pin_hash: newHash }]);

        if(error){
          console.error(error);
          isBusy = false;
          resetInput();
          return;
        }

        showPopup("ok", "PIN Created ✔️", "Redirecting you to your dashboard...");
        setTimeout(()=> window.location.href = "/user-dashboard.html", 650);

      } else {
        const attemptHash = await sha256(input + ":" + user.id);

        if(attemptHash !== pinHashFromDb){
          // ❌ incorrect pin popup
          showPopup("err", "Incorrect PIN ❌", "Please try again.");
          setTimeout(()=>{
            hidePopup();
            isBusy = false;
            resetInput();
          }, 900);
          return;
        }

        // ✅ correct
        showPopup("ok", "Verified ✔️", "Redirecting you to your dashboard...");
        setTimeout(()=> window.location.href = "/user-dashboard.html", 520);
      }
    }catch(err){
      console.error(err);
      isBusy = false;
      resetInput();
    }
  });

  logoutBtn.addEventListener("click", async ()=>{
    try{
      if(supabaseClient) await supabaseClient.auth.signOut();
    }catch(e){}
    window.location.href = "/login.html";
  });

  init();
</script>

</body>
</html>
