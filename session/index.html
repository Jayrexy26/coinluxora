<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Secure Authentication | Coinluxora</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#050a18;
      --card:#0b1226;
      --stroke:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.65);
      --danger:#ef4444;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(1200px 800px at 50% 20%, rgba(139,211,255,.10), transparent 55%) , var(--bg);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      padding:24px;
    }

    .card{
      width:min(520px, 100%);
      background:rgba(11,18,38,.86);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:22px 22px 18px;
      box-shadow:0 16px 50px rgba(0,0,0,.45);
      position:relative;
      overflow:hidden;
      isolation:isolate;
    }

    .card:before{
      content:"";
      position:absolute;
      inset:-120px -160px auto -160px;
      height:260px;
      background:radial-gradient(circle at 50% 40%, rgba(139,211,255,.18), transparent 60%);
      pointer-events:none;
      z-index:0;
    }

    .layer{ position:relative; z-index:2; }

    .top{
      display:flex;
      align-items:center;
      gap:14px;
    }

    .avatar{
      width:54px;
      height:54px;
      border-radius:50%;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
      flex:0 0 auto;
    }

    /* ✅ Profile image */
    .avatar img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      display:none;
    }

    /* default icon */
    .avatar svg{ width:34px; height:34px; opacity:.9; }

    .who{ display:flex; flex-direction:column; gap:2px; }
    .name{ font-weight:700; letter-spacing:.2px; }
    .email{ font-size:.92rem; color:var(--muted); }

    .divider{
      height:1px;
      background:var(--stroke);
      margin:18px 0 16px;
    }

    h1{
      margin:0;
      font-size:1.75rem;
      letter-spacing:.2px;
    }
    .sub{
      margin:8px 0 0;
      color:var(--muted);
      font-size:1.02rem;
    }

    /* Rounded PIN boxes */
    .pinBoxes{
      margin:18px 0 18px;
      display:flex;
      justify-content:center;
      gap:14px;
    }
    .pinBox{
      width:56px;
      height:56px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 12px 35px rgba(0,0,0,.25);
    }
    .pinDot{
      width:14px;
      height:14px;
      border-radius:999px;
      background:transparent;
      border:1px solid rgba(255,255,255,.30);
      transition:.12s ease;
    }
    .pinBox.filled .pinDot{
      background:rgba(255,255,255,.92);
      border-color:rgba(255,255,255,.92);
      transform:scale(1.06);
    }

    .pad{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:14px;
      max-width:320px;
      margin:0 auto 18px;
      position:relative;
      z-index:5;
    }

    .key{
      height:64px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.90);
      color:#0a0f1f;
      font-weight:800;
      font-size:1.25rem;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .key:active{ transform:scale(.98); }

    .key.ghost{
      background:transparent;
      color:rgba(255,255,255,.75);
    }

    .btn{
      width:100%;
      height:52px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.10);
      color:rgba(234,240,255,.55);
      font-weight:800;
      letter-spacing:.6px;
      cursor:not-allowed;
    }
    .btn.ready{
      background:rgba(255,255,255,.16);
      color:var(--text);
      cursor:pointer;
    }

    .hint{
      text-align:center;
      margin:12px 0 0;
      color:rgba(234,240,255,.60);
      font-size:.95rem;
      min-height:20px;
    }

    .smallActions{
      display:flex;
      justify-content:center;
      gap:12px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .linkBtn{
      background:transparent;
      border:none;
      color:rgba(139,211,255,.90);
      cursor:pointer;
      font-weight:700;
      font-size:.95rem;
    }

    .danger{ color:var(--danger) !important; }
  </style>
</head>

<body>

  <div class="card">
    <div class="layer">

      <div class="top">
        <div class="avatar" id="avatarBox">
          <!-- ✅ image will show only if user has a photo -->
          <img id="avatarImg" alt="Profile"/>

          <!-- default icon -->
          <svg id="avatarIcon" viewBox="0 0 24 24" fill="none">
            <path d="M12 12c2.76 0 5-2.24 5-5S14.76 2 12 2 7 4.24 7 7s2.24 5 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z" fill="currentColor" opacity=".85"/>
          </svg>
        </div>

        <div class="who">
          <div class="name" id="userName">Loading...</div>
          <div class="email" id="userEmail"></div>
        </div>
      </div>

      <div class="divider"></div>

      <h1>Secure Authentication</h1>
      <div class="sub" id="subText">Please verify your 4-digit PIN code</div>

      <div class="pinBoxes">
        <div class="pinBox"><div class="pinDot"></div></div>
        <div class="pinBox"><div class="pinDot"></div></div>
        <div class="pinBox"><div class="pinDot"></div></div>
        <div class="pinBox"><div class="pinDot"></div></div>
      </div>

      <div class="pad" id="pad">
        <button type="button" class="key" data-num="7">7</button>
        <button type="button" class="key" data-num="0">0</button>
        <button type="button" class="key" data-num="1">1</button>

        <button type="button" class="key" data-num="2">2</button>
        <button type="button" class="key" data-num="3">3</button>
        <button type="button" class="key" data-num="8">8</button>

        <button type="button" class="key" data-num="4">4</button>
        <button type="button" class="key" data-num="5">5</button>
        <button type="button" class="key" data-num="6">6</button>

        <button type="button" class="key" data-num="9">9</button>
        <button type="button" class="key ghost" data-action="backspace">⌫</button>
        <button type="button" class="key ghost" data-action="clear">Clear</button>
      </div>

      <div>
        <button type="button" class="btn" id="verifyBtn" disabled>VERIFY</button>
        <div class="hint" id="hint"></div>
      </div>

      <div class="smallActions">
        <button type="button" class="linkBtn" id="logoutBtn">Log out</button>
      </div>

    </div>
  </div>

<script>
  // ---------------------------
  // UI + keypad ALWAYS attach first ✅
  // ---------------------------
  const pad = document.getElementById("pad");
  const verifyBtn = document.getElementById("verifyBtn");
  const hint = document.getElementById("hint");
  const subText = document.getElementById("subText");
  const userName = document.getElementById("userName");
  const userEmail = document.getElementById("userEmail");
  const logoutBtn = document.getElementById("logoutBtn");
  const pinBoxes = Array.from(document.querySelectorAll(".pinBox"));

  // ✅ avatar refs
  const avatarImg = document.getElementById("avatarImg");
  const avatarIcon = document.getElementById("avatarIcon");

  let input = "";
  let mode = "verify";
  let pinHashFromDb = null;
  let user = null;
  let supabaseClient = null;

  function setHint(msg, danger=false){
    hint.textContent = msg || "";
    hint.classList.toggle("danger", !!danger);
  }

  function setVerifyReady(ready){
    verifyBtn.disabled = !ready;
    verifyBtn.classList.toggle("ready", !!ready);
  }

  function renderPinBoxes(){
    pinBoxes.forEach((box, i)=>{
      box.classList.toggle("filled", i < input.length);
    });
    setVerifyReady(input.length === 4);
  }

  function resetInput(){
    input = "";
    renderPinBoxes();
  }

  function addDigit(n){
    if(input.length >= 4) return;
    input += String(n);
    renderPinBoxes();
    if(input.length === 4){
      setTimeout(()=> verifyBtn.click(), 120);
    }
  }

  pad.addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;

    const num = btn.getAttribute("data-num");
    const action = btn.getAttribute("data-action");

    if(num !== null){
      addDigit(num);
      return;
    }

    if(action === "backspace"){
      input = input.slice(0, -1);
      renderPinBoxes();
      return;
    }

    if(action === "clear"){
      resetInput();
      setHint("");
      return;
    }
  });

  // ---------------------------
  // Supabase logic AFTER UI ✅
  // ---------------------------
  const SUPABASE_URL = "https://xdcscknfomlzwysczegc.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";

  async function sha256(str){
    const data = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
  }

  // ✅ set avatar photo if exists
  function applyAvatarPhoto(u){
    const meta = u?.user_metadata || {};
    const photo =
      meta.avatar_url ||
      meta.picture ||
      meta.photoURL ||
      meta.profile_photo ||
      "";

    if(photo){
      avatarImg.src = photo;
      avatarImg.style.display = "block";
      avatarIcon.style.display = "none";

      // fallback if image fails
      avatarImg.onerror = () => {
        avatarImg.style.display = "none";
        avatarIcon.style.display = "block";
      };
    }
  }

  async function init(){
    try{
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ✅ avoid redirect loop: delay + getSession
      await new Promise(r => setTimeout(r, 150));
      const { data: sessData } = await supabaseClient.auth.getSession();
      const session = sessData?.session;

      if(!session?.user){
        window.location.href = "/login.html";
        return;
      }

      user = session.user;

      // ✅ Apply user name/email/photo
      userEmail.textContent = user.email || "";
      userName.textContent = (user.user_metadata?.full_name || user.user_metadata?.name || "User");
      applyAvatarPhoto(user);

      const { data, error } = await supabaseClient
        .from("user_pins")
        .select("pin_hash")
        .eq("user_id", user.id)
        .maybeSingle();

      if(error){
        setHint("PIN system error: " + (error.message || "Unknown error"), true);
        console.error(error);
        return;
      }

      if(!data){
        mode = "create";
        pinHashFromDb = null;
        subText.textContent = "Create your new 4-digit PIN";
        setHint("Create a PIN you'll remember.");
      } else {
        mode = "verify";
        pinHashFromDb = data.pin_hash;
        subText.textContent = "Please verify your 4-digit PIN code";
        setHint("");
      }

      resetInput();
    }catch(err){
      console.error(err);
      setHint("Page error: unable to load PIN system.", true);
    }
  }

  verifyBtn.addEventListener("click", async ()=>{
    if(input.length !== 4) return;

    if(!supabaseClient || !user){
      setHint("PIN system not ready. Refresh the page.", true);
      return;
    }

    verifyBtn.disabled = true;
    verifyBtn.classList.remove("ready");

    try{
      if(mode === "create"){
        const newHash = await sha256(input + ":" + user.id);

        const { error } = await supabaseClient
          .from("user_pins")
          .insert([{ user_id: user.id, pin_hash: newHash }]);

        if(error){
          setHint("Unable to create PIN: " + (error.message || "error"), true);
          console.error(error);
          resetInput();
          return;
        }

        setHint("PIN created successfully ✅");
        setTimeout(()=> window.location.href = "/user-dashboard.html", 450);

      } else {
        const attemptHash = await sha256(input + ":" + user.id);

        if(attemptHash !== pinHashFromDb){
          setHint("Incorrect PIN. Try again.", true);
          resetInput();
          return;
        }

        setHint("Verified ✅");
        setTimeout(()=> window.location.href = "/user-dashboard.html", 280);
      }
    }catch(err){
      console.error(err);
      setHint("Something went wrong. Try again.", true);
      resetInput();
    }
  });

  logoutBtn.addEventListener("click", async ()=>{
    try{
      if(supabaseClient) await supabaseClient.auth.signOut();
    }catch(e){}
    window.location.href = "/login.html";
  });

  init();
</script>

</body>
</html>
