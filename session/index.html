<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Secure Authentication | Coinluxora</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#050a18;
      --card:#0b1226;
      --stroke:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.65);
      --accent:#8bd3ff;
      --btn:#1a2b52;
      --danger:#ef4444;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(1200px 800px at 50% 20%, rgba(139,211,255,.10), transparent 55%) , var(--bg);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      padding:24px;
    }

    .card{
      width:min(520px, 100%);
      background:rgba(11,18,38,.86);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:22px 22px 18px;
      box-shadow:0 16px 50px rgba(0,0,0,.45);
      position:relative;
      overflow:hidden;
    }

    .card:before{
      content:"";
      position:absolute;
      inset:-100px -140px auto -140px;
      height:220px;
      background:radial-gradient(circle at 50% 40%, rgba(139,211,255,.18), transparent 60%);
      pointer-events:none;
    }

    .top{
      display:flex;
      align-items:center;
      gap:14px;
      position:relative;
      z-index:1;
    }

    .avatar{
      width:54px;
      height:54px;
      border-radius:50%;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .avatar svg{ width:34px; height:34px; opacity:.9; }

    .who{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .name{ font-weight:700; letter-spacing:.2px; }
    .email{ font-size:.92rem; color:var(--muted); }

    .divider{
      height:1px;
      background:var(--stroke);
      margin:18px 0 16px;
    }

    h1{
      margin:0;
      font-size:1.75rem;
      letter-spacing:.2px;
      position:relative;
      z-index:1;
    }
    .sub{
      margin:8px 0 0;
      color:var(--muted);
      font-size:1.02rem;
      position:relative;
      z-index:1;
    }

    .dots{
      margin:18px 0 18px;
      display:flex;
      gap:12px;
      justify-content:center;
      position:relative;
      z-index:1;
    }
    .dot{
      width:12px;
      height:12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.20);
      background:rgba(255,255,255,.05);
    }
    .dot.filled{
      background:rgba(255,255,255,.85);
      border-color:rgba(255,255,255,.85);
    }

    .pad{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:14px;
      max-width:320px;
      margin:0 auto 18px;
      position:relative;
      z-index:1;
    }
    .key{
      height:64px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.90);
      color:#0a0f1f;
      font-weight:800;
      font-size:1.25rem;
      cursor:pointer;
      transition:transform .06s ease, opacity .2s ease;
      user-select:none;
    }
    .key:active{ transform:scale(.98); }
    .key.ghost{
      background:transparent;
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.75);
    }

    .verifyWrap{
      margin-top:8px;
      position:relative;
      z-index:1;
    }
    .btn{
      width:100%;
      height:52px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.10);
      color:rgba(234,240,255,.55);
      font-weight:800;
      letter-spacing:.6px;
      cursor:not-allowed;
    }
    .btn.ready{
      background:rgba(255,255,255,.16);
      color:var(--text);
      cursor:pointer;
    }

    .hint{
      text-align:center;
      margin:12px 0 0;
      color:rgba(234,240,255,.60);
      font-size:.95rem;
      min-height:20px;
    }

    .smallActions{
      display:flex;
      justify-content:center;
      gap:12px;
      margin-top:10px;
      position:relative;
      z-index:1;
      flex-wrap:wrap;
    }
    .linkBtn{
      background:transparent;
      border:none;
      color:rgba(139,211,255,.90);
      cursor:pointer;
      font-weight:700;
      font-size:.95rem;
    }
    .linkBtn:hover{ text-decoration:underline; }

    .danger{ color:var(--danger) !important; }

    .footerSpace{
      height:4px;
    }
  </style>
</head>

<body>

  <div class="card">
    <div class="top">
      <div class="avatar" id="avatarBox">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 12c2.76 0 5-2.24 5-5S14.76 2 12 2 7 4.24 7 7s2.24 5 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z" fill="currentColor" opacity=".85"/>
        </svg>
      </div>
      <div class="who">
        <div class="name" id="userName">Loading...</div>
        <div class="email" id="userEmail"> </div>
      </div>
    </div>

    <div class="divider"></div>

    <h1 id="titleText">Secure Authentication</h1>
    <div class="sub" id="subText">Please verify your 4-digit PIN code</div>

    <div class="dots" id="dots"></div>

    <div class="pad" id="pad">
      <button class="key" data-num="7">7</button>
      <button class="key" data-num="0">0</button>
      <button class="key" data-num="1">1</button>

      <button class="key" data-num="2">2</button>
      <button class="key" data-num="3">3</button>
      <button class="key" data-num="8">8</button>

      <button class="key" data-num="4">4</button>
      <button class="key" data-num="5">5</button>
      <button class="key" data-num="6">6</button>

      <button class="key" data-num="9">9</button>
      <button class="key ghost" id="backspace">⌫</button>
      <button class="key ghost" id="clear">Clear</button>
    </div>

    <div class="verifyWrap">
      <button class="btn" id="verifyBtn" disabled>VERIFY</button>
      <div class="hint" id="hint"></div>
    </div>

    <div class="smallActions">
      <button class="linkBtn" id="logoutBtn">Log out</button>
    </div>
    <div class="footerSpace"></div>
  </div>

<script>
  // ---------------------------
  // Supabase setup
  // ---------------------------
  const SUPABASE_URL = "https://xdcscknfomlzwysczegc.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY4NzE2MjUsImV4cCI6MjA1MjQ0NzYyNX0.RGOC9l-xiYk8gwQpC_XoB9XJrTz8g5og35s5t7XUL5o";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ---------------------------
  // State
  // ---------------------------
  let mode = "verify"; // "create" | "verify"
  let input = "";
  let pinHashFromDb = null;
  let user = null;

  // ---------------------------
  // UI refs
  // ---------------------------
  const titleText = document.getElementById("titleText");
  const subText = document.getElementById("subText");
  const dotsBox = document.getElementById("dots");
  const hint = document.getElementById("hint");
  const verifyBtn = document.getElementById("verifyBtn");
  const userName = document.getElementById("userName");
  const userEmail = document.getElementById("userEmail");
  const logoutBtn = document.getElementById("logoutBtn");

  function renderDots(){
    dotsBox.innerHTML = "";
    for(let i=0;i<4;i++){
      const d = document.createElement("div");
      d.className = "dot" + (i < input.length ? " filled" : "");
      dotsBox.appendChild(d);
    }
  }

  function setHint(msg, isDanger=false){
    hint.textContent = msg || "";
    hint.classList.toggle("danger", !!isDanger);
  }

  function setVerifyReady(ready){
    verifyBtn.disabled = !ready;
    verifyBtn.classList.toggle("ready", !!ready);
  }

  function resetInput(){
    input = "";
    renderDots();
    setVerifyReady(false);
  }

  // ---------------------------
  // SHA-256 hash helper
  // ---------------------------
  async function sha256(str){
    const data = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  // ---------------------------
  // Load user + decide mode
  // ---------------------------
  async function init(){
    // Must be logged in to use this page
    const { data: { user: u } } = await supabase.auth.getUser();
    if(!u){
      window.location.href = "/login.html"; // change if your login page path differs
      return;
    }
    user = u;

    // basic name/email
    userEmail.textContent = user.email || "";
    userName.textContent = (user.user_metadata?.full_name || user.user_metadata?.name || "User");

    // fetch PIN record
    const { data, error } = await supabase
      .from("user_pins")
      .select("pin_hash")
      .eq("user_id", user.id)
      .maybeSingle();

    if(error){
      // if table missing or policy issue
      setHint("PIN system not ready. Please try again.", true);
      console.error(error);
      return;
    }

    if(!data){
      // No pin yet → create mode
      mode = "create";
      pinHashFromDb = null;
      titleText.textContent = "Secure Authentication";
      subText.textContent = "Create your new 4-digit PIN";
      setHint("Create a PIN you'll remember.");
    } else {
      mode = "verify";
      pinHashFromDb = data.pin_hash;
      titleText.textContent = "Secure Authentication";
      subText.textContent = "Please verify your 4-digit PIN code";
      setHint("");
    }

    renderDots();
    resetInput();
  }

  // ---------------------------
  // keypad interactions
  // ---------------------------
  document.querySelectorAll(".key[data-num]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      if(input.length >= 4) return;
      input += btn.dataset.num;
      renderDots();

      if(input.length === 4){
        setVerifyReady(true);

        // For quick UX: auto verify after 4 digits
        setTimeout(()=> verifyBtn.click(), 120);
      } else {
        setVerifyReady(false);
      }
    });
  });

  document.getElementById("backspace").addEventListener("click", ()=>{
    if(input.length === 0) return;
    input = input.slice(0, -1);
    renderDots();
    setVerifyReady(input.length === 4);
  });

  document.getElementById("clear").addEventListener("click", ()=>{
    resetInput();
    setHint("");
  });

  // ---------------------------
  // Verify/Create logic
  // ---------------------------
  verifyBtn.addEventListener("click", async ()=>{
    if(input.length !== 4) return;

    verifyBtn.disabled = true;
    verifyBtn.classList.remove("ready");

    try{
      if(mode === "create"){
        // Save new pin hash
        const newHash = await sha256(input + ":" + user.id);

        const { error } = await supabase
          .from("user_pins")
          .insert([{ user_id: user.id, pin_hash: newHash }]);

        if(error){
          setHint("Unable to create PIN. Try again.", true);
          console.error(error);
          resetInput();
          return;
        }

        setHint("PIN created successfully ✅");
        // After creating, send user to dashboard
        setTimeout(()=>{
          window.location.href = "/dashboard.html"; // CHANGE to your dashboard path
        }, 450);

      } else {
        // Verify existing pin
        const attemptHash = await sha256(input + ":" + user.id);

        if(attemptHash !== pinHashFromDb){
          setHint("Incorrect PIN. Try again.", true);
          resetInput();
          return;
        }

        setHint("Verified ✅");
        setTimeout(()=>{
          window.location.href = "/dashboard.html"; // CHANGE to your dashboard path
        }, 280);
      }
    }catch(err){
      console.error(err);
      setHint("Something went wrong. Try again.", true);
      resetInput();
    }
  });

  // ---------------------------
  // logout
  // ---------------------------
  logoutBtn.addEventListener("click", async ()=>{
    await supabase.auth.signOut();
    window.location.href = "/login.html";
  });

  // run
  init();
</script>

</body>
</html>
