<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Deposits - Coinluxora</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#050a18;
  --card:rgba(255,255,255,.06);
  --card2:rgba(255,255,255,.04);
  --border:rgba(255,255,255,.12);
  --text:#eaf0ff;
  --muted:rgba(234,240,255,.65);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:
    radial-gradient(900px 420px at 10% 0%, rgba(83,113,255,.22), transparent 55%),
    radial-gradient(900px 420px at 90% 0%, rgba(52,211,153,.18), transparent 55%),
    var(--bg);
  color:var(--text);
  padding:16px;
  padding-bottom:34px;
}

.topBar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 16px;
  border:1px solid var(--border);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  border-radius:18px;
  box-shadow:0 20px 80px rgba(0,0,0,.55);
  backdrop-filter: blur(10px);
  margin-bottom:14px;
}
.topBar .title{font-weight:1000;letter-spacing:.2px}
.topBar .email{font-weight:900;color:rgba(255,255,255,.8);font-size:13px;max-width:55%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

.container{max-width:860px;margin:0 auto}

/* ✅ STATS */
.statsGrid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
  margin-bottom:14px;
}
@media(min-width:720px){
  .statsGrid{grid-template-columns:repeat(4,1fr)}
}

/* base stat card */
.statCard{
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  padding:14px;
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  box-shadow:0 20px 80px rgba(0,0,0,.50);
  backdrop-filter: blur(10px);
  position:relative;
  overflow:hidden;
}

/* ✅ NEW: colored stat variants */
.statCard.approved{
  border-color: rgba(34,197,94,.30);
  background:
    radial-gradient(700px 220px at 20% 0%, rgba(34,197,94,.22), transparent 55%),
    linear-gradient(180deg, rgba(34,197,94,.16), rgba(0,0,0,.18));
}

.statCard.pending{
  border-color: rgba(158,104,22,.38);
  background:
    radial-gradient(700px 220px at 20% 0%, rgba(158,104,22,.25), transparent 55%),
    linear-gradient(180deg, rgba(158,104,22,.17), rgba(0,0,0,.20));
}

.statCard.rejected{
  border-color: rgba(120,49,34,.42);
  background:
    radial-gradient(700px 220px at 20% 0%, rgba(120,49,34,.25), transparent 55%),
    linear-gradient(180deg, rgba(120,49,34,.18), rgba(0,0,0,.22));
}

.statLabel{color:rgba(255,255,255,.75);font-size:12px;font-weight:1000}
.statValue{margin-top:8px;font-size:22px;font-weight:1000;letter-spacing:.2px}
.statHint{margin-top:6px;color:rgba(255,255,255,.52);font-size:12px}

/* Sections */
.section{
  border:1px solid var(--border);
  border-radius:22px;
  background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
  box-shadow:0 26px 90px rgba(0,0,0,.55);
  backdrop-filter: blur(12px);
  padding:18px;
  margin-bottom:14px;
}
.section h2{margin:0;font-size:26px;font-weight:1000}
.small{color:var(--muted);font-size:13px;margin-top:8px}
.grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}

label{display:block;font-weight:900;margin-top:6px;margin-bottom:8px;color:rgba(255,255,255,.85)}
input,select{
  width:100%;
  padding:16px 14px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.32);
  color:var(--text);
  outline:none;
  font-size:15px;
}
input::placeholder{color:rgba(255,255,255,.35)}
input:focus,select:focus{border-color:rgba(99,102,241,.55);box-shadow:0 0 0 4px rgba(99,102,241,.18)}

.gradBtn{
  width:100%;
  padding:16px 14px;
  border:none;
  border-radius:16px;
  cursor:pointer;
  font-weight:1000;
  font-size:16px;
  color:white;
  background:linear-gradient(90deg, #5b6cff, #34d399);
  box-shadow:0 18px 60px rgba(0,0,0,.50);
}
.gradBtn:active{transform:translateY(1px)}
.btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{
  padding:12px 14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.25);
  color:white;
  font-weight:1000;
  cursor:pointer;
}
.btn:hover{background:rgba(255,255,255,.08)}
.rightBtn{margin-left:auto}

.copyBox{
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  background:rgba(0,0,0,.22);
  padding:14px;
}
.addr{font-weight:1000;margin-top:8px;word-break:break-all;font-size:14px}

/* ✅ Copy button green effect */
.copyGreen{
  background: linear-gradient(90deg, rgba(34,197,94,1), rgba(16,185,129,1)) !important;
  border-color: rgba(34,197,94,.60) !important;
  box-shadow: 0 14px 40px rgba(34,197,94,.18) !important;
}

/* Chips */
.tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
.chip{
  padding:9px 14px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.25);
  font-weight:1000;cursor:pointer;font-size:13px
}
.chip.active{background:rgba(99,102,241,.25);border-color:rgba(99,102,241,.55)}

/* Table */
.tableWrap{
  margin-top:16px;overflow:auto;
  border-radius:18px;border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
}
table{width:100%;border-collapse:collapse;min-width:620px}
th,td{
  padding:14px 12px;text-align:left;
  border-bottom:1px solid rgba(255,255,255,.10);
  font-size:14px;
}
th{color:rgba(255,255,255,.65);font-weight:1000;font-size:13px}

.pill{
  display:inline-block;padding:7px 12px;border-radius:999px;
  font-weight:1000;font-size:12px;border:1px solid rgba(255,255,255,.12)
}
.pPending{background:rgba(250,204,21,.16);border-color:rgba(250,204,21,.38);color:#facc15}
.pApproved{background:rgba(34,197,94,.16);border-color:rgba(34,197,94,.38);color:#22c55e}
.pRejected{background:rgba(248,113,113,.14);border-color:rgba(248,113,113,.35);color:#f87171}

.actionBtn{
  padding:10px 12px;border-radius:14px;font-weight:1000;cursor:pointer;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.14);
  color:white;
}
.actionBtn:hover{background:rgba(255,255,255,.10)}

/* Modal */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.75);
  display:none;align-items:center;justify-content:center;z-index:9999;
}
.modalBox{
  width:95%;max-width:560px;border-radius:22px;
  border:1px solid rgba(255,255,255,.16);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  box-shadow:0 26px 90px rgba(0,0,0,.65);
  backdrop-filter: blur(12px);
  padding:18px;
}
.modalTitle{margin:0 0 12px 0;font-size:20px;font-weight:1000}
.modalRow{margin-bottom:10px;font-size:14px}
.modalRow span{opacity:.65}
.closeBtn{
  width:100%;margin-top:10px;padding:14px;border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.28);
  color:white;font-weight:1000;cursor:pointer;
}
.pdfBtn{
  width:100%;margin-top:10px;padding:14px;border-radius:16px;border:none;
  background:linear-gradient(90deg, #5b6cff, #34d399);
  color:white;font-weight:1000;cursor:pointer;
}

.ok{color:#34d399;font-weight:1000}
.err{color:#f87171;font-weight:1000}
</style>
</head>

<body>

<div class="container">

  <div class="topBar">
    <div class="title">Deposits</div>
    <div class="email" id="topEmail">Loading…</div>
  </div>

  <!-- ✅ Stats -->
  <div class="statsGrid">
    <div class="statCard">
      <div class="statLabel">Total Deposits</div>
      <div class="statValue" id="statTotal">0</div>
      <div class="statHint">All confirmations</div>
    </div>

    <div class="statCard pending">
      <div class="statLabel">Pending</div>
      <div class="statValue" id="statPending">0</div>
      <div class="statHint">Awaiting verification</div>
    </div>

    <div class="statCard approved">
      <div class="statLabel">Approved</div>
      <div class="statValue" id="statApproved">0</div>
      <div class="statHint">Verified deposits</div>
    </div>

    <div class="statCard rejected">
      <div class="statLabel">Rejected</div>
      <div class="statValue" id="statRejected">0</div>
      <div class="statHint">Declined confirmations</div>
    </div>
  </div>

  <!-- Deposit -->
  <div class="section">
    <h2>Deposit</h2>
    <div class="small">Select asset + network to view your deposit wallet address.</div>

    <div class="grid">
      <div>
        <label>Asset</label>
        <select id="depAsset" onchange="renderDepositAddress()">
          <option value="btc">BTC</option>
          <option value="eth">ETH</option>
          <option value="usdt">USDT</option>
        </select>
      </div>

      <div>
        <label>Network</label>
        <select id="depNetwork" onchange="renderDepositAddress()">
          <option value="BTC">BTC</option>
          <option value="ERC20">ERC20</option>
          <option value="TRC20">TRC20</option>
        </select>
      </div>

      <div class="copyBox">
        <div class="small">Deposit Address</div>
        <div class="addr" id="depAddress">Loading…</div>

        <div class="btnRow">
          <button class="btn" onclick="goDashboard()">← Dashboard</button>
          <button class="btn rightBtn" id="copyBtn" onclick="copyAddress()">Copy Address</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Proof -->
  <div class="section">
    <h2>Submit Deposit Proof</h2>
    <div class="small">After sending your deposit, upload proof for verification.</div>

    <div class="grid">
      <div>
        <label>Asset</label>
        <select id="confAsset">
          <option value="btc">BTC</option>
          <option value="eth">ETH</option>
          <option value="usdt">USDT</option>
        </select>
      </div>

      <div>
        <label>Network</label>
        <select id="confNetwork">
          <option value="BTC">BTC</option>
          <option value="ERC20">ERC20</option>
          <option value="TRC20">TRC20</option>
        </select>
      </div>

      <div>
        <label>Amount</label>
        <input id="confAmount" type="number" step="0.01" placeholder="Enter amount"/>
      </div>

      <div>
        <label>Transaction Hash</label>
        <input id="confTx" placeholder="Enter transaction hash"/>
      </div>

      <div>
        <label>Proof File</label>
        <input id="confProof" type="file" accept="image/*,.pdf"/>
      </div>

      <button class="gradBtn" onclick="submitDeposit()">Submit Deposit</button>
      <div id="depMsg" class="small"></div>
    </div>
  </div>

  <!-- History -->
  <div class="section">
    <h2>Deposit History</h2>

    <div class="tabs" id="tabs">
      <div class="chip active" data-status="all">All</div>
      <div class="chip" data-status="pending">Pending</div>
      <div class="chip" data-status="approved">Approved</div>
      <div class="chip" data-status="rejected">Rejected</div>

      <button class="btn rightBtn" id="refreshBtn">Refresh</button>
    </div>

    <div class="tabs" style="margin-top:12px">
      <input id="searchInput" placeholder="Search tx hash / amount / asset..." style="flex:1;min-width:200px">
      <button class="btn" id="clearSearch">Clear</button>
    </div>

    <div class="small" id="msg" style="margin-top:12px">Loading…</div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Asset</th>
            <th>Amount</th>
            <th>Network</th>
            <th>Status</th>
            <th>TX Hash</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <button class="btn" id="loadMore" style="display:none;margin-top:14px;width:100%">Load more</button>
  </div>

</div>

<!-- Modal -->
<div class="modal" id="detailsModal">
  <div class="modalBox">
    <h3 class="modalTitle">Deposit Details</h3>
    <div id="detailsBody"></div>

    <button class="pdfBtn" id="downloadPdfBtn">Download Receipt (PDF)</button>
    <button class="closeBtn" onclick="closeModal()">Close</button>
  </div>
</div>

<script>
const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";

const EDGE_SUBMIT_DEPOSIT_URL = `${SUPABASE_URL}/functions/v1/submit_deposit`;
const EDGE_CLEAR_BADGE_URL = `${SUPABASE_URL}/functions/v1/clear_badge`;

const BUCKET_NAME="proofs";
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

let currentUserEmail="";
let depositAddresses=[];
let filter="all";
let limit=8;
let offset=0;
let cache=[];
let searchTerm="";
let currentDetails=null;

function goDashboard(){ window.location.href="user-dashboard.html"; }
function setMsg(html){ document.getElementById("msg").innerHTML = html; }
function showDepMsg(html){ document.getElementById("depMsg").innerHTML = html; }

function statusPill(status){
  const s=(status||"pending").toLowerCase();
  if(s==="approved") return `<span class="pill pApproved">APPROVED</span>`;
  if(s==="rejected") return `<span class="pill pRejected">REJECTED</span>`;
  return `<span class="pill pPending">PENDING</span>`;
}

/* ✅ Update stats */
function updateStats(){
  const total = cache.length;
  const pending = cache.filter(x => (x.status||"").toLowerCase()==="pending").length;
  const approved = cache.filter(x => (x.status||"").toLowerCase()==="approved").length;
  const rejected = cache.filter(x => (x.status||"").toLowerCase()==="rejected").length;

  document.getElementById("statTotal").innerText = total;
  document.getElementById("statPending").innerText = pending;
  document.getElementById("statApproved").innerText = approved;
  document.getElementById("statRejected").innerText = rejected;
}

/* Deposit address */
async function loadDepositAddresses(){
  const { data, error } = await supabaseClient.from("deposit_addresses").select("asset,network,address");
  if(error){ document.getElementById("depAddress").innerText="Failed to load addresses"; return; }
  depositAddresses=data||[];
}
function renderDepositAddress(){
  const asset=document.getElementById("depAsset").value.toLowerCase();
  const network=document.getElementById("depNetwork").value.toUpperCase();
  const found=depositAddresses.find(d =>
    (d.asset||"").toLowerCase()===asset &&
    (d.network||"").toUpperCase()===network
  );
  document.getElementById("depAddress").innerText = found ? found.address : "No address configured";
}

/* ✅ Copy Address (no alert, green button + text change) */
let copyResetTimer = null;
async function copyAddress(){
  const addr=document.getElementById("depAddress").innerText.trim();
  const copyBtn = document.getElementById("copyBtn");

  if(!addr || addr==="Loading…" || addr==="No address configured"){
    if(copyBtn){
      const oldText = copyBtn.innerText;
      copyBtn.innerText = "No Address";
      copyBtn.classList.add("copyGreen");
      clearTimeout(copyResetTimer);
      copyResetTimer=setTimeout(()=>{
        copyBtn.innerText = oldText;
        copyBtn.classList.remove("copyGreen");
      }, 1400);
    }
    return;
  }

  try{
    await navigator.clipboard.writeText(addr);
  }catch(e){
    const temp=document.createElement("textarea");
    temp.value=addr;
    document.body.appendChild(temp);
    temp.select();
    document.execCommand("copy");
    temp.remove();
  }

  if(copyBtn){
    const oldText = copyBtn.innerText;
    copyBtn.innerText = "Copied ✔️";
    copyBtn.classList.add("copyGreen");

    clearTimeout(copyResetTimer);
    copyResetTimer=setTimeout(()=>{
      copyBtn.innerText = oldText;
      copyBtn.classList.remove("copyGreen");
    }, 2000);
  }
}

/* Clear badge */
async function clearDepositBadge(){
  try{
    const { data: sessionData } = await supabaseClient.auth.getSession();
    const accessToken = sessionData?.session?.access_token;
    if(!accessToken) return;

    await fetch(EDGE_CLEAR_BADGE_URL, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${accessToken}`,
        "apikey":SUPABASE_ANON_KEY
      },
      body: JSON.stringify({ badge_key:"deposits" })
    });
  }catch(e){ console.log(e); }
}

/* Render rows */
function renderRows(){
  const tbody=document.getElementById("rows");

  let rows=[...cache];
  if(searchTerm.trim()){
    const t=searchTerm.toLowerCase();
    rows=rows.filter(d =>
      String(d.tx_hash||"").toLowerCase().includes(t) ||
      String(d.amount||"").toLowerCase().includes(t) ||
      String(d.asset||"").toLowerCase().includes(t) ||
      String(d.network||"").toLowerCase().includes(t)
    );
  }

  if(!rows.length){
    setMsg(`<span class="err">No deposits found.</span>`);
    tbody.innerHTML="";
    return;
  }

  setMsg(`<span class="ok">Showing deposits ✅</span>`);
  tbody.innerHTML = rows.map(d=>`
    <tr>
      <td>${String(d.asset||"").toUpperCase()}</td>
      <td>${d.amount}</td>
      <td>${d.network}</td>
      <td>${statusPill(d.status)}</td>
      <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
        ${d.tx_hash || "-"}
      </td>
      <td><button class="actionBtn" onclick='openModal(${JSON.stringify(d)})'>View</button></td>
    </tr>
  `).join("");

  updateStats();
}

/* Load history */
async function loadHistory(reset=false){
  if(reset){ offset=0; cache=[]; }

  let q=supabaseClient
    .from("deposit_confirmations")
    .select("id,user_email,asset,network,amount,tx_hash,proof_url,status,created_at,admin_note")
    .eq("user_email", currentUserEmail)
    .order("created_at",{ascending:false})
    .range(offset, offset + limit - 1);

  if(filter !== "all") q=q.eq("status", filter);

  const { data, error } = await q;
  if(error){ setMsg(`<span class="err">${error.message}</span>`); return; }

  cache = cache.concat(data||[]);
  renderRows();

  document.getElementById("loadMore").style.display =
    (data && data.length===limit) ? "block" : "none";

  offset += limit;
}

/* Realtime */
function initRealtime(){
  supabaseClient
    .channel("realtime-deposits-user")
    .on("postgres_changes", {
      event:"UPDATE",
      schema:"public",
      table:"deposit_confirmations",
      filter:`user_email=eq.${currentUserEmail}`
    }, () => loadHistory(true))
    .subscribe();
}

/* Submit */
async function submitDeposit(){
  try{
    showDepMsg(`<span class="small">Submitting…</span>`);

    const asset=document.getElementById("confAsset").value;
    const network=document.getElementById("confNetwork").value;
    const amount=Number(document.getElementById("confAmount").value||0);
    const tx_hash=document.getElementById("confTx").value.trim();
    const file=document.getElementById("confProof").files[0];

    if(amount<=0 || tx_hash.length<5 || !file){
      showDepMsg(`<span class="err">Fill all fields + upload proof</span>`);
      return;
    }

    const filePath = `${currentUserEmail}/${Date.now()}-${file.name}`;
    const upload = await supabaseClient.storage.from(BUCKET_NAME).upload(filePath, file);
    if(upload.error){
      showDepMsg(`<span class="err">Upload failed: ${upload.error.message}</span>`);
      return;
    }
    const proof_url = `${BUCKET_NAME}/${filePath}`;

    const { data: sessionData } = await supabaseClient.auth.getSession();
    const accessToken = sessionData?.session?.access_token;
    if(!accessToken){
      showDepMsg(`<span class="err">Session expired. Login again.</span>`);
      return;
    }

    const res = await fetch(EDGE_SUBMIT_DEPOSIT_URL, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${accessToken}`,
        "apikey":SUPABASE_ANON_KEY
      },
      body: JSON.stringify({ asset, network, amount, tx_hash, proof_url })
    });

    const json = await res.json().catch(()=>null);
    if(!res.ok){
      showDepMsg(`<span class="err">Error: ${json?.error || JSON.stringify(json) || "Unknown"}</span>`);
      return;
    }

    showDepMsg(`<span class="ok">Deposit submitted ✅</span>`);
    document.getElementById("confAmount").value="";
    document.getElementById("confTx").value="";
    document.getElementById("confProof").value="";
    await loadHistory(true);
  }catch(e){
    showDepMsg(`<span class="err">Error: ${e?.message || String(e)}</span>`);
  }
}

/* Modal */
function openModal(dep){
  currentDetails=dep;
  const proofLink = dep.proof_url ? `${SUPABASE_URL}/storage/v1/object/public/${dep.proof_url}` : "";
  document.getElementById("detailsBody").innerHTML = `
    <div class="modalRow"><span>ID:</span> ${dep.id}</div>
    <div class="modalRow"><span>Asset:</span> ${String(dep.asset||"").toUpperCase()}</div>
    <div class="modalRow"><span>Network:</span> ${dep.network}</div>
    <div class="modalRow"><span>Amount:</span> ${dep.amount}</div>
    <div class="modalRow"><span>TX Hash:</span> ${dep.tx_hash}</div>
    <div class="modalRow"><span>Status:</span> ${statusPill(dep.status)}</div>
    <div class="modalRow"><span>Date:</span> ${new Date(dep.created_at).toLocaleString()}</div>
    ${dep.admin_note ? `<div class="modalRow"><span>Admin Note:</span> ${dep.admin_note}</div>` : ""}
    ${proofLink ? `<div class="modalRow"><span>Proof:</span> <a href="${proofLink}" target="_blank" style="color:#9bdcff;font-weight:1000">Open proof</a></div>` : ""}
  `;
  document.getElementById("detailsModal").style.display="flex";
}
function closeModal(){ document.getElementById("detailsModal").style.display="none"; }
window.openModal=openModal;
window.closeModal=closeModal;

/* PDF */
document.getElementById("downloadPdfBtn").addEventListener("click", ()=>{
  if(!currentDetails) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("Coinluxora Deposit Receipt", 14, 18);
  doc.setFontSize(11);

  const lines = [
    `Receipt ID: ${currentDetails.id}`,
    `User Email: ${currentUserEmail}`,
    `Asset: ${String(currentDetails.asset||"").toUpperCase()}`,
    `Network: ${currentDetails.network}`,
    `Amount: ${currentDetails.amount}`,
    `TX Hash: ${currentDetails.tx_hash}`,
    `Status: ${currentDetails.status}`,
    `Date: ${new Date(currentDetails.created_at).toLocaleString()}`,
    currentDetails.admin_note ? `Admin Note: ${currentDetails.admin_note}` : ""
  ].filter(Boolean);

  let y=30;
  for(const line of lines){ doc.text(String(line), 14, y); y+=8; }
  doc.text("Thank you for using Coinluxora.", 14, y+12);

  doc.save(`coinluxora-deposit-${currentDetails.id}.pdf`);
});

/* Events */
document.getElementById("tabs").onclick=(e)=>{
  const chip=e.target.closest(".chip");
  if(!chip) return;
  document.querySelectorAll(".chip").forEach(x=>x.classList.remove("active"));
  chip.classList.add("active");
  filter=chip.dataset.status;
  loadHistory(true);
};

document.getElementById("searchInput").addEventListener("input",(e)=>{
  searchTerm=e.target.value||"";
  renderRows();
});
document.getElementById("clearSearch").onclick=()=>{
  document.getElementById("searchInput").value="";
  searchTerm="";
  renderRows();
};
document.getElementById("refreshBtn").onclick=()=>loadHistory(true);
document.getElementById("loadMore").onclick=()=>loadHistory(false);

/* Init */
(async()=>{
  const { data:userData } = await supabaseClient.auth.getUser();
  if(!userData.user){
    document.body.innerHTML="<h2 style='color:white'>Login required</h2>";
    return;
  }
  currentUserEmail=userData.user.email;
  document.getElementById("topEmail").innerText=currentUserEmail;

  await clearDepositBadge();
  await loadDepositAddresses();
  renderDepositAddress();
  await loadHistory(true);
  initRealtime();
})();
</script>

</body>
</html>
