<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reset PIN | Coinluxora</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#050a18;
      --stroke:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.65);
      --ok:#22c55e;
      --err:#f87171;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(1200px 800px at 50% 20%, rgba(139,211,255,.10), transparent 55%) , var(--bg);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      padding:24px;
    }
    .card{
      width:min(520px,100%);
      background:rgba(11,18,38,.90);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:22px;
      box-shadow:0 16px 50px rgba(0,0,0,.45);
    }
    h1{margin:0;font-size:1.7rem;}
    .sub{margin:10px 0 0;color:var(--muted);font-weight:700;}
    .field{margin-top:18px;}
    .label{font-weight:1000;margin-bottom:10px;color:rgba(234,240,255,.70)}
    .input{
      width:100%;
      height:52px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      padding:0 14px;
      color:var(--text);
      font-size:16px;
      font-weight:900;
      outline:none;
    }
    .btn{
      margin-top:18px;
      width:100%;
      height:54px;
      border:none;
      border-radius:16px;
      background:linear-gradient(180deg, rgba(52,211,153,1), rgba(17,185,129,1));
      color:#062015;
      font-weight:1000;
      font-size:16px;
      cursor:pointer;
      box-shadow:0 18px 55px rgba(34,197,94,.18);
    }
    .msg{
      margin-top:14px;
      text-align:center;
      font-weight:1000;
      min-height:18px;
    }
    .ok{color:var(--ok)}
    .err{color:var(--err)}
  </style>
</head>

<body>
  <div class="card">
    <h1>Reset your PIN</h1>
    <div class="sub">Create a new 4-digit PIN code for your account.</div>

    <div class="field">
      <div class="label">New PIN</div>
      <input id="pin1" class="input" maxlength="4" inputmode="numeric" placeholder="4 digits">
    </div>

    <div class="field">
      <div class="label">Confirm PIN</div>
      <input id="pin2" class="input" maxlength="4" inputmode="numeric" placeholder="4 digits">
    </div>

    <button class="btn" onclick="saveNewPin()">Save New PIN</button>
    <div id="msg" class="msg"></div>
  </div>

<script>
  const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
  const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function setMsg(type,text){
    const el=document.getElementById("msg");
    el.className="msg " + (type||"");
    el.textContent=text;
  }

  async function sha256(str){
    const data = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
  }

  async function saveNewPin(){
    const p1=document.getElementById("pin1").value.trim();
    const p2=document.getElementById("pin2").value.trim();

    if(p1.length!==4 || p2.length!==4){
      setMsg("err","PIN must be 4 digits.");
      return;
    }
    if(p1!==p2){
      setMsg("err","PINs do not match.");
      return;
    }

    setMsg("", "Saving new PIN…");

    // user from session (Supabase sets session from reset link)
    const { data: uData } = await supabaseClient.auth.getUser();
    const user = uData?.user;

    if(!user){
      setMsg("err","Session expired. Please open the reset email again.");
      return;
    }

    const newHash = await sha256(p1 + ":" + user.id);

    const { error } = await supabaseClient
      .from("user_pins")
      .upsert([{ user_id:user.id, pin_hash:newHash }], { onConflict:"user_id" });

    if(error){
      setMsg("err","Error: " + error.message);
      return;
    }

    setMsg("ok","PIN reset successfully ✅ Redirecting…");
    setTimeout(()=> window.location.href="/login.html", 1200);
  }
</script>
</body>
</html>
