<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>User Profile - Coinluxora</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#050a18;
    --text:#eaf0ff;
    --muted: rgba(234,240,255,.65);
    --ok:#22c55e;
    --err:#f87171;

    --stroke: rgba(255,255,255,0.12);
    --shadow: 0 26px 90px rgba(0,0,0,.55);

    --blue:#5b6cff;
    --purple:#7c4dff;
    --green:#34d399;
  }
  *{box-sizing:border-box}

  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--text);
    min-height:100vh;
    padding-bottom:110px;
    background: var(--bg);
    overflow-x:hidden;
  }

  /* ===== FLOWING PREMIUM BACKGROUND ===== */
  .bgFlow{
    position:fixed; inset:0; z-index:-3;
    background:
      radial-gradient(900px 520px at 10% 10%, rgba(83,113,255,.28), transparent 55%),
      radial-gradient(900px 520px at 90% 20%, rgba(52,211,153,.18), transparent 55%),
      radial-gradient(900px 520px at 40% 90%, rgba(124,77,255,.20), transparent 60%),
      linear-gradient(180deg, rgba(5,10,24,1), rgba(2,6,23,1));
  }
  .blob{
    position:fixed;
    width:520px;height:520px;border-radius:999px;
    filter: blur(70px);
    opacity:.55;
    z-index:-2;
    mix-blend-mode: screen;
    will-change: transform;
  }
  .blob.b1{ background: rgba(91,108,255,.75); left:-140px; top:-140px; animation: drift1 14s ease-in-out infinite; }
  .blob.b2{ background: rgba(124,77,255,.70); right:-190px; top:10%; animation: drift2 16s ease-in-out infinite; }
  .blob.b3{ background: rgba(52,211,153,.55); left:15%; bottom:-220px; animation: drift3 18s ease-in-out infinite; }
  @keyframes drift1{0%{transform:translate(0,0) scale(1)}50%{transform:translate(220px,120px) scale(1.08)}100%{transform:translate(0,0) scale(1)}}
  @keyframes drift2{0%{transform:translate(0,0) scale(1)}50%{transform:translate(-240px,160px) scale(1.12)}100%{transform:translate(0,0) scale(1)}}
  @keyframes drift3{0%{transform:translate(0,0) scale(1)}50%{transform:translate(180px,-170px) scale(1.06)}100%{transform:translate(0,0) scale(1)}}
  .shimmer{
    position:fixed; inset:0; z-index:-1;
    opacity:.25;
    background:
      radial-gradient(600px 280px at 30% 10%, rgba(255,255,255,.08), transparent 60%),
      radial-gradient(700px 320px at 80% 60%, rgba(255,255,255,.06), transparent 60%);
    animation: shimmerMove 10s ease-in-out infinite alternate;
    pointer-events:none;
  }
  @keyframes shimmerMove{from{transform:translateY(0px)}to{transform:translateY(30px)}}

  /* ===== TOP BAR ===== */
  .topbar{
    position:sticky; top:0; z-index:20;
    padding:12px 14px;
    background:rgba(2,6,23,0.55);
    backdrop-filter: blur(14px);
    border-bottom:1px solid rgba(255,255,255,0.10);
  }
  .toprow{
    max-width:980px;margin:0 auto;
    display:flex;align-items:center;justify-content:space-between;gap:12px;
  }
  .brand{
    display:flex;align-items:center;gap:10px;
    background:linear-gradient(90deg, rgba(109,87,255,1), rgba(135,116,255,0.86));
    color:#fff;border-radius:16px;padding:12px 14px;
    font-weight:1000;letter-spacing:.6px;min-width:140px;
    border:1px solid rgba(255,255,255,.14);
    box-shadow:0 18px 50px rgba(109,87,255,.18);
    cursor:pointer;user-select:none;
  }
  .brand span{font-size:18px}
  .circleBtn{
    width:44px;height:44px;border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(0,0,0,.18);
    display:grid;place-items:center;
    box-shadow:0 16px 40px rgba(0,0,0,.35);
    cursor:pointer;
    color:rgba(234,240,255,.85);
  }
  .circleBtn:hover{background:rgba(255,255,255,.08)}
  .circleBtn svg{width:22px;height:22px}

  /* =========================================================
     ‚úÖ PREMIUM MENU (UPGRADED SIDEBAR)
     ========================================================= */
  .overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,.65);
    display:none; z-index:999;
    backdrop-filter: blur(4px);
  }
  .overlay.show{display:block;}

  .sidebar{
    position:fixed; top:0; left:-315px;
    width:292px; height:100vh;
    padding:16px;
    z-index:1000;
    transition: .28s ease;
    border-right:1px solid rgba(255,255,255,.10);
    background:
      radial-gradient(900px 420px at 15% 10%, rgba(91,108,255,.18), transparent 55%),
      radial-gradient(900px 420px at 90% 20%, rgba(52,211,153,.12), transparent 55%),
      linear-gradient(180deg, rgba(4,8,20,0.98), rgba(2,6,23,0.98));
    box-shadow:0 26px 90px rgba(0,0,0,.60);
    backdrop-filter: blur(16px);
  }
  .sidebar.open{ left:0; }

  .sideTop{
    display:flex;align-items:center;justify-content:space-between;
    gap:10px;margin-bottom:12px;
  }
  .sideBrand{
    display:flex;align-items:center;gap:10px;
    font-weight:1000;font-size:16px;letter-spacing:.9px;
    color:#fff;
    padding:10px 12px;border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background:linear-gradient(90deg, rgba(109,87,255,.85), rgba(124,77,255,.85));
    box-shadow:0 16px 50px rgba(109,87,255,.18);
    min-width:170px;
  }
  .sideBrandIcon{
    width:30px;height:30px;border-radius:12px;
    display:grid;place-items:center;
    background:rgba(255,255,255,.16);
    border:1px solid rgba(255,255,255,.20);
  }
  .closeBtn{
    background:rgba(0,0,0,.22);
    border:1px solid rgba(255,255,255,.14);
    color:rgba(234,240,255,.95);
    border-radius:14px;
    width:44px;height:44px;
    cursor:pointer;
    display:grid;place-items:center;
    font-weight:1000;
  }
  .closeBtn:hover{background:rgba(255,255,255,.08)}

  .userTag{
    padding:12px 12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    box-shadow:0 18px 55px rgba(0,0,0,.35);
    margin:10px 0 14px;
  }
  .userTag .t1{color:rgba(234,240,255,.55);font-weight:1000;font-size:12px}
  .userTag .t2{margin-top:6px;font-weight:1000}

  .menuGroupTitle{
    margin:10px 0 8px;
    font-size:12px;font-weight:1000;
    color:rgba(234,240,255,.50);
    letter-spacing:.8px;
    text-transform:uppercase;
  }

  .sideItem{
    display:flex;align-items:center;gap:12px;
    padding:12px 12px;
    border-radius:18px;
    color:rgba(234,240,255,.82);
    text-decoration:none;
    font-weight:1000;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.22);
    box-shadow:0 16px 40px rgba(0,0,0,.35);
    margin-bottom:10px;
    position:relative;
    overflow:hidden;
  }
  .sideItem:hover{background:rgba(255,255,255,.08)}
  .sideItem .i{
    width:42px;height:42px;border-radius:16px;
    display:grid;place-items:center;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    font-size:18px;
  }
  .sideItem small{display:block;color:rgba(234,240,255,.55);font-size:12px;font-weight:900;margin-top:2px}

  .activeLink{
    border:1px solid rgba(56,189,248,.55);
    background:linear-gradient(180deg, rgba(56,189,248,0.14), rgba(56,189,248,0.08));
    color:#cfefff;
  }
  .activeLink::after{
    content:"";
    position:absolute; inset:0;
    background: radial-gradient(600px 160px at 30% 20%, rgba(56,189,248,.20), transparent 60%);
    pointer-events:none;
  }

  .sideLogout{
    margin-top:10px;
    background:linear-gradient(90deg, rgba(248,113,113,1), rgba(239,68,68,1));
    color:#020617;border:none;width:100%;
    padding:14px;border-radius:18px;font-weight:1000;cursor:pointer;
    box-shadow:0 18px 55px rgba(239,68,68,.18);
  }
  .sideLogout:hover{filter:brightness(1.03)}

  /* ===== CONTENT ===== */
  .wrap{max-width:980px;margin:0 auto;padding:14px;}
  .pageTitle{font-size:30px;font-weight:1000;margin:12px 0 14px;}
  .card{
    border:1px solid rgba(255,255,255,.12);
    background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    border-radius:22px;
    box-shadow:var(--shadow);
    padding:16px;
    backdrop-filter: blur(12px);
  }

  /* ===== Avatar ===== */
  .profileHead{text-align:center;padding:14px 0 6px;}
  .avatarWrap{
    width:128px;height:128px;margin:0 auto 12px;border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.24);
    display:grid;place-items:center;
    position:relative;overflow:hidden;
    box-shadow:0 18px 55px rgba(0,0,0,.35);
  }
  .avatarEmoji{font-size:64px;opacity:.95}
  .avatarImg{width:100%;height:100%;object-fit:cover;display:none;}
  .avatarEdit{
    position:absolute;right:10px;bottom:10px;
    width:46px;height:46px;border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background:linear-gradient(180deg, rgba(91,108,255,1), rgba(124,77,255,1));
    display:grid;place-items:center;cursor:pointer;
    box-shadow:0 18px 55px rgba(91,108,255,.24);
  }
  .avatarEdit:hover{filter:brightness(1.05)}
  .avatarEdit svg{width:20px;height:20px}
  #avatarInput{display:none}

  .bigName{font-size:26px;font-weight:1000;color:rgba(234,240,255,.75);margin:0;}
  .bigEmail{margin:6px 0 0 0;color:rgba(234,240,255,.55);font-size:15px;font-weight:900;}

  .field{margin-top:16px;}
  .label{font-size:16px;font-weight:1000;color:rgba(234,240,255,.65);margin:0 0 10px;}
  .row{display:flex;gap:10px;align-items:center;}
  .input, select{
    flex:1;height:48px;border:1px solid rgba(255,255,255,.12);
    border-radius:14px;padding:10px 12px;font-size:15px;
    outline:none;background:rgba(0,0,0,.22);color:var(--text);
    box-shadow:0 16px 40px rgba(0,0,0,.35);
  }
  .input:disabled, select:disabled{background:rgba(0,0,0,.18);opacity:.9;}
  .miniBtn{
    width:48px;height:48px;border:none;border-radius:14px;
    background:linear-gradient(180deg, rgba(91,108,255,1), rgba(124,77,255,1));
    color:#fff;cursor:pointer;display:grid;place-items:center;
    box-shadow:0 18px 55px rgba(91,108,255,.22);
    border:1px solid rgba(255,255,255,.12);
    font-weight:1000;
  }

  .pwWrap{position:relative; flex:1;}
  .pwWrap .input{padding-right:52px;}
  .eyeBtn{
    position:absolute;right:10px;top:50%;transform:translateY(-50%);
    border:none;background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;width:38px;height:38px;
    cursor:pointer;display:grid;place-items:center;
    color:rgba(234,240,255,.85);
  }
  .note{margin-top:8px;color:rgba(234,240,255,.55);font-size:13px;font-weight:900;}

  .saveBtn{
    margin-top:18px;width:100%;height:56px;border:none;border-radius:16px;
    background:linear-gradient(180deg, rgba(52,211,153,1), rgba(17,185,129,1));
    color:#062015;cursor:pointer;font-weight:1000;font-size:17px;
    display:flex;align-items:center;justify-content:center;gap:10px;
    box-shadow:0 18px 55px rgba(34,197,94,.18);
  }

  .msg{margin-top:12px;min-height:18px;text-align:center;font-size:14px;font-weight:900;}
  .ok{color:var(--ok);font-weight:1000}
  .err{color:var(--err);font-weight:1000}

  .sectionTitle{font-size:24px;font-weight:1000;color:rgba(234,240,255,.70);margin:0 0 10px;}
  .blueBtn{
    margin-top:18px;width:100%;height:58px;border:none;border-radius:16px;
    background:linear-gradient(180deg, rgba(91,108,255,1), rgba(124,77,255,1));
    color:white;cursor:pointer;font-weight:1000;font-size:17px;
    display:flex;align-items:center;justify-content:center;gap:10px;
    box-shadow:0 18px 55px rgba(91,108,255,.22);
  }

  .tips{margin-top:18px;border-top:1px solid rgba(255,255,255,.10);padding-top:14px;}
  .tipsTitle{font-weight:1000;color:rgba(234,240,255,.65);font-size:16px;margin:0 0 10px;}
  ul{margin:0;padding-left:18px;color:rgba(234,240,255,.55);line-height:1.7;font-weight:900;font-size:13px}

  /* ===== Change PIN button ===== */
  .pinBtn{
    width:100%;
    height:54px;
    margin-top:12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background:linear-gradient(180deg, rgba(91,108,255,1), rgba(124,77,255,1));
    color:#fff;
    font-weight:1000;
    font-size:16px;
    cursor:pointer;
    box-shadow:0 18px 55px rgba(91,108,255,.22);
    display:flex;align-items:center;justify-content:center;gap:10px;
  }
  .pinBtn:hover{filter:brightness(1.04)}

  /* ===== PIN Modal ===== */
  .pinOverlay{
    position:fixed; inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:999999;
    background:rgba(0,0,0,.55);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }
  .pinOverlay.show{display:flex;}

  .pinModal{
    width:min(440px, 100%);
    border-radius:20px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(11,18,38,.92);
    box-shadow:0 28px 90px rgba(0,0,0,.60);
    padding:18px 16px 16px;
    position:relative;
    overflow:hidden;
  }
  .pinModal:before{
    content:"";
    position:absolute;
    inset:-140px -150px auto -150px;
    height:260px;
    background:radial-gradient(circle at 50% 45%, rgba(139,211,255,.16), transparent 62%);
    pointer-events:none;
  }

  .pinModalTop{
    position:relative; z-index:2;
    display:flex;align-items:center;justify-content:space-between;gap:12px;
  }
  .pinTitle{
    font-weight:1000;
    font-size:1.35rem;
    letter-spacing:.2px;
    color:#eaf0ff;
  }
  .pinCloseBtn{
    width:42px;height:42px;border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:rgba(234,240,255,.9);
    cursor:pointer;font-weight:1000;
  }

  .pinSub{
    position:relative; z-index:2;
    margin-top:8px;
    color:rgba(234,240,255,.70);
    font-size:.98rem;
  }

  .pinInputs{
    position:relative; z-index:2;
    margin-top:14px;
    display:grid;
    gap:12px;
  }
  .pinInput{
    width:100%;
    height:52px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(2,6,23,.38);
    color:#eaf0ff;
    padding:12px 14px;
    outline:none;
    font-size:16px;
    letter-spacing:3px;
    font-weight:1000;
  }
  .pinInput::placeholder{
    letter-spacing:0px;
    color:rgba(234,240,255,.55);
    font-weight:900;
  }
  .pinInput:focus{
    border-color:rgba(139,211,255,.35);
    box-shadow:0 0 0 4px rgba(139,211,255,.14);
  }

  .pinMsg{
    position:relative; z-index:2;
    margin-top:10px;
    min-height:18px;
    font-size:14px;
    color:rgba(234,240,255,.72);
    font-weight:900;
  }
  .pinMsg.err{ color:#f87171; }
  .pinMsg.ok{ color:#22c55e; font-weight:1000; }

  .pinBtns{
    position:relative; z-index:2;
    display:flex;
    gap:12px;
    margin-top:14px;
  }
  .pinSaveBtn{
    flex:1;height:50px;border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.16);
    color:#eaf0ff;font-weight:1000;cursor:pointer;
  }
  .pinCancelBtn{
    flex:1;height:50px;border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.06);
    color:rgba(234,240,255,.85);font-weight:1000;cursor:pointer;
  }

  /* =========================================================
     ‚úÖ ADVANCED BOTTOM NAV
     ========================================================= */
  .dock{
    position:fixed;
    left:0; right:0; bottom:14px;
    z-index:2000;
    pointer-events:none;
  }
  .dockInner{pointer-events:auto;max-width:980px;margin:0 auto;padding:0 14px;}
  .dockBar{
    height:76px;border-radius:28px;
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.14);
    box-shadow:0 20px 70px rgba(0,0,0,.45);
    backdrop-filter: blur(14px);
    display:flex;align-items:center;justify-content:space-between;
    padding:10px 12px;gap:10px;
  }
  .dockItem{
    flex:1;min-width:70px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    gap:6px;border-radius:18px;padding:10px 0;
    color:rgba(234,240,255,.55);
    font-size:12px;font-weight:1000;cursor:pointer;user-select:none;
  }
  .dockItem .ico{font-size:18px;opacity:.95}
  .dockItem:hover{background:rgba(255,255,255,.06)}
  .dockActive{color:#9bdcff;background:rgba(56,189,248,.10)}
  .dockHome{
    width:78px;height:78px;border-radius:26px;
    background:linear-gradient(180deg, rgba(109,87,255,1), rgba(91,108,255,1));
    box-shadow:0 22px 55px rgba(109,87,255,.30);
    display:grid;place-items:center;
    margin-top:-32px;
    border:1px solid rgba(255,255,255,.16);
    cursor:pointer;user-select:none;
  }
  .dockHome span{font-size:28px;color:white}
  .dockHome:hover{filter:brightness(1.05)}
</style>
</head>

<body>

<div class="bgFlow"></div>
<div class="blob b1"></div>
<div class="blob b2"></div>
<div class="blob b3"></div>
<div class="shimmer"></div>

<div id="overlay" class="overlay" onclick="closeMenu()"></div>

<!-- ‚úÖ PREMIUM SIDEBAR -->
<div id="sidebar" class="sidebar">
  <div class="sideTop">
    <div class="sideBrand">
      <div class="sideBrandIcon">‚óà</div>
      COINLUXORA
    </div>
    <button class="closeBtn" onclick="closeMenu()">‚úï</button>
  </div>

  <div class="userTag">
    <div class="t1">Logged in as</div>
    <div id="sideEmail" class="t2">---</div>
  </div>

  <div class="menuGroupTitle">Navigation</div>

  <a class="sideItem" href="user-dashboard.html">
    <div class="i">üè†</div>
    <div>
      Dashboard
      <small>Main overview</small>
    </div>
  </a>

  <a class="sideItem" href="deposits.html">
    <div class="i">üí≥</div>
    <div>
      Deposit
      <small>Fund your account</small>
    </div>
  </a>

  <a class="sideItem" href="withdraw.html">
    <div class="i">‚û°</div>
    <div>
      Withdraw
      <small>Request payout</small>
    </div>
  </a>

  <a class="sideItem" href="support.html">
    <div class="i">üßë‚Äçüíª</div>
    <div>
      Support
      <small>Contact & tickets</small>
    </div>
  </a>

  <a class="sideItem" href="plans.html">
    <div class="i">üíº</div>
    <div>
      Investment Plans
      <small>Start investing</small>
    </div>
  </a>

  <a class="sideItem activeLink" href="profile.html">
    <div class="i">üë§</div>
    <div>
      Profile / Settings
      <small>Account security</small>
    </div>
  </a>

  <button class="sideLogout" onclick="logout()">Logout</button>
</div>

<div class="topbar">
  <div class="toprow">
    <div class="brand" onclick="goDashboard()"><span>COIN</span></div>
    <button class="circleBtn" title="Menu" onclick="openMenu()">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
      </svg>
    </button>
  </div>
</div>

<div class="wrap">
  <div class="pageTitle">User Profile</div>

  <div class="card">
    <div class="profileHead">

      <div class="avatarWrap">
        <div id="avatarEmoji" class="avatarEmoji">üë§</div>
        <img id="avatarImg" class="avatarImg" alt="Avatar"/>
        <label class="avatarEdit" for="avatarInput" title="Upload photo">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-3L16.5 4a2 2 0 0 0-3 0L3 14.5V20Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        </label>
        <input id="avatarInput" type="file" accept="image/*"/>
      </div>

      <p class="bigName" id="bigName">Loading...</p>
      <p class="bigEmail" id="bigEmail">Loading...</p>
    </div>

    <div class="field">
      <div class="label">Name:</div>
      <div class="row">
        <input id="name" class="input" type="text" disabled />
        <button class="miniBtn" onclick="toggleEdit('name')">‚úé</button>
      </div>
    </div>

    <div class="field">
      <div class="label">Email:</div>
      <div class="row">
        <input id="email" class="input" type="email" disabled />
      </div>
    </div>

    <!-- ‚úÖ PIN SECTION: Removed editable pin input (security) -->
    <div class="field">
      <div class="label">PIN:</div>
      <div class="row">
        <input class="input" type="password" disabled value="****"/>
      </div>
      <div class="note">PIN is required for logins, withdrawals and security approvals.</div>

      <!-- ‚úÖ new change PIN button -->
      <button id="changePinBtn" type="button" class="pinBtn">üîê Change PIN</button>
    </div>

    <div class="field">
      <div class="label">Country:</div>
      <div class="row">
        <select id="country" class="input" disabled>
          <option value="">Select Country</option>
          <option>Nigeria</option><option>United States</option><option>United Kingdom</option><option>Canada</option>
          <option>Germany</option><option>France</option><option>South Africa</option><option>Kenya</option>
          <option>Ghana</option><option>United Arab Emirates</option><option>Saudi Arabia</option><option>India</option>
          <option>Australia</option><option>Brazil</option><option>Mexico</option><option>Japan</option><option>Singapore</option>
        </select>
        <button class="miniBtn" onclick="toggleEdit('country')">‚úé</button>
      </div>
    </div>

    <div class="field">
      <div class="label">Phone:</div>
      <div class="row">
        <input id="phone" class="input" type="tel" disabled placeholder=""/>
        <button class="miniBtn" onclick="toggleEdit('phone')">‚úé</button>
      </div>
    </div>

    <button class="saveBtn" onclick="saveProfile()">üíæ Save Profile Changes</button>
    <div id="msg" class="msg"></div>
  </div>

  <div style="height:18px"></div>

  <div class="card">
    <div class="sectionTitle">Change Password</div>

    <div class="field">
      <div class="label">New Password:</div>
      <div class="row">
        <div class="pwWrap">
          <input id="newPassword" class="input" type="password" placeholder="">
          <button class="eyeBtn" onclick="toggleEye('newPassword')">üëÅ</button>
        </div>
      </div>
      <div class="note">Password must be at least 8 characters long</div>
    </div>

    <div class="field">
      <div class="label">Confirm New Password:</div>
      <div class="row">
        <div class="pwWrap">
          <input id="confirmNewPassword" class="input" type="password" placeholder="">
          <button class="eyeBtn" onclick="toggleEye('confirmNewPassword')">üëÅ</button>
        </div>
      </div>
    </div>

    <button class="blueBtn" onclick="changePassword()">üîí Change Password</button>

    <div class="tips">
      <div class="tipsTitle">Security Tips</div>
      <ul>
        <li>Use a strong password with letters, numbers, and symbols</li>
        <li>Never share your password or PIN with anyone</li>
        <li>Change your password regularly</li>
        <li>Use different passwords for different accounts</li>
      </ul>
    </div>
  </div>
</div>

<!-- ‚úÖ Change PIN Modal -->
<div class="pinOverlay" id="pinOverlay" aria-hidden="true">
  <div class="pinModal" role="dialog" aria-modal="true" aria-label="Change PIN">
    <div class="pinModalTop">
      <div class="pinTitle">Change PIN</div>
      <button id="closePinBtn" class="pinCloseBtn" type="button" aria-label="Close">‚úï</button>
    </div>

    <div class="pinSub">Enter your old PIN then choose a new 4-digit PIN.</div>

    <div class="pinInputs">
      <input id="oldPin" class="pinInput" maxlength="4" inputmode="numeric" placeholder="Old PIN">
      <input id="newPin" class="pinInput" maxlength="4" inputmode="numeric" placeholder="New PIN">
      <input id="confirmPin" class="pinInput" maxlength="4" inputmode="numeric" placeholder="Confirm New PIN">
    </div>

    <div id="pinMsg" class="pinMsg"></div>

    <div class="pinBtns">
      <button id="savePinBtn" class="pinSaveBtn" type="button">Save</button>
      <button id="cancelPinBtn" class="pinCancelBtn" type="button">Cancel</button>
    </div>
  </div>
</div>

<!-- ‚úÖ ADVANCED BOTTOM NAV -->
<div class="dock">
  <div class="dockInner">
    <div class="dockBar">
      <div class="dockItem" onclick="goDeposit()"><div class="ico">üí≥</div><div>Deposit</div></div>
      <div class="dockItem" onclick="goWithdraw()"><div class="ico">‚û°</div><div>Withdraw</div></div>

      <div class="dockHome" onclick="goDashboard()"><span>üè†</span></div>

      <div class="dockItem" onclick="goPlans()"><div class="ico">üíº</div><div>Plans</div></div>
      <div class="dockItem dockActive" onclick="goProfile()"><div class="ico">üë§</div><div>Profile</div></div>
    </div>
  </div>
</div>

<script>
/* ============================================================
   ‚úÖ COINLUXORA AUTH GUARD (LOGIN + EMAIL VERIFIED REQUIRED)
   ============================================================ */
const SUPABASE_URL="https://xdcscknfomlzwysczegc.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkY3Nja25mb21send5c2N6ZWdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTYzMDMsImV4cCI6MjA4MzI5MjMwM30.E6o2wFFMOpK1DghLUqnxG6Ig09djy4bmDQexprhAiB4";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;

(async function authGuard(){
  try{
    const { data: sessionData } = await supabaseClient.auth.getSession();
    if(!sessionData?.session){
      window.location.replace("login.html");
      return;
    }
    const { data, error } = await supabaseClient.auth.getUser();
    const user = data?.user;
    if(error || !user){
      window.location.replace("login.html");
      return;
    }
    if(!user.email_confirmed_at){
      await supabaseClient.auth.signOut();
      window.location.replace("verify.html?status=unverified");
      return;
    }
    currentUser = user;
    document.getElementById("sideEmail").innerText = user.email;
    await loadProfile();
  }catch(e){
    window.location.replace("login.html");
  }
})();

/* MENU */
function openMenu(){
  document.getElementById("sidebar").classList.add("open");
  document.getElementById("overlay").classList.add("show");
}
function closeMenu(){
  document.getElementById("sidebar").classList.remove("open");
  document.getElementById("overlay").classList.remove("show");
}

/* NAV */
function goDashboard(){ window.location.href="user-dashboard.html"; }
function goDeposit(){ window.location.href="deposits.html"; }
function goWithdraw(){ window.location.href="withdraw.html"; }
function goPlans(){ window.location.href="plans.html"; }
function goProfile(){ window.location.href="profile.html"; }

/* helpers */
function toggleEdit(id){
  const el = document.getElementById(id);
  el.disabled = !el.disabled;
  if(!el.disabled) el.focus();
}
function toggleEye(id){
  const el = document.getElementById(id);
  el.type = (el.type === "password") ? "text" : "password";
}
function setMsg(type, text){
  const el = document.getElementById("msg");
  if(type==="ok") el.innerHTML = `<span class="ok">${text}</span>`;
  else if(type==="err") el.innerHTML = `<span class="err">${text}</span>`;
  else el.textContent = text;
}

/* Load profile */
async function loadProfile(){
  if(!currentUser) return;

  let dbRow = null;
  const { data, error } = await supabaseClient
    .from("users")
    .select("full_name, phone, country, avatar_url")
    .eq("email", currentUser.email)
    .maybeSingle();
  if(!error && data) dbRow = data;

  const md = currentUser.user_metadata || {};
  const full_name = (dbRow?.full_name || md.full_name || "User");
  const phone     = (dbRow?.phone || md.phone || "");
  const country   = (dbRow?.country || md.country || "");
  const avatarUrl = (dbRow?.avatar_url || md.avatar_url || "");

  document.getElementById("bigName").textContent = full_name;
  document.getElementById("bigEmail").textContent = currentUser.email;

  document.getElementById("name").value = full_name;
  document.getElementById("email").value = currentUser.email;
  document.getElementById("phone").value = phone;
  document.getElementById("country").value = country;

  if(avatarUrl){
    document.getElementById("avatarEmoji").style.display="none";
    const img=document.getElementById("avatarImg");
    img.src = avatarUrl + "?t=" + Date.now();
    img.style.display="block";
  }
}

/* save profile */
async function saveProfile(){
  if(!currentUser){
    setMsg("err","Session missing. Please login again.");
    return;
  }
  setMsg("", "Saving changes‚Ä¶");

  const full_name = document.getElementById("name").value.trim();
  const phone     = document.getElementById("phone").value.trim();
  const country   = document.getElementById("country").value.trim();

  if(!full_name){
    setMsg("err","Name cannot be empty.");
    return;
  }

  const { error: dbError } = await supabaseClient
    .from("users")
    .upsert([{
      email: currentUser.email,
      full_name,
      phone,
      country
    }], { onConflict: "email" });

  if(dbError){
    setMsg("err","DB save failed: " + dbError.message);
    return;
  }

  const { error: mdError } = await supabaseClient.auth.updateUser({
    data: { full_name, phone, country }
  });

  if(mdError){
    setMsg("err","Metadata save failed: " + mdError.message);
    return;
  }

  document.getElementById("bigName").textContent = full_name;
  ["name","phone","country"].forEach(id => document.getElementById(id).disabled = true);

  setMsg("ok","Profile updated successfully ‚úÖ");
}

/* change password */
async function changePassword(){
  const newPassword = document.getElementById("newPassword").value;
  const confirmNew  = document.getElementById("confirmNewPassword").value;

  if(newPassword.length < 8){
    setMsg("err","New password must be at least 8 characters.");
    return;
  }
  if(newPassword !== confirmNew){
    setMsg("err","New passwords do not match.");
    return;
  }

  const { error } = await supabaseClient.auth.updateUser({ password: newPassword });
  if(error){
    setMsg("err", error.message);
    return;
  }

  document.getElementById("newPassword").value = "";
  document.getElementById("confirmNewPassword").value = "";
  setMsg("ok","Password changed successfully ‚úÖ");
}

/* logout */
async function logout(){
  await supabaseClient.auth.signOut();
  window.location.replace("login.html");
}

/* AVATAR UPLOAD */
document.getElementById("avatarInput").addEventListener("change", async (e)=>{
  try{
    const file = e.target.files?.[0];
    if(!file || !currentUser) return;

    setMsg("", "Uploading photo‚Ä¶");

    if(!file.type.startsWith("image/")){
      setMsg("err","Please select an image file.");
      return;
    }
    if(file.size > 2 * 1024 * 1024){
      setMsg("err","Image too large (max 2MB).");
      return;
    }

    const ext = file.name.split(".").pop().toLowerCase();
    const path = `${currentUser.id}/avatar.${ext}`;

    const { error: upErr } = await supabaseClient.storage.from("avatars")
      .upload(path, file, { upsert:true, cacheControl:"3600" });

    if(upErr){
      setMsg("err","Avatar upload failed: " + upErr.message);
      return;
    }

    const { data: pub } = supabaseClient.storage.from("avatars").getPublicUrl(path);
    const avatarUrl = pub?.publicUrl;
    if(!avatarUrl){
      setMsg("err","Could not fetch avatar url.");
      return;
    }

    document.getElementById("avatarEmoji").style.display="none";
    const img=document.getElementById("avatarImg");
    img.src = avatarUrl + "?t=" + Date.now();
    img.style.display="block";

    const { error: dbError } = await supabaseClient
      .from("users")
      .upsert([{ email: currentUser.email, avatar_url: avatarUrl }], { onConflict:"email" });

    if(dbError){
      setMsg("err","DB avatar save failed: " + dbError.message);
      return;
    }

    const { error: mdError } = await supabaseClient.auth.updateUser({ data: { avatar_url: avatarUrl } });
    if(mdError){
      setMsg("err","Metadata avatar save failed: " + mdError.message);
      return;
    }

    setMsg("ok","Profile photo updated ‚úÖ");
  }catch(err){
    setMsg("err","Upload failed.");
  }
});

/* ============================================================
   ‚úÖ CHANGE PIN (SECURE - user_pins table)
   ============================================================ */
const changePinBtn = document.getElementById("changePinBtn");
const pinOverlayEl = document.getElementById("pinOverlay");
const savePinBtn = document.getElementById("savePinBtn");
const cancelPinBtn = document.getElementById("cancelPinBtn");
const closePinBtn = document.getElementById("closePinBtn");
const oldPinEl = document.getElementById("oldPin");
const newPinEl = document.getElementById("newPin");
const confirmPinEl = document.getElementById("confirmPin");
const pinMsgEl = document.getElementById("pinMsg");

function setPinMsg(text, type=""){
  pinMsgEl.textContent = text || "";
  pinMsgEl.classList.remove("err","ok");
  if(type) pinMsgEl.classList.add(type);
}

function openPinModal(){
  pinOverlayEl.classList.add("show");
  pinOverlayEl.setAttribute("aria-hidden","false");
  oldPinEl.value = "";
  newPinEl.value = "";
  confirmPinEl.value = "";
  setPinMsg("");
  setTimeout(()=> oldPinEl.focus(), 150);
}

function closePinModal(){
  pinOverlayEl.classList.remove("show");
  pinOverlayEl.setAttribute("aria-hidden","true");
}

changePinBtn.addEventListener("click", openPinModal);
cancelPinBtn.addEventListener("click", closePinModal);
closePinBtn.addEventListener("click", closePinModal);

pinOverlayEl.addEventListener("click", (e)=>{
  if(e.target === pinOverlayEl) closePinModal();
});
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape" && pinOverlayEl.classList.contains("show")) closePinModal();
});

[oldPinEl,newPinEl,confirmPinEl].forEach(el=>{
  el.addEventListener("input", ()=>{
    el.value = el.value.replace(/\D/g,"").slice(0,4);
  });
});

async function sha256(str){
  const data = new TextEncoder().encode(str);
  const hashBuffer = await crypto.subtle.digest("SHA-256", data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
}

savePinBtn.addEventListener("click", async ()=>{
  setPinMsg("Updating PIN...");

  const oldPin = oldPinEl.value.trim();
  const newPin = newPinEl.value.trim();
  const confPin = confirmPinEl.value.trim();

  if(oldPin.length !== 4 || newPin.length !== 4 || confPin.length !== 4){
    setPinMsg("PIN must be 4 digits.", "err");
    return;
  }
  if(newPin !== confPin){
    setPinMsg("New PIN does not match.", "err");
    return;
  }
  if(newPin === oldPin){
    setPinMsg("New PIN must be different.", "err");
    return;
  }

  try{
    const { data } = await supabaseClient.auth.getUser();
    const user = data?.user;
    if(!user){
      setPinMsg("Not logged in.", "err");
      return;
    }

    const { data: pinRow, error } = await supabaseClient
      .from("user_pins")
      .select("pin_hash")
      .eq("user_id", user.id)
      .maybeSingle();

    if(error || !pinRow?.pin_hash){
      setPinMsg("PIN record not found.", "err");
      console.error(error);
      return;
    }

    const oldHash = await sha256(oldPin + ":" + user.id);
    if(oldHash !== pinRow.pin_hash){
      setPinMsg("Old PIN is incorrect.", "err");
      return;
    }

    const newHash = await sha256(newPin + ":" + user.id);

    const { error: upErr } = await supabaseClient
      .from("user_pins")
      .update({ pin_hash: newHash })
      .eq("user_id", user.id);

    if(upErr){
      setPinMsg("Failed to update PIN.", "err");
      console.error(upErr);
      return;
    }

    setPinMsg("PIN updated successfully ‚úÖ", "ok");
    setTimeout(closePinModal, 650);

  }catch(err){
    console.error(err);
    setPinMsg("Something went wrong.", "err");
  }
});
</script>

</body>
</html>
